# 股價獲取系統實作任務清單

## 概述

基於 v1.0.2.0197 成功修復經驗，將股價獲取方法標準化為可重用的規範和實作。所有未來的股價獲取功能都必須遵循此標準。

---

## 實作任務

### 1. 核心服務標準化

- [ ] 1.1 創建標準化的股票代碼分析器
  - 實作智能後綴判斷邏輯（上市 .TW 優先，上櫃 .TWO 優先）
  - 支援所有股票類型：上市、上櫃、ETF、債券 ETF
  - 添加詳細的判斷日誌記錄
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ]* 1.2 編寫股票代碼分析器的屬性測試
  - **屬性 1: 後綴判斷一致性**
  - **驗證: 需求 1.1, 1.2, 1.3, 1.4**

- [ ] 1.3 創建統一的 API 管理器介面
  - 定義標準的 APIProvider 介面
  - 實作 API 優先順序和備援機制
  - 支援超時和重試邏輯
  - _需求: 2.1, 2.3, 2.4_

- [ ]* 1.4 編寫 API 備援機制的屬性測試
  - **屬性 2: API 備援完整性**
  - **驗證: 需求 2.1, 2.3, 2.4**

### 2. Yahoo Finance API 標準化

- [ ] 2.1 標準化 Yahoo Finance API 實作
  - 使用智能後綴判斷邏輯
  - 實作多後綴嘗試機制（主要 + 備用）
  - 添加詳細的嘗試日誌
  - _需求: 1.1, 1.2, 1.3, 1.4, 2.1_

- [ ] 2.2 實作 Yahoo Finance 錯誤處理
  - 區分網路錯誤、API 錯誤、資料錯誤
  - 實作適當的重試邏輯
  - 記錄詳細的錯誤資訊
  - _需求: 4.1, 4.2, 4.5_

- [ ]* 2.3 編寫 Yahoo Finance API 的單元測試
  - 測試不同股票類型的後綴選擇
  - 測試錯誤處理和重試邏輯
  - 測試超時機制
  - _需求: 1.1, 1.2, 1.3, 1.4, 4.1, 4.2_

### 3. FinMind API 標準化

- [ ] 3.1 標準化 FinMind API 實作
  - 分離股票資訊獲取和股價獲取
  - 實作中文名稱獲取邏輯
  - 支援歷史股價作為備用資料
  - _需求: 2.2, 3.3, 3.4_

- [ ] 3.2 實作 FinMind 資料驗證
  - 驗證股價資料有效性（price > 0）
  - 驗證中文名稱格式
  - 處理民國年轉西元年
  - _需求: 3.1, 3.2_

- [ ]* 3.3 編寫 FinMind API 的單元測試
  - 測試股票資訊和股價獲取
  - 測試資料驗證邏輯
  - 測試日期轉換
  - _需求: 2.2, 3.1, 3.2, 3.3, 3.4_

### 4. 混合資料來源策略

- [ ] 4.1 實作資料合併邏輯
  - Yahoo Finance 股價 + FinMind 中文名稱
  - 智能選擇最佳資料來源
  - 正確標記混合來源（Yahoo+FinMind）
  - _需求: 2.2, 2.5, 3.3_

- [ ] 4.2 實作資料完整性驗證
  - 驗證所有必填欄位存在
  - 驗證股價數值有效性
  - 驗證時間戳記格式
  - _需求: 3.1, 3.2, 3.5_

- [ ]* 4.3 編寫混合資料來源的屬性測試
  - **屬性 3: 資料完整性驗證**
  - **屬性 4: 混合資料來源一致性**
  - **驗證: 需求 2.2, 2.5, 3.1, 3.2, 3.3**

### 5. 快取和效能優化

- [ ] 5.1 實作標準化快取機制
  - 5 秒 TTL 快取策略
  - LRU 快取清理機制
  - 自動過期清理
  - _需求: 6.1, 6.5_

- [ ] 5.2 實作並發控制
  - 限制並發請求數量（最多 5 個）
  - 請求間隔控制（300ms）
  - 批量更新優化
  - _需求: 6.2, 6.3_

- [ ] 5.3 實作超時和重試機制
  - 10 秒請求超時
  - 指數退避重試
  - 熔斷器模式
  - _需求: 6.4_

- [ ]* 5.4 編寫快取機制的屬性測試
  - **屬性 7: 快取時效性**
  - **驗證: 需求 6.1, 6.5**

### 6. 前端標準化

- [ ] 6.1 標準化前端股價獲取邏輯
  - 統一 QuickAddStock 和 StockSearch 的邏輯
  - 使用與後端相同的後綴判斷
  - 實作相同的 CORS 代理備援
  - _需求: 5.1, 5.2_

- [ ] 6.2 實作前端錯誤處理
  - 統一錯誤訊息格式
  - 實作相同的重試邏輯
  - 添加用戶友好的錯誤提示
  - _需求: 4.3, 4.4, 5.4_

- [ ] 6.3 實作前端日誌記錄
  - 使用與後端相同的日誌格式
  - 記錄 API 嘗試順序和結果
  - 支援調試模式
  - _需求: 5.4_

- [ ]* 6.4 編寫前後端一致性測試
  - **屬性 6: 前後端邏輯一致性**
  - **驗證: 需求 5.1, 5.2, 5.5**

### 7. 錯誤處理標準化

- [ ] 7.1 創建標準化錯誤類型
  - InvalidSymbolError（無效股票代碼）
  - APIConnectionError（API 連線錯誤）
  - InvalidDataError（資料驗證錯誤）
  - TimeoutError（請求超時）
  - _需求: 4.1, 4.2, 4.3_

- [ ] 7.2 實作錯誤處理策略
  - 漸進式 API 降級
  - 友好的錯誤訊息
  - 詳細的錯誤日誌
  - _需求: 4.1, 4.2, 4.4, 4.5_

- [ ]* 7.3 編寫錯誤處理的屬性測試
  - **屬性 5: 錯誤處理完整性**
  - **驗證: 需求 4.1, 4.2, 4.4**

### 8. 整合測試和驗證

- [ ] 8.1 實作端到端測試套件
  - 測試所有股票類型（上市、上櫃、ETF、債券 ETF）
  - 測試 API 失敗情況
  - 測試效能和快取
  - _需求: 全部_

- [ ] 8.2 實作效能基準測試
  - 測試單一股票查詢效能
  - 測試批量更新效能
  - 測試快取命中率
  - _需求: 6.1, 6.2, 6.3, 6.4_

- [ ] 8.3 實作健康檢查機制
  - API 可用性檢查
  - 效能指標監控
  - 錯誤率統計
  - _需求: 4.5, 6.4_

### 9. 文檔和規範

- [ ] 9.1 更新 API 標準規範文件
  - 將成功經驗寫入 api-standards.md
  - 更新股價獲取優先順序規範
  - 添加後綴判斷標準
  - _需求: 全部_

- [ ] 9.2 創建開發者指南
  - 如何正確實作股價獲取
  - 常見問題和解決方案
  - 最佳實踐建議
  - _需求: 全部_

- [ ] 9.3 創建測試驗證清單
  - 新功能開發檢查清單
  - 股票類型測試案例
  - 效能驗證標準
  - _需求: 全部_

### 10. 檢查點：確保所有測試通過

- [ ] 10.1 執行完整測試套件
  - 單元測試通過率 100%
  - 屬性測試通過率 100%
  - 整合測試通過率 100%
  - 確保所有測試通過，如有問題請詢問用戶

- [ ] 10.2 驗證實際股票獲取
  - 測試 2330（上市）、6188（上櫃）、0050（ETF）、00679B（債券 ETF）
  - 驗證所有股票都能正確獲取股價
  - 確認中文名稱正確顯示
  - 確保所有測試通過，如有問題請詢問用戶

---

## 驗收標準

### 功能驗收
- [ ] 所有台灣股票類型都能正確獲取股價
- [ ] 智能後綴判斷 100% 準確
- [ ] API 備援機制正常運作
- [ ] 混合資料來源正確標記
- [ ] 錯誤處理友好且完整

### 效能驗收
- [ ] 單一股票查詢 < 2 秒
- [ ] 批量更新並發控制正常
- [ ] 快取命中率 > 80%
- [ ] API 成功率 > 95%

### 程式碼品質
- [ ] 單元測試覆蓋率 > 90%
- [ ] 屬性測試覆蓋所有核心邏輯
- [ ] 程式碼符合 ESLint 規範
- [ ] 文檔完整且準確

---

**重要**: 此任務清單基於 v1.0.2.0197 的成功修復制定，完成後將成為所有股價獲取功能的標準實作！