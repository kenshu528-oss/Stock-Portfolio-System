# Stock Portfolio System 實作計劃

## 開發現況總結（v1.0.0.0056）

### ✅ 已完成的核心功能
- **多帳戶股票管理**：完整的帳戶CRUD操作，股票新增編輯刪除
- **動態股息計算**：根據當前股數×每股股息重新計算，支援多次配息
- **即時股價查詢**：後端API服務（Yahoo Finance + 本地對照表）
- **響應式UI設計**：深色主題，手機桌面適配，覆蓋式側邊選單
- **操作選單系統**：右上角浮動卡片式設計，彩色圖示，點擊外部關閉
- **投資組合統計**：四個統計卡片，詳細統計，空狀態處理
- **隱私保護**：隱私模式切換，金額遮罩，狀態持久化
- **資料持久化**：localStorage自動儲存，版本化儲存key

### 🔧 技術架構
- **前端**：React 18 + TypeScript + Zustand + Tailwind CSS
- **後端**：Node.js + Express + Yahoo Finance API
- **資料**：localStorage + 測試資料（00878、00919配息記錄）
- **版本**：四碼版本控制（v1.0.0.0056）

### 📋 下一步重點
1. **股價更新功能**：全域批次更新按鈕
2. **股息管理介面**：完整的股息記錄管理
3. **資料匯入匯出**：JSON、CSV、Excel格式支援
4. **雲端同步**：GitHub Gist整合

---

## 詳細任務列表

- [x] 1. 專案初始化與基礎架構





  - 建立React + TypeScript專案（使用Vite）
  - 配置Tailwind CSS用於響應式設計
  - 設定狀態管理（Zustand）
  - 配置測試環境（Vitest + React Testing Library + fast-check）
  - 建立基本專案結構（components, services, types, utils）
  - _需求: 7.1, 7.3, 7.4, 7.5_

- [x] 2. 核心資料模型與型別定義
  - 定義TypeScript介面（StockRecord, Account, DividendRecord, PortfolioStats）
  - 實作資料驗證函數（validateStockRecord, validateAccount, validateDividend）
  - 建立資料生成器（用於測試）
  - _需求: 1.1, 2.2, 4.3_

- [x] 2.1 撰寫資料模型的屬性測試





  - **Property 1: 股票記錄創建完整性**
  - **驗證需求: Requirements 1.1**
-

- [x] 2.2 撰寫資料驗證的單元測試




  - 測試無效輸入的拒絕（負數持股、未來日期等）
  - 測試邊界值
  - _需求: 9.2_

- [x] 3. UI基礎元件開發（第一階段）
  - 建立App根元件與基本佈局
  - 實作Header元件（標題列）
  - 實作響應式Sidebar元件（功能選單，預設隱藏）
  - 實作Modal元件（模態框基礎）
  - 實作Button、Input等基礎UI元件
  - _需求: 7.1, 7.2, 12.1, 12.5_

- [x] 3.1 撰寫UI元件的單元測試





  - 測試元件渲染
  - 測試基本互動
  - _需求: 7.1, 7.2_

- [x] 4. 帳戶管理UI
  - 實作AccountManager元件（帳戶管理模態框）
  - 實作帳戶列表顯示（帳戶名稱、股票數量）
  - 實作新增帳戶功能UI
  - 實作重新命名帳戶功能UI（即時編輯）
  - 實作刪除帳戶功能UI（含確認對話框）
  - 實作帳戶順序調整功能（上下箭頭按鈕）
  - 整合到主應用程式（點擊+號開啟）
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 4.1 撰寫帳戶管理的屬性測試









  - **Property 6: 帳戶創建**
  - **驗證需求: Requirements 2.2**

- [x] 4.2 撰寫帳戶管理的屬性測試















  - **Property 7: 帳戶刪除保護**
  - **驗證需求: Requirements 2.3**

- [x] 4.3 撰寫帳戶管理的屬性測試



  - **Property 8: 帳戶重新命名一致性**
  - **驗證需求: Requirements 2.4**

- [x] 4.4 撰寫帳戶管理的屬性測試

















  - **Property 9: 帳戶切換正確性**
  - **驗證需求: Requirements 2.5**

- [x] 5. 股票清單UI與顯示
  - ✅ 實作StockList元件（股票清單表格）
  - ✅ 實作StockRow元件（單筆股票列）
  - ✅ 實作EditableCell元件（可編輯儲存格）
  - ✅ 顯示股票基本資訊（代碼、名稱、持股數、成本價、現價）
  - ✅ 顯示計算欄位（市值、損益金額、損益率）
  - ✅ 實作即時編輯功能（點擊持股數或成本價可編輯）
  - ✅ 實作動態股息計算（根據當前股數×每股股息重新計算）
  - ✅ 實作右上角浮動卡片式操作選單
  - ✅ 整合股價更新、購買歷史、股息記錄、刪除功能
  - ✅ 實作點擊外部關閉選單功能
  - _需求: 1.4, 5.1, 12.3_

- [x] 5.1 撰寫股票清單的屬性測試


  - **Property 4: 即時編輯功能可用性**
  - **驗證需求: Requirements 1.4**

- [x] 5.2 撰寫股票清單的屬性測試


  - **Property 17: 市值與損益計算**
  - **驗證需求: Requirements 5.1**

- [x] 6. 新增股票功能
  - 實作AddStockForm元件（深色主題新增股票表單）
  - 實作簡化股票搜尋功能（輸入代碼自動查詢）
  - 實作股票資訊顯示（綠色勾選標記+股價資訊）
  - 實作帳戶選擇下拉選單
  - 實作表單驗證（股票代碼、持股數、成本價、購買日期）
  - 實作模態框焦點管理（自動聚焦到搜尋欄位）
  - 整合到主應用程式（選單和快捷按鈕）
  - _需求: 1.1, 1.2, 1.5, 12.2_

- [x] 6.1 撰寫新增股票的屬性測試




  - **Property 1: 股票記錄創建完整性**
  - **驗證需求: Requirements 1.1**

- [x] 6.2 撰寫新增股票的屬性測試





  - **Property 2: 股票代碼自動查詢**
  - **驗證需求: Requirements 1.2**

- [x] 6.3 撰寫新增股票的屬性測試



  - **Property 5: 重複股票處理**
  - **驗證需求: Requirements 1.5**

- [x] 6.4 撰寫新增股票的屬性測試





  - **Property 47: 模態框焦點管理**
  - **驗證需求: Requirements 12.2**

- [x] 7. 刪除股票功能
  - ✅ 實作刪除按鈕UI（整合到操作選單）
  - ✅ 實作DeleteConfirmDialog刪除確認對話框
  - ✅ 顯示股票詳細資訊（代碼、名稱、持股數、成本價、現價、市值、損益）
  - ✅ 實作刪除邏輯（從狀態和localStorage移除）
  - ✅ 實作帳戶股票數量同步更新
  - _需求: 1.3_

- [x] 7.1 撰寫刪除股票的屬性測試


  - **Property 3: 刪除操作的不變性**
  - **驗證需求: Requirements 1.3**

- [x] 8. 投資組合統計顯示
  - ✅ 實作PortfolioStats元件（投資組合統計）
  - ✅ 顯示總市值、總成本、總損益、損益率
  - ✅ 顯示股息收入統計
  - ✅ 實作統計計算邏輯（支援調整成本價）
  - ✅ 實作帳戶切換時的統計更新
  - ✅ 實作空狀態顯示（無股票時的友善提示）
  - ✅ 實作詳細統計（持股檔數、總報酬、平均成本）
  - ✅ 整合隱私模式支援
  - _需求: 5.3, 5.4, 5.5_



- [ ] 8.1 撰寫投資組合統計的屬性測試
  - **Property 19: 總報酬計算**


  - **驗證需求: Requirements 5.3**



- [-] 8.2 撰寫投資組合統計的屬性測試

  - **Property 20: 帳戶統計更新**
  - **驗證需求: Requirements 5.4**

- [ ] 8.3 撰寫投資組合統計的屬性測試
  - **Property 21: 響應式績效計算**
  - **驗證需求: Requirements 5.5**

- [x] 9. 隱私保護功能


  - 實作PrivacyToggle元件（隱私切換按鈕）
  - 實作隱私模式狀態管理
  - 實作金額顯示/隱藏邏輯（星號遮罩）
  - 實作隱私提示訊息（3秒自動隱藏）
  - 實作按鈕圖示狀態同步
  - 預設啟用隱私模式
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 9.1 撰寫隱私保護的屬性測試


  - **Property 22: 隱私模式切換**
  - **驗證需求: Requirements 6.2**

- [x] 9.2 撰寫隱私保護的屬性測試


  - **Property 23: 隱私模式顯示**
  - **驗證需求: Requirements 6.3**

- [x] 9.3 撰寫隱私保護的屬性測試


  - **Property 24: 隱私提示訊息**
  - **驗證需求: Requirements 6.4**

- [ ] 10. 響應式設計實作
  - 實作手機版佈局（螢幕寬度 < 768px）
  - 實作桌面版佈局（螢幕寬度 >= 768px）
  - 實作選單展開/收合動畫
  - 實作點擊外部關閉選單
  - 實作操作完成自動關閉選單
  - 實作裝置旋轉適配
  - 實作觸控手勢支援（滑動收合選單）
  - 實作鍵盤導航（ESC關閉選單、Tab導航）
  - _需求: 7.3, 7.4, 7.5, 11.1, 11.2, 11.3, 11.4, 11.5_

- [ ] 10.1 撰寫響應式設計的屬性測試
  - **Property 26: 選單展開功能**
  - **驗證需求: Requirements 7.2**

- [ ] 10.2 撰寫響應式設計的屬性測試
  - **Property 28: 響應式斷點**
  - **驗證需求: Requirements 7.5**

- [ ] 10.3 撰寫UI互動的屬性測試
  - **Property 41: 點擊外部關閉選單**
  - **驗證需求: Requirements 11.1**

- [ ] 10.4 撰寫UI互動的屬性測試
  - **Property 45: 鍵盤導航**
  - **驗證需求: Requirements 11.5**

- [ ] 11. Checkpoint - 確保所有測試通過
  - 確保所有測試通過，如有問題請詢問使用者

- [x] 12. 股價API服務實作
  - ✅ 建立後端API服務（Node.js + Express，端口3001）
  - ✅ 實作Yahoo Finance API整合（主要資料來源）
  - ✅ 實作本地股票對照表（備用資料來源）
  - ✅ 實作API容錯機制（Yahoo Finance失敗時使用本地對照表）
  - ✅ 實作股票資料快取機制（1分鐘快取，自動清理）
  - ✅ 支援台灣上市上櫃股票和ETF查詢
  - ✅ 實作股票搜尋功能（代碼和名稱搜尋）
  - ✅ 更新股票代碼驗證邏輯以支援更多ETF格式（00981A、00679B、00646L等）
  - ✅ 整合到前端StockRow元件的更新股價功能
  - _需求: 3.1, 3.2, 3.5, 10.2, 1.3, 14.3, 14.4, 14.5_

- [ ] 12.1 撰寫股價API的屬性測試
  - **Property 10: API容錯機制**

  - **驗證需求: Requirements 3.2, 3.5**

- [ ] 12.2 撰寫股價API的屬性測試
  - **Property 38: 批次API請求**
  - **驗證需求: Requirements 10.2**

- [ ] 12.3 撰寫股價API的單元測試
  - 測試API失敗情境
  - 測試重試機制
  - _需求: 9.1_

- [ ] 12.4 撰寫股票代碼驗證的屬性測試
  - **Property 56: ETF代碼格式識別**
  - **驗證需求: Requirements 1.3**

- [ ] 12.5 撰寫股票代碼驗證的屬性測試
  - **Property 57: 台灣股票代碼格式支援**
  - **驗證需求: Requirements 14.3**

- [ ] 12.6 撰寫股票代碼驗證的屬性測試
  - **Property 58: 特殊ETF格式驗證**

  - **驗證需求: Requirements 14.4**

- [ ] 12.7 撰寫股票代碼驗證的屬性測試
  - **Property 59: 多格式代碼驗證**
  - **驗證需求: Requirements 14.5**

- [ ] 13. 股價更新功能
  - 實作RefreshButton元件（全域更新按鈕）
  - ✅ 實作股價更新邏輯（整合到StockRow操作選單）
  - 實作更新狀態顯示（載入指示器）
  - 實作最後更新時間顯示
  - 實作資料來源標示
  - 實作自動更新機制（可選）
  - 實作閒置暫停更新（5分鐘無操作）
  - _需求: 3.3, 3.4, 10.5, 12.4_

- [ ] 13.1 撰寫股價更新的屬性測試
  - **Property 11: 股價更新完整性**
  - **驗證需求: Requirements 3.3**

- [ ] 13.2 撰寫股價更新的屬性測試
  - **Property 12: 批次更新**
  - **驗證需求: Requirements 3.4**

- [ ] 13.3 撰寫股價更新的屬性測試
  - **Property 40: 閒置暫停更新**
  - **驗證需求: Requirements 10.5**

- [x] 14. 股息管理功能

  - 建立內建股息資料庫（台灣主要股票的歷史股息資料）
  - 實作DividendManager元件（股息管理介面）
  - 實作新增股息記錄功能
  - 實作歷史股息自動計算（根據購買日期）
  - 實作調整成本價計算邏輯
  - 實作股息統計顯示（總股息、年度股息、平均殖利率）
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 14.1 撰寫股息管理的屬性測試
  - **Property 13: 歷史股息計算**
  - **驗證需求: Requirements 4.1, 4.2**

- [ ] 14.2 撰寫股息管理的屬性測試
  - **Property 14: 股息記錄與成本價調整**
  - **驗證需求: Requirements 4.3**

- [ ] 14.3 撰寫股息管理的屬性測試
  - **Property 15: 成本價調整公式**
  - **驗證需求: Requirements 4.4**

- [ ] 14.4 撰寫股息管理的屬性測試
  - **Property 16: 股息統計計算**
  - **驗證需求: Requirements 4.5**

- [ ] 15. 損益計算整合
  - 實作使用調整成本價計算損益
  - 實作總報酬計算（資本利得 + 股息收入）
  - 更新股票清單顯示以反映調整後的損益
  - _需求: 5.2, 5.3_

- [ ] 15.1 撰寫損益計算的屬性測試
  - **Property 18: 損益計算基準**
  - **驗證需求: Requirements 5.2**

- [ ] 16. 本地儲存服務
  - 建立StorageService介面
  - 實作LocalStorage讀寫功能
  - 實作資料序列化/反序列化
  - 實作自動儲存機制（資料變更時觸發）
  - 實作儲存空間檢查與警告
  - 實作錯誤處理（QuotaExceededError等）
  - _需求: 8.1, 9.4_

- [ ] 16.1 撰寫本地儲存的屬性測試
  - **Property 29: 自動本地儲存**
  - **驗證需求: Requirements 8.1**

- [ ] 16.2 撰寫本地儲存的屬性測試
  - **Property 36: 儲存空間檢查**
  - **驗證需求: Requirements 9.4**

- [ ] 17. 雲端同步功能
  - 實作GitHub Gist API整合
  - 實作SyncSettings元件（同步設定介面）
  - 實作GitHub Token設定功能
  - 實作雲端同步啟用/停用
  - 實作自動上傳功能（資料變更時）
  - 實作從雲端下載功能
  - 實作同步狀態顯示
  - 實作資料衝突解決UI（選擇本地/雲端）
  - _需求: 8.2, 8.3, 8.4, 8.5_

- [ ] 17.1 撰寫雲端同步的屬性測試
  - **Property 30: 雲端同步啟用**
  - **驗證需求: Requirements 8.2**

- [ ] 17.2 撰寫雲端同步的屬性測試
  - **Property 31: 自動雲端同步**
  - **驗證需求: Requirements 8.3**

- [ ] 17.3 撰寫雲端同步的屬性測試
  - **Property 32: 資料衝突處理**
  - **驗證需求: Requirements 8.5**

- [ ] 18. 資料匯入匯出功能
  - 建立ImportExportService介面
  - 實作ImportExport元件（匯入匯出介面）
  - 實作JSON格式匯出
  - 實作CSV格式匯出（使用papaparse）
  - 實作Excel格式匯出（使用xlsx）
  - 實作匯出範圍選擇（全部帳戶/指定帳戶）
  - 實作檔案匯入功能
  - 實作檔案格式驗證
  - 實作匯入預覽
  - 實作匯入衝突處理（覆蓋/合併/跳過）
  - _需求: 13.1, 13.2, 13.3, 13.4, 13.5_

- [ ] 18.1 撰寫匯入匯出的屬性測試
  - **Property 51: 匯出範圍選擇**
  - **驗證需求: Requirements 13.1**

- [ ] 18.2 撰寫匯入匯出的屬性測試
  - **Property 52: 帳戶匯出過濾**
  - **驗證需求: Requirements 13.2**

- [ ] 18.3 撰寫匯入匯出的屬性測試
  - **Property 53: 多格式匯出支援**
  - **驗證需求: Requirements 13.3**

- [ ] 18.4 撰寫匯入匯出的屬性測試
  - **Property 54: 匯入驗證與預覽**
  - **驗證需求: Requirements 13.4**

- [ ] 18.5 撰寫匯入匯出的屬性測試
  - **Property 55: 匯入衝突處理**
  - **驗證需求: Requirements 13.5**

- [ ] 19. 錯誤處理與使用者回饋
  - 實作Error Boundary元件
  - 實作Toast通知元件（成功/錯誤/警告訊息）
  - 實作網路連線狀態檢測
  - 實作離線指示器
  - 實作載入指示器（全域與局部）
  - 實作錯誤訊息顯示
  - 實作輸入驗證錯誤提示
  - _需求: 9.2, 9.3, 9.5, 12.4_

- [ ] 19.1 撰寫錯誤處理的屬性測試
  - **Property 33: API失敗容錯**
  - **驗證需求: Requirements 9.1**

- [ ] 19.2 撰寫錯誤處理的屬性測試
  - **Property 34: 輸入驗證**
  - **驗證需求: Requirements 9.2**

- [ ] 19.3 撰寫錯誤處理的屬性測試
  - **Property 37: 離線處理**
  - **驗證需求: Requirements 9.5**

- [ ] 20. 效能優化
  - 實作虛擬滾動（超過50筆股票時）
  - 實作React.memo優化元件重渲染
  - 實作useMemo/useCallback優化計算
  - 實作防抖（debounce）處理輸入
  - 實作節流（throttle）處理滾動和resize
  - 優化批次API請求
  - _需求: 10.1, 10.3, 10.4_

- [ ] 20.1 撰寫效能優化的屬性測試
  - **Property 39: 虛擬滾動**
  - **驗證需求: Requirements 10.4**

- [ ] 21. 最終整合與測試
  - 整合所有功能模組
  - 執行完整測試套件
  - 修復發現的問題
  - 進行跨瀏覽器測試
  - 進行響應式設計測試（不同裝置尺寸）
  - 進行無障礙測試（鍵盤導航、螢幕閱讀器）
  - _需求: 所有需求_

- [ ] 22. UI設計改進與優化
  - 更新Header元件的文字對齊設計
  - 優化標題與按鈕的視覺平衡
  - 確保響應式設計下的一致性
  - 驗證股票代碼驗證邏輯的完整性
  - _需求: 14.1, 14.2_

- [ ] 23. Final Checkpoint - 確保所有測試通過
  - 確保所有測試通過，如有問題請詢問使用者