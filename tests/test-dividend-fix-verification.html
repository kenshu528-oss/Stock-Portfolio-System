<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™¤æ¬Šæ¯ä¿®å¾©é©—è­‰æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .test-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background-color: #2980b9;
        }
        .test-button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .log-container {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.success { background-color: #27ae60; color: white; }
        .status.error { background-color: #e74c3c; color: white; }
        .status.warning { background-color: #f39c12; color: white; }
        .status.info { background-color: #3498db; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é™¤æ¬Šæ¯ä¿®å¾©é©—è­‰æ¸¬è©¦ v1.0.2.0380</h1>
        
        <div class="test-section">
            <h3>ğŸ“‹ æ¸¬è©¦ç›®æ¨™</h3>
            <p>é©—è­‰é™¤æ¬Šæ¯è™•ç†å¤±æ•—ä¸æœƒä¸­æ–·è‚¡åƒ¹æ›´æ–°æµç¨‹ï¼š</p>
            <ul>
                <li>âœ… æ¸¬è©¦ç„¡è‚¡æ¯è³‡æ–™çš„è‚¡ç¥¨ï¼ˆ2208ã€4585ã€00981Aï¼‰</li>
                <li>âœ… ç¢ºèªé™¤æ¬Šæ¯ API 404 éŒ¯èª¤è¢«æ­£ç¢ºè™•ç†</li>
                <li>âœ… é©—è­‰è‚¡åƒ¹æ›´æ–°æµç¨‹ä¸è¢«ä¸­æ–·</li>
                <li>âœ… ç¢ºèª UI èƒ½æ­£å¸¸é¡¯ç¤ºè‚¡åƒ¹æ›´æ–°</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª æ¸¬è©¦ 1ï¼šé™¤æ¬Šæ¯ API éŒ¯èª¤è™•ç†</h3>
            <p>æ¸¬è©¦ç„¡è‚¡æ¯è³‡æ–™è‚¡ç¥¨çš„ API èª¿ç”¨æ˜¯å¦æ­£ç¢ºè™•ç† 404 éŒ¯èª¤</p>
            <button class="test-button" onclick="testDividendAPI()">æ¸¬è©¦é™¤æ¬Šæ¯ API</button>
            <div id="dividendResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª æ¸¬è©¦ 2ï¼šè‚¡åƒ¹æ›´æ–°æµç¨‹</h3>
            <p>æ¨¡æ“¬å®Œæ•´çš„è‚¡åƒ¹æ›´æ–°æµç¨‹ï¼ŒåŒ…å«æœ‰å•é¡Œçš„è‚¡ç¥¨</p>
            <button class="test-button" onclick="testStockPriceUpdate()">æ¸¬è©¦è‚¡åƒ¹æ›´æ–°</button>
            <div id="stockUpdateResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª æ¸¬è©¦ 3ï¼šç¶œåˆæ¸¬è©¦</h3>
            <p>æ¸¬è©¦æ··åˆæœ‰è‚¡æ¯å’Œç„¡è‚¡æ¯çš„è‚¡ç¥¨æ›´æ–°</p>
            <button class="test-button" onclick="testMixedUpdate()">ç¶œåˆæ¸¬è©¦</button>
            <div id="mixedResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š å³æ™‚æ—¥èªŒ</h3>
            <button class="test-button" onclick="clearLogs()">æ¸…é™¤æ—¥èªŒ</button>
            <div id="logContainer" class="log-container"></div>
        </div>
    </div>

    <script>
        // æ—¥èªŒæ”¶é›†
        const logs = [];
        const originalConsole = {
            log: console.log,
            warn: console.warn,
            error: console.error,
            info: console.info
        };

        function addLog(level, message, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${level.toUpperCase()}] ${message} ${args.length > 0 ? JSON.stringify(args) : ''}`;
            logs.push(logEntry);
            
            // æ›´æ–°æ—¥èªŒé¡¯ç¤º
            const logContainer = document.getElementById('logContainer');
            if (logContainer) {
                logContainer.textContent = logs.slice(-50).join('\n'); // åªé¡¯ç¤ºæœ€è¿‘50æ¢
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            // èª¿ç”¨åŸå§‹ console æ–¹æ³•
            originalConsole[level](message, ...args);
        }

        // æ””æˆª console è¼¸å‡º
        console.log = (...args) => addLog('log', args.join(' '));
        console.warn = (...args) => addLog('warn', args.join(' '));
        console.error = (...args) => addLog('error', args.join(' '));
        console.info = (...args) => addLog('info', args.join(' '));

        function clearLogs() {
            logs.length = 0;
            document.getElementById('logContainer').textContent = '';
        }

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = content;
            element.style.display = 'block';
        }

        // æ¸¬è©¦ 1ï¼šé™¤æ¬Šæ¯ API éŒ¯èª¤è™•ç†
        async function testDividendAPI() {
            console.log('ğŸ§ª é–‹å§‹æ¸¬è©¦é™¤æ¬Šæ¯ API éŒ¯èª¤è™•ç†...');
            
            const testStocks = ['2208', '4585', '00981A']; // å·²çŸ¥ç„¡è‚¡æ¯è³‡æ–™çš„è‚¡ç¥¨
            const results = [];
            
            for (const symbol of testStocks) {
                try {
                    console.log(`æ¸¬è©¦ ${symbol} é™¤æ¬Šæ¯ API...`);
                    
                    const response = await fetch(`http://localhost:3001/api/dividend/${symbol}`);
                    
                    if (response.status === 404) {
                        console.log(`âœ… ${symbol}: æ­£ç¢ºè¿”å› 404ï¼Œç„¡è‚¡æ¯è³‡æ–™`);
                        results.push(`${symbol}: âœ… 404 æ­£ç¢ºè™•ç†`);
                    } else if (response.ok) {
                        const data = await response.json();
                        console.log(`âœ… ${symbol}: æˆåŠŸç²å–è‚¡æ¯è³‡æ–™`, data);
                        results.push(`${symbol}: âœ… æœ‰è‚¡æ¯è³‡æ–™ (${data.dividends?.length || 0} ç­†)`);
                    } else {
                        console.warn(`âš ï¸ ${symbol}: éé æœŸç‹€æ…‹ç¢¼ ${response.status}`);
                        results.push(`${symbol}: âš ï¸ ç‹€æ…‹ç¢¼ ${response.status}`);
                    }
                } catch (error) {
                    console.error(`âŒ ${symbol}: API èª¿ç”¨å¤±æ•—`, error);
                    results.push(`${symbol}: âŒ èª¿ç”¨å¤±æ•— - ${error.message}`);
                }
            }
            
            const summary = `é™¤æ¬Šæ¯ API æ¸¬è©¦å®Œæˆï¼š\n\n${results.join('\n')}\n\nâœ… é—œéµï¼š404 éŒ¯èª¤æ‡‰è©²è¢«æ­£ç¢ºè™•ç†ï¼Œä¸æ‹‹å‡ºç•°å¸¸`;
            showResult('dividendResult', summary, 'success');
            console.log('ğŸ§ª é™¤æ¬Šæ¯ API æ¸¬è©¦å®Œæˆ');
        }

        // æ¸¬è©¦ 2ï¼šè‚¡åƒ¹æ›´æ–°æµç¨‹
        async function testStockPriceUpdate() {
            console.log('ğŸ§ª é–‹å§‹æ¸¬è©¦è‚¡åƒ¹æ›´æ–°æµç¨‹...');
            
            const testStocks = [
                { symbol: '2330', hasDiv: true, name: 'å°ç©é›»' },
                { symbol: '2208', hasDiv: false, name: 'å°é‹¼' },
                { symbol: '4585', hasDiv: false, name: 'é”æ˜' }
            ];
            
            const results = [];
            
            for (const stock of testStocks) {
                try {
                    console.log(`æ¸¬è©¦ ${stock.symbol} (${stock.name}) è‚¡åƒ¹æ›´æ–°...`);
                    
                    // 1. æ¸¬è©¦è‚¡åƒ¹ç²å–
                    const priceResponse = await fetch(`http://localhost:3001/api/stock/${stock.symbol}`);
                    let priceSuccess = false;
                    
                    if (priceResponse.ok) {
                        const priceData = await priceResponse.json();
                        console.log(`âœ… ${stock.symbol}: è‚¡åƒ¹ç²å–æˆåŠŸ - ${priceData.price}`);
                        priceSuccess = true;
                    } else {
                        console.warn(`âš ï¸ ${stock.symbol}: è‚¡åƒ¹ç²å–å¤±æ•— - ${priceResponse.status}`);
                    }
                    
                    // 2. æ¸¬è©¦é™¤æ¬Šæ¯è™•ç†ï¼ˆæ¨¡æ“¬ï¼‰
                    let dividendSuccess = true;
                    try {
                        const divResponse = await fetch(`http://localhost:3001/api/dividend/${stock.symbol}`);
                        if (divResponse.ok) {
                            console.log(`âœ… ${stock.symbol}: é™¤æ¬Šæ¯è™•ç†æˆåŠŸ`);
                        } else if (divResponse.status === 404) {
                            console.log(`â„¹ï¸ ${stock.symbol}: ç„¡é™¤æ¬Šæ¯è³‡æ–™ï¼ˆæ­£å¸¸ï¼‰`);
                        } else {
                            throw new Error(`é™¤æ¬Šæ¯ API éŒ¯èª¤: ${divResponse.status}`);
                        }
                    } catch (error) {
                        console.warn(`âš ï¸ ${stock.symbol}: é™¤æ¬Šæ¯è™•ç†å¤±æ•— - ${error.message}`);
                        dividendSuccess = false;
                    }
                    
                    // 3. è©•ä¼°æ•´é«”çµæœ
                    if (priceSuccess) {
                        results.push(`${stock.symbol} (${stock.name}): âœ… è‚¡åƒ¹æ›´æ–°æˆåŠŸ ${dividendSuccess ? '+ é™¤æ¬Šæ¯æ­£å¸¸' : '(é™¤æ¬Šæ¯å¤±æ•—ä½†ä¸å½±éŸ¿)'}`);
                    } else {
                        results.push(`${stock.symbol} (${stock.name}): âŒ è‚¡åƒ¹æ›´æ–°å¤±æ•—`);
                    }
                    
                } catch (error) {
                    console.error(`âŒ ${stock.symbol}: æ›´æ–°æµç¨‹ç•°å¸¸`, error);
                    results.push(`${stock.symbol} (${stock.name}): âŒ æµç¨‹ç•°å¸¸ - ${error.message}`);
                }
            }
            
            const summary = `è‚¡åƒ¹æ›´æ–°æµç¨‹æ¸¬è©¦å®Œæˆï¼š\n\n${results.join('\n')}\n\nâœ… é—œéµï¼šé™¤æ¬Šæ¯å¤±æ•—ä¸æ‡‰å½±éŸ¿è‚¡åƒ¹æ›´æ–°æˆåŠŸ`;
            showResult('stockUpdateResult', summary, 'success');
            console.log('ğŸ§ª è‚¡åƒ¹æ›´æ–°æµç¨‹æ¸¬è©¦å®Œæˆ');
        }

        // æ¸¬è©¦ 3ï¼šç¶œåˆæ¸¬è©¦
        async function testMixedUpdate() {
            console.log('ğŸ§ª é–‹å§‹ç¶œåˆæ¸¬è©¦...');
            
            const mixedStocks = ['2330', '2208', '4585', '00981A', '0050'];
            const results = {
                success: 0,
                failed: 0,
                dividendWarnings: 0
            };
            
            console.log(`æ¸¬è©¦ ${mixedStocks.length} æ”¯è‚¡ç¥¨çš„æ··åˆæ›´æ–°...`);
            
            for (const symbol of mixedStocks) {
                try {
                    // æ¨¡æ“¬å®Œæ•´çš„æ›´æ–°æµç¨‹
                    console.log(`è™•ç† ${symbol}...`);
                    
                    // è‚¡åƒ¹æ›´æ–°
                    const priceResponse = await fetch(`http://localhost:3001/api/stock/${symbol}`);
                    if (priceResponse.ok) {
                        const priceData = await priceResponse.json();
                        console.log(`âœ… ${symbol}: è‚¡åƒ¹ ${priceData.price} (${priceData.source})`);
                        results.success++;
                        
                        // é™¤æ¬Šæ¯è™•ç†ï¼ˆä¸å½±éŸ¿ä¸»æµç¨‹ï¼‰
                        try {
                            const divResponse = await fetch(`http://localhost:3001/api/dividend/${symbol}`);
                            if (divResponse.status === 404) {
                                console.log(`â„¹ï¸ ${symbol}: ç„¡é™¤æ¬Šæ¯è³‡æ–™ï¼Œè·³éè™•ç†`);
                                results.dividendWarnings++;
                            } else if (divResponse.ok) {
                                const divData = await divResponse.json();
                                console.log(`âœ… ${symbol}: é™¤æ¬Šæ¯è³‡æ–™ ${divData.dividends?.length || 0} ç­†`);
                            }
                        } catch (divError) {
                            console.warn(`âš ï¸ ${symbol}: é™¤æ¬Šæ¯è™•ç†å¤±æ•—ï¼Œä½†ä¸å½±éŸ¿è‚¡åƒ¹æ›´æ–°`);
                            results.dividendWarnings++;
                        }
                        
                    } else {
                        console.error(`âŒ ${symbol}: è‚¡åƒ¹ç²å–å¤±æ•—`);
                        results.failed++;
                    }
                    
                } catch (error) {
                    console.error(`âŒ ${symbol}: è™•ç†ç•°å¸¸`, error);
                    results.failed++;
                }
            }
            
            const summary = `ç¶œåˆæ¸¬è©¦å®Œæˆï¼š
            
ğŸ“Š çµæœçµ±è¨ˆï¼š
- è‚¡åƒ¹æ›´æ–°æˆåŠŸï¼š${results.success}/${mixedStocks.length}
- è‚¡åƒ¹æ›´æ–°å¤±æ•—ï¼š${results.failed}/${mixedStocks.length}
- é™¤æ¬Šæ¯è­¦å‘Šï¼š${results.dividendWarnings} (ä¸å½±éŸ¿è‚¡åƒ¹æ›´æ–°)

âœ… é—œéµé©—è­‰ï¼š
- é™¤æ¬Šæ¯ 404 éŒ¯èª¤ä¸ä¸­æ–·è‚¡åƒ¹æ›´æ–°æµç¨‹
- è‚¡åƒ¹æ›´æ–°å„ªå…ˆï¼Œé™¤æ¬Šæ¯è™•ç†å¤±æ•—ä¸å½±éŸ¿çµæœ
- UI æ‡‰è©²èƒ½æ­£å¸¸é¡¯ç¤ºæ‰€æœ‰æˆåŠŸæ›´æ–°çš„è‚¡åƒ¹`;
            
            showResult('mixedResult', summary, results.failed === 0 ? 'success' : 'warning');
            console.log('ğŸ§ª ç¶œåˆæ¸¬è©¦å®Œæˆ');
        }

        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            console.log('ğŸ”§ é™¤æ¬Šæ¯ä¿®å¾©é©—è­‰æ¸¬è©¦é é¢è¼‰å…¥å®Œæˆ');
            console.log('ğŸ“‹ æ¸¬è©¦ç›®æ¨™ï¼šé©—è­‰ v1.0.2.0380 ä¿®å¾©é™¤æ¬Šæ¯è™•ç†å¤±æ•—å°è‡´è‚¡åƒ¹æ›´æ–°ä¸­æ–·çš„å•é¡Œ');
            console.log('ğŸ¯ é—œéµä¿®å¾©ï¼šé™¤æ¬Šæ¯è™•ç†å¤±æ•—æ™‚ä½¿ç”¨ warn è€Œé errorï¼Œä¸ä¸­æ–·è‚¡åƒ¹æ›´æ–°æµç¨‹');
        });
    </script>
</body>
</html>