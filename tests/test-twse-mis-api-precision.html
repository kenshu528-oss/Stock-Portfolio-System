<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­‰äº¤æ‰€ MIS API ç²¾æº–æ¸¬è©¦ - v1.0.2.0358</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
        }
        .test-section h3 {
            color: #1f2937;
            margin-top: 0;
        }
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stock-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
        }
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .stock-symbol {
            font-weight: bold;
            color: #1f2937;
        }
        .market-type {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .market-tse {
            background-color: #dbeafe;
            color: #1d4ed8;
        }
        .market-otc {
            background-color: #fef3c7;
            color: #d97706;
        }
        .price-info {
            margin: 8px 0;
        }
        .price {
            font-size: 18px;
            font-weight: bold;
            color: #059669;
        }
        .change {
            font-size: 14px;
            margin-left: 10px;
        }
        .change.positive {
            color: #dc2626;
        }
        .change.negative {
            color: #059669;
        }
        .api-info {
            font-size: 12px;
            color: #6b7280;
            margin-top: 8px;
        }
        .loading {
            color: #6b7280;
            font-style: italic;
        }
        .error {
            color: #dc2626;
            font-size: 12px;
        }
        .success {
            color: #059669;
            font-size: 12px;
        }
        .test-controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 14px;
        }
        button:hover {
            background-color: #1d4ed8;
        }
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .log-section {
            margin-top: 30px;
            padding: 15px;
            background-color: #1f2937;
            color: #f9fafb;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .key-points {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .key-points h4 {
            color: #92400e;
            margin-top: 0;
        }
        .key-points ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .key-points li {
            margin: 5px 0;
            color: #78350f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ è­‰äº¤æ‰€ MIS API ç²¾æº–æ¸¬è©¦</h1>
        <p style="text-align: center; color: #6b7280;">
            åŸºæ–¼ç”¨æˆ¶è©³ç´°æŒ‡å°ï¼šç²¾æº–å¸‚å ´è·¯å¾‘ + å³æ™‚åƒ¹æ ¼é™·é˜±è™•ç† + è²·é€²åƒ¹å‚™æ´æ©Ÿåˆ¶
        </p>

        <div class="key-points">
            <h4>ğŸ”‘ é—œéµæ¸¬è©¦è¦é»</h4>
            <ul>
                <li><strong>ç²¾æº–å¸‚å ´è·¯å¾‘</strong>ï¼šä¸Šå¸‚ç”¨ tseï¼Œä¸Šæ«ƒç”¨ otcï¼Œèµ°éŒ¯è·¯æŠ“ä¸åˆ°è³‡æ–™</li>
                <li><strong>å³æ™‚åƒ¹æ ¼é™·é˜±</strong>ï¼šz(æˆäº¤åƒ¹) æ˜¯æ©«æ§“ - æ™‚ï¼Œæ”¹æŠ“ b(è²·é€²åƒ¹)</li>
                <li><strong>ç”¨é€”å®šä½</strong>ï¼šGitHub Pages å³æ™‚ç›£æ§å°ˆç”¨ï¼Œé…è‚¡é…æ¯ç”¨ FinMind</li>
            </ul>
        </div>

        <div class="test-controls">
            <button onclick="testAllStocks()">ğŸš€ é–‹å§‹æ¸¬è©¦</button>
            <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤çµæœ</button>
            <button onclick="testSingleStock()">ğŸ¯ æ¸¬è©¦å–®ä¸€è‚¡ç¥¨</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š ä¸Šå¸‚è‚¡ç¥¨æ¸¬è©¦ (TSE)</h3>
            <p>æ¸¬è©¦ tse_XXXX.tw è·¯å¾‘æ˜¯å¦æ­£ç¢º</p>
            <div class="stock-grid" id="tse-stocks">
                <!-- ä¸Šå¸‚è‚¡ç¥¨æ¸¬è©¦çµæœ -->
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ˆ ä¸Šæ«ƒè‚¡ç¥¨æ¸¬è©¦ (OTC)</h3>
            <p>æ¸¬è©¦ otc_XXXX.tw è·¯å¾‘æ˜¯å¦æ­£ç¢ºï¼Œç‰¹åˆ¥æ˜¯ 5314 ä¸–ç´€</p>
            <div class="stock-grid" id="otc-stocks">
                <!-- ä¸Šæ«ƒè‚¡ç¥¨æ¸¬è©¦çµæœ -->
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ¦ ETF æ¸¬è©¦</h3>
            <p>æ¸¬è©¦ ETF ä½¿ç”¨ tse è·¯å¾‘</p>
            <div class="stock-grid" id="etf-stocks">
                <!-- ETF æ¸¬è©¦çµæœ -->
            </div>
        </div>

        <div class="log-section" id="log-output">
            <div>ğŸ“ æ¸¬è©¦æ—¥èªŒå°‡é¡¯ç¤ºåœ¨é€™è£¡...</div>
        </div>
    </div>

    <script>
        // æ¸¬è©¦è‚¡ç¥¨æ¸…å–®
        const testStocks = {
            tse: [
                { symbol: '2330', name: 'å°ç©é›»', expected: 'tse_2330.tw' },
                { symbol: '2881', name: 'å¯Œé‚¦é‡‘', expected: 'tse_2881.tw' },
                { symbol: '2886', name: 'å…†è±é‡‘', expected: 'tse_2886.tw' },
                { symbol: '2317', name: 'é´»æµ·', expected: 'tse_2317.tw' }
            ],
            otc: [
                { symbol: '5314', name: 'ä¸–ç´€', expected: 'otc_5314.tw' },
                { symbol: '6188', name: 'å»£æ˜', expected: 'otc_6188.tw' },
                { symbol: '4585', name: 'é”æ˜', expected: 'otc_4585.tw' },
                { symbol: '3008', name: 'å¤§ç«‹å…‰', expected: 'otc_3008.tw' }
            ],
            etf: [
                { symbol: '0050', name: 'å…ƒå¤§å°ç£50', expected: 'tse_0050.tw' },
                { symbol: '00940', name: 'å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯', expected: 'tse_00940.tw' },
                { symbol: '00679B', name: 'å…ƒå¤§ç¾å‚µ20å¹´', expected: 'tse_00679B.tw' }
            ]
        };

        let logOutput = document.getElementById('log-output');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#f9fafb',
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type];
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // åˆ¤æ–·å¸‚å ´é¡å‹ï¼ˆè¤‡è£½å¯¦éš›é‚è¼¯ï¼‰
        function getMarketTypeForTWSE(symbol) {
            const code = parseInt(symbol.substring(0, 4));
            
            // ETF é€šå¸¸åœ¨ä¸Šå¸‚ (tse)
            if (symbol.match(/^00\d+/)) {
                return 'tse';
            }
            
            // ä¸Šå¸‚è‚¡ç¥¨ (1000-2999) â†’ tse
            if (code >= 1000 && code <= 2999) {
                return 'tse';
            }
            
            // ä¸Šæ«ƒè‚¡ç¥¨ (3000-8999) â†’ otc
            if (code >= 3000 && code <= 8999) {
                return 'otc';
            }
            
            // é è¨­ä¸Šå¸‚ (tse)
            return 'tse';
        }

        // æ¸¬è©¦å–®ä¸€è‚¡ç¥¨
        async function testStock(symbol, name, expectedPath, marketType) {
            const market = getMarketTypeForTWSE(symbol);
            const apiUrl = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=${market}_${symbol}.tw&json=1`;
            
            log(`ğŸ” æ¸¬è©¦ ${symbol} ${name}ï¼šé æœŸè·¯å¾‘ ${expectedPath}ï¼Œå¯¦éš›è·¯å¾‘ ${market}_${symbol}.tw`);
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (!data.msgArray || data.msgArray.length === 0) {
                    throw new Error('ç„¡è³‡æ–™æˆ–è‚¡ç¥¨ä»£ç¢¼éŒ¯èª¤');
                }

                const info = data.msgArray[0];
                
                // è™•ç†å³æ™‚åƒ¹æ ¼é™·é˜±
                let currentPrice = 0;
                let priceSource = '';
                
                if (info.z && info.z !== '-' && !isNaN(parseFloat(info.z))) {
                    currentPrice = parseFloat(info.z);
                    priceSource = 'æˆäº¤åƒ¹';
                } else if (info.b && info.b !== '-' && !isNaN(parseFloat(info.b))) {
                    currentPrice = parseFloat(info.b);
                    priceSource = 'è²·é€²åƒ¹';
                } else {
                    throw new Error(`ç„¡æœ‰æ•ˆåƒ¹æ ¼ï¼šz=${info.z}, b=${info.b}`);
                }
                
                const yesterdayPrice = parseFloat(info.y) || currentPrice;
                const change = currentPrice - yesterdayPrice;
                const changePercent = yesterdayPrice > 0 ? (change / yesterdayPrice) * 100 : 0;

                log(`âœ… ${symbol} æˆåŠŸï¼š${currentPrice} (${priceSource})ï¼Œæ¼²è·Œ ${change.toFixed(2)} (${changePercent.toFixed(2)}%)`, 'success');
                
                return {
                    success: true,
                    symbol,
                    name: info.n || name,
                    price: currentPrice,
                    change,
                    changePercent,
                    priceSource,
                    market,
                    time: info.t,
                    volume: info.v,
                    apiUrl
                };

            } catch (error) {
                log(`âŒ ${symbol} å¤±æ•—ï¼š${error.message}`, 'error');
                return {
                    success: false,
                    symbol,
                    name,
                    error: error.message,
                    market,
                    apiUrl
                };
            }
        }

        // æ¸²æŸ“è‚¡ç¥¨å¡ç‰‡
        function renderStockCard(result, containerId) {
            const container = document.getElementById(containerId);
            const card = document.createElement('div');
            card.className = 'stock-card';
            
            if (result.success) {
                const changeClass = result.change >= 0 ? 'positive' : 'negative';
                const changeSymbol = result.change >= 0 ? '+' : '';
                
                card.innerHTML = `
                    <div class="stock-header">
                        <span class="stock-symbol">${result.symbol} ${result.name}</span>
                        <span class="market-type market-${result.market}">${result.market.toUpperCase()}</span>
                    </div>
                    <div class="price-info">
                        <span class="price">$${result.price.toFixed(2)}</span>
                        <span class="change ${changeClass}">
                            ${changeSymbol}${result.change.toFixed(2)} (${changeSymbol}${result.changePercent.toFixed(2)}%)
                        </span>
                    </div>
                    <div class="api-info">
                        <div class="success">âœ… åƒ¹æ ¼ä¾†æº: ${result.priceSource}</div>
                        <div>æ™‚é–“: ${result.time || 'N/A'}</div>
                        <div>æˆäº¤é‡: ${result.volume || 'N/A'}</div>
                        <div style="font-size: 10px; margin-top: 5px; word-break: break-all;">
                            API: ${result.apiUrl}
                        </div>
                    </div>
                `;
            } else {
                card.innerHTML = `
                    <div class="stock-header">
                        <span class="stock-symbol">${result.symbol} ${result.name}</span>
                        <span class="market-type market-${result.market}">${result.market.toUpperCase()}</span>
                    </div>
                    <div class="error">âŒ ${result.error}</div>
                    <div class="api-info">
                        <div style="font-size: 10px; margin-top: 5px; word-break: break-all;">
                            API: ${result.apiUrl}
                        </div>
                    </div>
                `;
            }
            
            container.appendChild(card);
        }

        // æ¸¬è©¦æ‰€æœ‰è‚¡ç¥¨
        async function testAllStocks() {
            log('ğŸš€ é–‹å§‹æ¸¬è©¦æ‰€æœ‰è‚¡ç¥¨...', 'info');
            clearResults();
            
            // æ¸¬è©¦ä¸Šå¸‚è‚¡ç¥¨
            log('ğŸ“Š æ¸¬è©¦ä¸Šå¸‚è‚¡ç¥¨ (TSE)...', 'info');
            for (const stock of testStocks.tse) {
                const result = await testStock(stock.symbol, stock.name, stock.expected, 'tse');
                renderStockCard(result, 'tse-stocks');
                await new Promise(resolve => setTimeout(resolve, 500)); // é¿å…è«‹æ±‚éæ–¼é »ç¹
            }
            
            // æ¸¬è©¦ä¸Šæ«ƒè‚¡ç¥¨
            log('ğŸ“ˆ æ¸¬è©¦ä¸Šæ«ƒè‚¡ç¥¨ (OTC)...', 'info');
            for (const stock of testStocks.otc) {
                const result = await testStock(stock.symbol, stock.name, stock.expected, 'otc');
                renderStockCard(result, 'otc-stocks');
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // æ¸¬è©¦ ETF
            log('ğŸ¦ æ¸¬è©¦ ETF...', 'info');
            for (const stock of testStocks.etf) {
                const result = await testStock(stock.symbol, stock.name, stock.expected, 'etf');
                renderStockCard(result, 'etf-stocks');
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log('âœ… æ‰€æœ‰æ¸¬è©¦å®Œæˆï¼', 'success');
        }

        // æ¸…é™¤çµæœ
        function clearResults() {
            document.getElementById('tse-stocks').innerHTML = '';
            document.getElementById('otc-stocks').innerHTML = '';
            document.getElementById('etf-stocks').innerHTML = '';
            logOutput.innerHTML = '<div>ğŸ“ æ¸¬è©¦æ—¥èªŒå·²æ¸…é™¤...</div>';
        }

        // æ¸¬è©¦å–®ä¸€è‚¡ç¥¨
        async function testSingleStock() {
            const symbol = prompt('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ (ä¾‹å¦‚: 5314)ï¼š');
            if (!symbol) return;
            
            const name = prompt('è«‹è¼¸å…¥è‚¡ç¥¨åç¨± (å¯é¸)ï¼š') || 'æœªçŸ¥';
            
            log(`ğŸ¯ æ¸¬è©¦å–®ä¸€è‚¡ç¥¨ï¼š${symbol} ${name}`, 'info');
            
            const market = getMarketTypeForTWSE(symbol);
            const expectedPath = `${market}_${symbol}.tw`;
            
            const result = await testStock(symbol, name, expectedPath, market);
            
            // æ ¹æ“šå¸‚å ´é¡å‹æ¸²æŸ“åˆ°å°æ‡‰å€åŸŸ
            let containerId = 'tse-stocks';
            if (market === 'otc') containerId = 'otc-stocks';
            else if (symbol.match(/^00\d+/)) containerId = 'etf-stocks';
            
            renderStockCard(result, containerId);
        }

        // é é¢è¼‰å…¥æ™‚çš„èªªæ˜
        log('ğŸ¯ è­‰äº¤æ‰€ MIS API ç²¾æº–æ¸¬è©¦å·¥å…·å·²è¼‰å…¥', 'info');
        log('ğŸ“‹ æ¸¬è©¦é‡é»ï¼š', 'info');
        log('  1. ç²¾æº–å¸‚å ´è·¯å¾‘ï¼šä¸Šå¸‚(tse) vs ä¸Šæ«ƒ(otc)', 'info');
        log('  2. å³æ™‚åƒ¹æ ¼é™·é˜±ï¼šæˆäº¤åƒ¹(-) â†’ è²·é€²åƒ¹', 'info');
        log('  3. ç‰¹åˆ¥é—œæ³¨ï¼š5314 ä¸–ç´€å¿…é ˆç”¨ otc_5314.tw', 'warning');
        log('ğŸš€ é»æ“Šã€Œé–‹å§‹æ¸¬è©¦ã€æŒ‰éˆ•é–‹å§‹é©—è­‰ï¼', 'info');
    </script>
</body>
</html>