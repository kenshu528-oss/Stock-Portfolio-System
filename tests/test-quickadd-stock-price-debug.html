<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickAddStock è‚¡åƒ¹èª¿è©¦æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e293b;
            color: #e2e8f0;
        }
        .test-section {
            background: #334155;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        .result {
            background: #0f172a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .warning { border-left: 4px solid #f59e0b; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        .disabled { background: #6b7280; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>ğŸ” QuickAddStock è‚¡åƒ¹èª¿è©¦æ¸¬è©¦</h1>
    <p>è¨ºæ–·æ–°å¢å€‹è‚¡æ™‚è‚¡åƒ¹ä¸ä¸€è‡´çš„å•é¡Œ</p>

    <div class="test-section">
        <h2>å•é¡Œæè¿°</h2>
        <div class="result">
Console æ—¥èªŒé¡¯ç¤ºï¼š
âœ… [vercel] 4585 è‚¡åƒ¹ç²å–æˆåŠŸ {"price":383.5,"source":"Yahoo Finance (Vercel)","fullSymbol":"4585.TW"}

ä½† UI é¡¯ç¤ºï¼š
è‚¡åƒ¹: $354.5

å•é¡Œï¼šQuickAddStock ä¸­çš„è‚¡åƒ¹å¯èƒ½ä¾†è‡ªä¸åŒçš„ä¾†æºæˆ–æ™‚é–“é»
        </div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 1ï¼šç›´æ¥æ¸¬è©¦ Vercel API</h2>
        <button onclick="testVercelAPI()">æ¸¬è©¦ Vercel API ç²å– 4585 è‚¡åƒ¹</button>
        <div id="vercel-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 2ï¼šæ¸¬è©¦é›²ç«¯è‚¡åƒ¹æœå‹™</h2>
        <button onclick="testCloudStockPriceService()">æ¸¬è©¦é›²ç«¯è‚¡åƒ¹æœå‹™ç²å– 4585</button>
        <div id="cloud-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 3ï¼šæ¨¡æ“¬ QuickAddStock æœå°‹æµç¨‹</h2>
        <button onclick="simulateQuickAddSearch()">æ¨¡æ“¬æœå°‹ 4585 é”æ˜</button>
        <div id="search-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 4ï¼šæª¢æŸ¥è‚¡åƒ¹ä¾†æºä¸€è‡´æ€§</h2>
        <button onclick="checkPriceConsistency()">æª¢æŸ¥å¤šå€‹ API çš„è‚¡åƒ¹ä¸€è‡´æ€§</button>
        <div id="consistency-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 5ï¼šæª¢æŸ¥æ™‚é–“æˆ³å’Œå¿«å–</h2>
        <button onclick="checkTimestampAndCache()">æª¢æŸ¥æ™‚é–“æˆ³å’Œå¿«å–æ©Ÿåˆ¶</button>
        <div id="timestamp-result" class="result"></div>
    </div>

    <script>
        // æ¸¬è©¦ 1ï¼šç›´æ¥æ¸¬è©¦ Vercel API
        async function testVercelAPI() {
            const resultDiv = document.getElementById('vercel-result');
            resultDiv.textContent = 'æ­£åœ¨æ¸¬è©¦ Vercel API...';
            
            try {
                const response = await fetch('https://vercel-stock-api.vercel.app/api/stock-price?symbol=4585');
                const data = await response.json();
                
                resultDiv.textContent = `Vercel API çµæœï¼š
ç‹€æ…‹: ${response.status}
æˆåŠŸ: ${data.success}
è‚¡åƒ¹: ${data.price}
ä¾†æº: ${data.source}
å®Œæ•´ä»£è™Ÿ: ${data.fullSymbol}
æ™‚é–“æˆ³: ${data.timestamp}
åŸå§‹æ•¸æ“š: ${JSON.stringify(data, null, 2)}`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent = `Vercel API éŒ¯èª¤: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // æ¸¬è©¦ 2ï¼šæ¸¬è©¦é›²ç«¯è‚¡åƒ¹æœå‹™ï¼ˆéœ€è¦æ¨¡æ“¬ï¼Œå› ç‚ºç„¡æ³•ç›´æ¥å°å…¥ï¼‰
        async function testCloudStockPriceService() {
            const resultDiv = document.getElementById('cloud-result');
            resultDiv.textContent = 'æ­£åœ¨æ¸¬è©¦é›²ç«¯è‚¡åƒ¹æœå‹™...';
            
            try {
                // æ¨¡æ“¬é›²ç«¯è‚¡åƒ¹æœå‹™çš„é‚è¼¯
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch('https://vercel-stock-api.vercel.app/api/stock-price?symbol=4585', {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.success || !data.price || data.price <= 0) {
                    throw new Error('ç„¡æ•ˆè‚¡åƒ¹æ•¸æ“š');
                }
                
                const processedData = {
                    price: parseFloat(data.price.toFixed(2)),
                    change: parseFloat(data.change.toFixed(2)),
                    changePercent: parseFloat(data.changePercent.toFixed(2)),
                    source: data.source,
                    timestamp: data.timestamp
                };
                
                resultDiv.textContent = `é›²ç«¯è‚¡åƒ¹æœå‹™çµæœï¼š
è™•ç†å¾Œè‚¡åƒ¹: ${processedData.price}
æ¼²è·Œ: ${processedData.change}
æ¼²è·Œå¹…: ${processedData.changePercent}%
ä¾†æº: ${processedData.source}
æ™‚é–“æˆ³: ${processedData.timestamp}
è™•ç†å¾Œæ•¸æ“š: ${JSON.stringify(processedData, null, 2)}`;
                resultDiv.className = 'result success';
            } catch (error) {
                if (error.name === 'AbortError') {
                    resultDiv.textContent = 'é›²ç«¯è‚¡åƒ¹æœå‹™è«‹æ±‚è¶…æ™‚';
                } else {
                    resultDiv.textContent = `é›²ç«¯è‚¡åƒ¹æœå‹™éŒ¯èª¤: ${error.message}`;
                }
                resultDiv.className = 'result error';
            }
        }

        // æ¸¬è©¦ 3ï¼šæ¨¡æ“¬ QuickAddStock æœå°‹æµç¨‹
        async function simulateQuickAddSearch() {
            const resultDiv = document.getElementById('search-result');
            resultDiv.textContent = 'æ­£åœ¨æ¨¡æ“¬ QuickAddStock æœå°‹æµç¨‹...';
            
            try {
                // æ­¥é©Ÿ 1ï¼šæ¨¡æ“¬å¾è‚¡ç¥¨æ¸…å–®ç²å–åŸºæœ¬è³‡è¨Š
                const stockListResponse = await fetch('/public/stock_list.json');
                const stockListData = await stockListResponse.json();
                
                const stock4585 = stockListData.stocks['4585'];
                if (!stock4585) {
                    throw new Error('åœ¨è‚¡ç¥¨æ¸…å–®ä¸­æ‰¾ä¸åˆ° 4585');
                }
                
                resultDiv.textContent += `æ­¥é©Ÿ 1 - è‚¡ç¥¨æ¸…å–®è³‡è¨Šï¼š
ä»£è™Ÿ: 4585
åç¨±: ${stock4585.name}
å¸‚å ´: ${stock4585.market}

`;
                
                // æ­¥é©Ÿ 2ï¼šç²å–å³æ™‚è‚¡åƒ¹
                const priceResponse = await fetch('https://vercel-stock-api.vercel.app/api/stock-price?symbol=4585');
                const priceData = await priceResponse.json();
                
                if (!priceData.success) {
                    throw new Error('è‚¡åƒ¹ç²å–å¤±æ•—');
                }
                
                // æ­¥é©Ÿ 3ï¼šæ¨¡æ“¬ QuickAddStock çš„æ•¸æ“šçµæ§‹
                const searchResult = {
                    symbol: '4585',
                    name: stock4585.name,
                    price: priceData.price,
                    market: stock4585.market,
                    source: priceData.source
                };
                
                resultDiv.textContent += `æ­¥é©Ÿ 2 - å³æ™‚è‚¡åƒ¹ï¼š
API è‚¡åƒ¹: ${priceData.price}
API ä¾†æº: ${priceData.source}
API æ™‚é–“æˆ³: ${priceData.timestamp}

æ­¥é©Ÿ 3 - QuickAddStock æœå°‹çµæœï¼š
${JSON.stringify(searchResult, null, 2)}

å•é¡Œåˆ†æï¼š
- å¦‚æœ UI é¡¯ç¤º $354.5ï¼Œä½† API è¿”å› $383.5
- å¯èƒ½åŸå› ï¼š
  1. å¿«å–æ©Ÿåˆ¶å°è‡´é¡¯ç¤ºèˆŠåƒ¹æ ¼
  2. ä¸åŒæ™‚é–“é»çš„ API èª¿ç”¨
  3. å‰ç«¯ç‹€æ…‹æ›´æ–°å•é¡Œ
  4. è‚¡åƒ¹ä¾†æºä¸ä¸€è‡´`;
                
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent += `\næ¨¡æ“¬æœå°‹éŒ¯èª¤: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // æ¸¬è©¦ 4ï¼šæª¢æŸ¥è‚¡åƒ¹ä¾†æºä¸€è‡´æ€§
        async function checkPriceConsistency() {
            const resultDiv = document.getElementById('consistency-result');
            resultDiv.textContent = 'æ­£åœ¨æª¢æŸ¥è‚¡åƒ¹ä¾†æºä¸€è‡´æ€§...';
            
            const results = [];
            
            try {
                // æ¸¬è©¦å¤šæ¬¡èª¿ç”¨ Vercel API
                for (let i = 1; i <= 3; i++) {
                    const response = await fetch(`https://vercel-stock-api.vercel.app/api/stock-price?symbol=4585&_t=${Date.now()}`);
                    const data = await response.json();
                    
                    results.push({
                        attempt: i,
                        price: data.price,
                        source: data.source,
                        timestamp: data.timestamp,
                        fullSymbol: data.fullSymbol
                    });
                    
                    // é–“éš” 1 ç§’
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                resultDiv.textContent = `è‚¡åƒ¹ä¸€è‡´æ€§æª¢æŸ¥çµæœï¼š
${results.map(r => `ç¬¬ ${r.attempt} æ¬¡: $${r.price} (${r.source}) [${r.timestamp}]`).join('\n')}

åˆ†æï¼š
- åƒ¹æ ¼æ˜¯å¦ä¸€è‡´: ${results.every(r => r.price === results[0].price) ? 'æ˜¯' : 'å¦'}
- ä¾†æºæ˜¯å¦ä¸€è‡´: ${results.every(r => r.source === results[0].source) ? 'æ˜¯' : 'å¦'}
- æ™‚é–“æˆ³å·®ç•°: ${Math.max(...results.map(r => new Date(r.timestamp).getTime())) - Math.min(...results.map(r => new Date(r.timestamp).getTime()))} ms

${results.every(r => r.price === results[0].price) ? 
  'âœ… è‚¡åƒ¹ä¸€è‡´ï¼Œå•é¡Œå¯èƒ½åœ¨å‰ç«¯è™•ç†' : 
  'âš ï¸ è‚¡åƒ¹ä¸ä¸€è‡´ï¼Œå¯èƒ½æ˜¯ API è¿”å›ä¸åŒæ™‚é–“é»çš„æ•¸æ“š'}`;
                
                resultDiv.className = results.every(r => r.price === results[0].price) ? 'result success' : 'result warning';
            } catch (error) {
                resultDiv.textContent = `ä¸€è‡´æ€§æª¢æŸ¥éŒ¯èª¤: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // æ¸¬è©¦ 5ï¼šæª¢æŸ¥æ™‚é–“æˆ³å’Œå¿«å–
        async function checkTimestampAndCache() {
            const resultDiv = document.getElementById('timestamp-result');
            resultDiv.textContent = 'æ­£åœ¨æª¢æŸ¥æ™‚é–“æˆ³å’Œå¿«å–æ©Ÿåˆ¶...';
            
            try {
                const now = new Date();
                const response = await fetch(`https://vercel-stock-api.vercel.app/api/stock-price?symbol=4585&_t=${now.getTime()}`);
                const data = await response.json();
                
                const apiTimestamp = new Date(data.timestamp);
                const timeDiff = now.getTime() - apiTimestamp.getTime();
                
                // æª¢æŸ¥æ˜¯å¦åœ¨äº¤æ˜“æ™‚é–“
                const hour = now.getHours();
                const minute = now.getMinutes();
                const currentTime = hour * 60 + minute;
                const marketOpen = 9 * 60; // 09:00
                const marketClose = 13 * 60 + 30; // 13:30
                const isMarketHours = currentTime >= marketOpen && currentTime <= marketClose;
                const isWeekday = now.getDay() >= 1 && now.getDay() <= 5;
                const isMarketOpen = isMarketHours && isWeekday;
                
                resultDiv.textContent = `æ™‚é–“æˆ³å’Œå¿«å–æª¢æŸ¥ï¼š
ç•¶å‰æ™‚é–“: ${now.toLocaleString()}
API æ™‚é–“æˆ³: ${apiTimestamp.toLocaleString()}
æ™‚é–“å·®ç•°: ${timeDiff} ms (${(timeDiff / 1000).toFixed(1)} ç§’)

å¸‚å ´ç‹€æ…‹åˆ†æï¼š
ç•¶å‰æ™‚é–“: ${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}
æ˜¯å¦å·¥ä½œæ—¥: ${isWeekday ? 'æ˜¯' : 'å¦'}
æ˜¯å¦äº¤æ˜“æ™‚é–“: ${isMarketHours ? 'æ˜¯' : 'å¦'}
å¸‚å ´æ˜¯å¦é–‹ç›¤: ${isMarketOpen ? 'æ˜¯' : 'å¦'}

è‚¡åƒ¹è³‡è¨Šï¼š
è‚¡åƒ¹: $${data.price}
ä¾†æº: ${data.source}
å®Œæ•´ä»£è™Ÿ: ${data.fullSymbol}

åˆ†æçµè«–ï¼š
${!isMarketOpen ? 
  'âš ï¸ å¸‚å ´æœªé–‹ç›¤ï¼Œé¡¯ç¤ºçš„å¯èƒ½æ˜¯æ”¶ç›¤åƒ¹è€Œéå³æ™‚åƒ¹æ ¼' : 
  'âœ… å¸‚å ´é–‹ç›¤ä¸­ï¼Œæ‡‰è©²æ˜¯å³æ™‚åƒ¹æ ¼'}

${timeDiff > 60000 ? 
  'âš ï¸ API æ™‚é–“æˆ³è¼ƒèˆŠï¼Œå¯èƒ½å­˜åœ¨å¿«å–æˆ–å»¶é²' : 
  'âœ… API æ™‚é–“æˆ³è¼ƒæ–°ï¼Œæ•¸æ“šæ‡‰è©²æ˜¯æœ€æ–°çš„'}`;
                
                resultDiv.className = 'result ' + (isMarketOpen && timeDiff <= 60000 ? 'success' : 'warning');
            } catch (error) {
                resultDiv.textContent = `æ™‚é–“æˆ³æª¢æŸ¥éŒ¯èª¤: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºç•¶å‰æ™‚é–“
        document.addEventListener('DOMContentLoaded', function() {
            console.log('QuickAddStock è‚¡åƒ¹èª¿è©¦æ¸¬è©¦é é¢å·²è¼‰å…¥');
            console.log('ç•¶å‰æ™‚é–“:', new Date().toLocaleString());
        });
    </script>
</body>
</html>