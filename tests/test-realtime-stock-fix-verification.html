<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚è‚¡åƒ¹ä¿®å¾©é©—è­‰æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e293b;
            color: #e2e8f0;
        }
        .test-section {
            background: #334155;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        .result {
            background: #0f172a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .warning { border-left: 4px solid #f59e0b; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .api-result {
            background: #0f172a;
            padding: 15px;
            border-radius: 4px;
            border: 2px solid #374151;
        }
        .api-result.twse { border-color: #10b981; }
        .api-result.vercel { border-color: #3b82f6; }
    </style>
</head>
<body>
    <h1>ğŸ” å³æ™‚è‚¡åƒ¹ä¿®å¾©é©—è­‰æ¸¬è©¦ (v1.0.2.0381)</h1>
    <p>é©—è­‰è­‰äº¤æ‰€å³æ™‚ API ä¿®å¾©æ•ˆæœ</p>

    <div class="test-section">
        <h2>ä¿®å¾©å…§å®¹</h2>
        <div class="result">
v1.0.2.0381 ä¿®å¾©å…§å®¹ï¼š
âœ… æ·»åŠ è­‰äº¤æ‰€å³æ™‚ API ä½œç‚ºç¬¬ä¸€å„ªå…ˆç´š
âœ… å„ªåŒ–è‚¡åƒ¹ä¾†æºå„ªå…ˆç´šï¼šè­‰äº¤æ‰€å³æ™‚ > Vercel Edge Functions  
âœ… æ™ºèƒ½å¸‚å ´åˆ¤æ–·ï¼šè‡ªå‹•åˆ¤æ–·ä¸Šå¸‚/ä¸Šæ«ƒè‚¡ç¥¨
âœ… ä¿®å¾© QuickAddStock ç¸½æ˜¯ç²å–æœ€æ–°è‚¡åƒ¹
âœ… æ”¯æ´å¼·åˆ¶åˆ·æ–°ï¼Œè·³éå¿«å–

æ¸¬è©¦ç›®æ¨™ï¼š
- é©—è­‰è­‰äº¤æ‰€ API èƒ½ç²å–å³æ™‚åƒ¹æ ¼
- é©—è­‰åƒ¹æ ¼æ¯” Yahoo Finance æ›´å³æ™‚
- é©—è­‰ä¸Šå¸‚/ä¸Šæ«ƒè‚¡ç¥¨éƒ½èƒ½æ­£ç¢ºè™•ç†
        </div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 1ï¼šè­‰äº¤æ‰€å³æ™‚ API vs Vercel API æ¯”è¼ƒ</h2>
        <button onclick="compareAPIs()">æ¯”è¼ƒè­‰äº¤æ‰€å³æ™‚ API vs Vercel API</button>
        <div class="comparison" id="api-comparison"></div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 2ï¼šæ¸¬è©¦ä¸åŒé¡å‹è‚¡ç¥¨</h2>
        <button onclick="testDifferentStockTypes()">æ¸¬è©¦ä¸Šå¸‚/ä¸Šæ«ƒ/ETF è‚¡ç¥¨</button>
        <div id="stock-types-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 3ï¼šé©—è­‰å³æ™‚æ€§</h2>
        <button onclick="testRealTimeUpdates()">æ¸¬è©¦å³æ™‚æ›´æ–°æ•ˆæœ</button>
        <div id="realtime-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 4ï¼šæ¨¡æ“¬ QuickAddStock æµç¨‹</h2>
        <button onclick="simulateQuickAddFlow()">æ¨¡æ“¬æ–°å¢è‚¡ç¥¨æµç¨‹</button>
        <div id="quickadd-result" class="result"></div>
    </div>

    <script>
        // æ¸¬è©¦ 1ï¼šæ¯”è¼ƒä¸åŒ API
        async function compareAPIs() {
            const comparisonDiv = document.getElementById('api-comparison');
            comparisonDiv.innerHTML = '<div class="result">æ­£åœ¨æ¯”è¼ƒä¸åŒ API...</div>';
            
            const testSymbols = ['4585', '2330', '0050']; // ä¸Šæ«ƒã€ä¸Šå¸‚ã€ETF
            
            for (const symbol of testSymbols) {
                try {
                    // æ¸¬è©¦è­‰äº¤æ‰€å³æ™‚ API
                    const twseResult = await testTWSEAPI(symbol);
                    
                    // æ¸¬è©¦ Vercel API
                    const vercelResult = await testVercelAPI(symbol);
                    
                    // å‰µå»ºæ¯”è¼ƒçµæœ
                    const comparisonHTML = `
                        <div class="api-result twse">
                            <h3>ğŸ›ï¸ è­‰äº¤æ‰€å³æ™‚ API - ${symbol}</h3>
                            ${twseResult.success ? `
                                <div>åƒ¹æ ¼: $${twseResult.price}</div>
                                <div>æ¼²è·Œ: ${twseResult.change > 0 ? '+' : ''}${twseResult.change}</div>
                                <div>æ¼²è·Œå¹…: ${twseResult.changePercent > 0 ? '+' : ''}${twseResult.changePercent}%</div>
                                <div>æ™‚é–“: ${twseResult.time}</div>
                                <div>äº¤æ˜“æ‰€: ${twseResult.exchange}</div>
                            ` : `
                                <div class="error">éŒ¯èª¤: ${twseResult.error}</div>
                            `}
                        </div>
                        
                        <div class="api-result vercel">
                            <h3>ğŸŒ Vercel API - ${symbol}</h3>
                            ${vercelResult.success ? `
                                <div>åƒ¹æ ¼: $${vercelResult.price}</div>
                                <div>æ¼²è·Œ: ${vercelResult.change > 0 ? '+' : ''}${vercelResult.change}</div>
                                <div>æ¼²è·Œå¹…: ${vercelResult.changePercent > 0 ? '+' : ''}${vercelResult.changePercent}%</div>
                                <div>ä¾†æº: ${vercelResult.source}</div>
                                <div>æ™‚é–“æˆ³: ${new Date(vercelResult.timestamp).toLocaleString()}</div>
                            ` : `
                                <div class="error">éŒ¯èª¤: ${vercelResult.error}</div>
                            `}
                        </div>
                    `;
                    
                    comparisonDiv.innerHTML += comparisonHTML;
                    
                    // åˆ†æçµæœ
                    if (twseResult.success && vercelResult.success) {
                        const priceDiff = Math.abs(twseResult.price - vercelResult.price);
                        const analysis = `
                            <div class="result ${priceDiff < 0.01 ? 'success' : 'warning'}">
                                ${symbol} åˆ†æçµæœ:
                                åƒ¹æ ¼å·®ç•°: ${priceDiff.toFixed(2)}
                                ${priceDiff < 0.01 ? 'âœ… åƒ¹æ ¼ä¸€è‡´' : 'âš ï¸ åƒ¹æ ¼æœ‰å·®ç•°'}
                                ${twseResult.price > vercelResult.price ? 'è­‰äº¤æ‰€åƒ¹æ ¼è¼ƒé«˜' : 'è­‰äº¤æ‰€åƒ¹æ ¼è¼ƒä½'}
                            </div>
                        `;
                        comparisonDiv.innerHTML += analysis;
                    }
                    
                } catch (error) {
                    comparisonDiv.innerHTML += `<div class="result error">${symbol} æ¸¬è©¦éŒ¯èª¤: ${error.message}</div>`;
                }
            }
        }

        // è­‰äº¤æ‰€ API æ¸¬è©¦å‡½æ•¸
        async function testTWSEAPI(symbol) {
            try {
                const code = parseInt(symbol.substring(0, 4));
                const isOTC = code >= 3000 && code <= 8999;
                const exchange = isOTC ? 'otc' : 'tse';
                const exchangeSymbol = `${symbol}.tw`;
                
                const url = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=${exchange}_${exchangeSymbol}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Accept': 'application/json',
                        'Referer': 'https://mis.twse.com.tw/',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.msgArray || data.msgArray.length === 0) {
                    throw new Error('ç„¡è³‡æ–™');
                }
                
                const stockData = data.msgArray[0];
                const currentPrice = parseFloat(stockData.z);
                const previousClose = parseFloat(stockData.y);
                const change = currentPrice - previousClose;
                const changePercent = previousClose > 0 ? (change / previousClose) * 100 : 0;
                
                return {
                    success: true,
                    price: currentPrice,
                    change: parseFloat(change.toFixed(2)),
                    changePercent: parseFloat(changePercent.toFixed(2)),
                    time: stockData.t,
                    exchange: exchange.toUpperCase()
                };
                
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Vercel API æ¸¬è©¦å‡½æ•¸
        async function testVercelAPI(symbol) {
            try {
                const response = await fetch(`https://vercel-stock-api.vercel.app/api/stock-price?symbol=${symbol}&_t=${Date.now()}`);
                const data = await response.json();
                
                if (!response.ok || data.error) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                return {
                    success: true,
                    price: data.price,
                    change: data.change,
                    changePercent: data.changePercent,
                    source: data.source,
                    timestamp: data.timestamp
                };
                
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // æ¸¬è©¦ 2ï¼šä¸åŒé¡å‹è‚¡ç¥¨
        async function testDifferentStockTypes() {
            const resultDiv = document.getElementById('stock-types-result');
            resultDiv.textContent = 'æ­£åœ¨æ¸¬è©¦ä¸åŒé¡å‹è‚¡ç¥¨...';
            
            const stockTypes = [
                { symbol: '2330', type: 'ä¸Šå¸‚è‚¡ç¥¨', name: 'å°ç©é›»' },
                { symbol: '4585', type: 'ä¸Šæ«ƒè‚¡ç¥¨', name: 'é”æ˜' },
                { symbol: '6188', type: 'ä¸Šæ«ƒè‚¡ç¥¨', name: 'å»£æ˜' },
                { symbol: '0050', type: 'ETF', name: 'å…ƒå¤§å°ç£50' },
                { symbol: '00679B', type: 'å‚µåˆ¸ETF', name: 'å…ƒå¤§ç¾å‚µ20å¹´' }
            ];
            
            const results = [];
            
            for (const stock of stockTypes) {
                try {
                    const twseResult = await testTWSEAPI(stock.symbol);
                    results.push({
                        ...stock,
                        success: twseResult.success,
                        price: twseResult.price,
                        exchange: twseResult.exchange,
                        error: twseResult.error
                    });
                } catch (error) {
                    results.push({
                        ...stock,
                        success: false,
                        error: error.message
                    });
                }
            }
            
            resultDiv.textContent = `ä¸åŒé¡å‹è‚¡ç¥¨æ¸¬è©¦çµæœï¼š
${results.map(r => `
${r.type} - ${r.symbol} (${r.name}):
${r.success ? `
  âœ… æˆåŠŸç²å–åƒ¹æ ¼: $${r.price}
  ğŸ“Š äº¤æ˜“æ‰€: ${r.exchange}` : `
  âŒ ç²å–å¤±æ•—: ${r.error}`}
`).join('\n')}

åˆ†æï¼š
- ä¸Šå¸‚è‚¡ç¥¨ä½¿ç”¨ TSE äº¤æ˜“æ‰€
- ä¸Šæ«ƒè‚¡ç¥¨ä½¿ç”¨ OTC äº¤æ˜“æ‰€  
- ETF æ ¹æ“šä»£ç¢¼è‡ªå‹•åˆ¤æ–·äº¤æ˜“æ‰€
- è­‰äº¤æ‰€ API æ”¯æ´æ‰€æœ‰é¡å‹çš„å°è‚¡`;
            
            resultDiv.className = 'result success';
        }

        // æ¸¬è©¦ 3ï¼šå³æ™‚æ€§æ¸¬è©¦
        async function testRealTimeUpdates() {
            const resultDiv = document.getElementById('realtime-result');
            resultDiv.textContent = 'æ­£åœ¨æ¸¬è©¦å³æ™‚æ›´æ–°æ•ˆæœ...';
            
            const symbol = '2330'; // ä½¿ç”¨å°ç©é›»æ¸¬è©¦
            const results = [];
            
            // é€£çºŒç²å– 3 æ¬¡ï¼Œé–“éš” 5 ç§’
            for (let i = 1; i <= 3; i++) {
                try {
                    const twseResult = await testTWSEAPI(symbol);
                    const vercelResult = await testVercelAPI(symbol);
                    
                    results.push({
                        attempt: i,
                        time: new Date().toLocaleString(),
                        twse: twseResult.success ? twseResult.price : null,
                        vercel: vercelResult.success ? vercelResult.price : null,
                        twseTime: twseResult.success ? twseResult.time : null
                    });
                    
                    if (i < 3) {
                        resultDiv.textContent += `\nç¬¬ ${i} æ¬¡å®Œæˆï¼Œç­‰å¾… 5 ç§’...`;
                        await new Promise(resolve => setTimeout(resolve, 5000));
                    }
                } catch (error) {
                    results.push({
                        attempt: i,
                        time: new Date().toLocaleString(),
                        error: error.message
                    });
                }
            }
            
            resultDiv.textContent = `å³æ™‚æ›´æ–°æ¸¬è©¦çµæœ (${symbol}):
${results.map(r => `
ç¬¬ ${r.attempt} æ¬¡ (${r.time}):
${r.error ? `éŒ¯èª¤: ${r.error}` : `
  è­‰äº¤æ‰€: $${r.twse} (${r.twseTime})
  Vercel: $${r.vercel}
  å·®ç•°: ${Math.abs(r.twse - r.vercel).toFixed(2)}`}
`).join('\n')}

åˆ†æï¼š
- æª¢æŸ¥åƒ¹æ ¼æ˜¯å¦æœ‰è®ŠåŒ–
- æª¢æŸ¥è­‰äº¤æ‰€æ™‚é–“æˆ³æ˜¯å¦æ›´æ–°
- é©—è­‰å³æ™‚æ€§æ•ˆæœ`;
            
            resultDiv.className = 'result success';
        }

        // æ¸¬è©¦ 4ï¼šæ¨¡æ“¬ QuickAddStock æµç¨‹
        async function simulateQuickAddFlow() {
            const resultDiv = document.getElementById('quickadd-result');
            resultDiv.textContent = 'æ­£åœ¨æ¨¡æ“¬ QuickAddStock æµç¨‹...';
            
            const symbol = '4585'; // ä½¿ç”¨é”æ˜æ¸¬è©¦
            
            try {
                // æ­¥é©Ÿ 1ï¼šæ¨¡æ“¬æœå°‹è‚¡ç¥¨
                resultDiv.textContent += '\næ­¥é©Ÿ 1: æœå°‹è‚¡ç¥¨...';
                
                // æ­¥é©Ÿ 2ï¼šæ¨¡æ“¬é¸æ“‡è‚¡ç¥¨ï¼ˆå¼·åˆ¶åˆ·æ–°ï¼‰
                resultDiv.textContent += '\næ­¥é©Ÿ 2: é¸æ“‡è‚¡ç¥¨ï¼Œç²å–æœ€æ–°è‚¡åƒ¹...';
                
                const twseResult = await testTWSEAPI(symbol);
                const vercelResult = await testVercelAPI(symbol);
                
                // æ­¥é©Ÿ 3ï¼šæ¨¡æ“¬æ–°å¢è‚¡ç¥¨
                resultDiv.textContent += '\næ­¥é©Ÿ 3: æº–å‚™æ–°å¢è‚¡ç¥¨...';
                
                const finalResult = `
QuickAddStock æµç¨‹æ¨¡æ“¬çµæœï¼š

æ­¥é©Ÿ 1 - æœå°‹è‚¡ç¥¨: âœ… æ‰¾åˆ° ${symbol} é”æ˜
æ­¥é©Ÿ 2 - ç²å–æœ€æ–°è‚¡åƒ¹:
  è­‰äº¤æ‰€å³æ™‚: ${twseResult.success ? `$${twseResult.price}` : 'å¤±æ•—'}
  Vercel å‚™æ´: ${vercelResult.success ? `$${vercelResult.price}` : 'å¤±æ•—'}
  
æ­¥é©Ÿ 3 - é¸æ“‡æœ€ä½³åƒ¹æ ¼:
  ${twseResult.success ? `âœ… ä½¿ç”¨è­‰äº¤æ‰€å³æ™‚åƒ¹æ ¼: $${twseResult.price}` : 
    vercelResult.success ? `âš ï¸ ä½¿ç”¨ Vercel å‚™æ´åƒ¹æ ¼: $${vercelResult.price}` : 
    'âŒ æ‰€æœ‰ä¾†æºéƒ½å¤±æ•—'}

ä¿®å¾©æ•ˆæœé©—è­‰:
${twseResult.success ? 'âœ… è­‰äº¤æ‰€å³æ™‚ API æ­£å¸¸å·¥ä½œ' : 'âŒ è­‰äº¤æ‰€ API å¤±æ•—'}
${vercelResult.success ? 'âœ… Vercel å‚™æ´ API æ­£å¸¸å·¥ä½œ' : 'âŒ Vercel API å¤±æ•—'}
${twseResult.success && vercelResult.success ? 
  `åƒ¹æ ¼å·®ç•°: ${Math.abs(twseResult.price - vercelResult.price).toFixed(2)} (${Math.abs(twseResult.price - vercelResult.price) < 1 ? 'å·®ç•°å¾ˆå°' : 'å·®ç•°è¼ƒå¤§'})` : 
  'ç„¡æ³•æ¯”è¼ƒåƒ¹æ ¼'}

çµè«–: ${twseResult.success ? 'âœ… ä¿®å¾©æˆåŠŸï¼Œèƒ½ç²å–å³æ™‚åƒ¹æ ¼' : 'âš ï¸ éœ€è¦é€²ä¸€æ­¥èª¿è©¦'}`;
                
                resultDiv.textContent = finalResult;
                resultDiv.className = twseResult.success ? 'result success' : 'result warning';
                
            } catch (error) {
                resultDiv.textContent = `QuickAddStock æµç¨‹æ¨¡æ“¬éŒ¯èª¤: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºä¿®å¾©è³‡è¨Š
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const currentTime = hour * 60 + minute;
            const marketOpen = 9 * 60; // 09:00
            const marketClose = 13 * 60 + 30; // 13:30
            const isMarketHours = currentTime >= marketOpen && currentTime <= marketClose;
            const isWeekday = now.getDay() >= 1 && now.getDay() <= 5;
            const isMarketOpen = isMarketHours && isWeekday;
            
            console.log('å³æ™‚è‚¡åƒ¹ä¿®å¾©é©—è­‰æ¸¬è©¦é é¢å·²è¼‰å…¥ (v1.0.2.0381)');
            console.log('ç•¶å‰æ™‚é–“:', now.toLocaleString());
            console.log('å¸‚å ´ç‹€æ…‹:', isMarketOpen ? 'é–‹ç›¤ä¸­' : 'ä¼‘å¸‚ä¸­');
            
            // åœ¨é é¢é ‚éƒ¨é¡¯ç¤ºä¿®å¾©è³‡è¨Š
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = 'background: #059669; color: white; padding: 15px; margin-bottom: 20px; border-radius: 4px;';
            statusDiv.innerHTML = `
                <h3>ğŸ”§ v1.0.2.0381 å³æ™‚è‚¡åƒ¹ä¿®å¾©</h3>
                <div>ç•¶å‰æ™‚é–“: ${now.toLocaleString()} | å¸‚å ´ç‹€æ…‹: ${isMarketOpen ? 'ğŸŸ¢ é–‹ç›¤ä¸­' : 'ğŸ”´ ä¼‘å¸‚ä¸­'}</div>
                <div>ä¿®å¾©å…§å®¹: æ·»åŠ è­‰äº¤æ‰€å³æ™‚ APIï¼Œç²å–çœŸæ­£çš„å³æ™‚åƒ¹æ ¼</div>
                <div>å„ªå…ˆç´š: è­‰äº¤æ‰€å³æ™‚ API > Vercel Edge Functions</div>
            `;
            document.body.insertBefore(statusDiv, document.body.firstChild);
        });
    </script>
</body>
</html>