name: Update Stock List

on:
  schedule:
    # æ¯æ—¥å°ç£æ™‚é–“ 8:30 åŸ·è¡Œï¼ˆUTC 0:30ï¼‰- é¿é–‹æ•´é»é«˜å³°
    - cron: '30 0 * * *'
    # å‚™ç”¨æ™‚é–“ï¼šå°ç£æ™‚é–“ 10:15 åŸ·è¡Œï¼ˆUTC 2:15ï¼‰
    - cron: '15 2 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  update-stock-list:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install Python dependencies
      run: |
        pip install FinMind tqdm pandas
        
    - name: Check if already updated today
      run: |
        TODAY=$(date +%Y-%m-%d)
        if [ -f "public/stock_list_$TODAY.json" ]; then
          echo "ğŸ“ ä»Šæ—¥è‚¡ç¥¨æ¸…å–®å·²å­˜åœ¨ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°"
          # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦æ˜¯ä»Šå¤©å‰µå»ºçš„
          FILE_DATE=$(jq -r '.date' "public/stock_list_$TODAY.json" 2>/dev/null || echo "")
          if [ "$FILE_DATE" = "$TODAY" ]; then
            echo "âœ… ä»Šæ—¥è‚¡ç¥¨æ¸…å–®å·²æ˜¯æœ€æ–°ï¼Œè·³éæ›´æ–°"
            echo "SKIP_UPDATE=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ æª”æ¡ˆå­˜åœ¨ä½†æ—¥æœŸä¸ç¬¦ï¼Œéœ€è¦æ›´æ–°"
            echo "SKIP_UPDATE=false" >> $GITHUB_ENV
          fi
        else
          echo "ğŸ“‹ ä»Šæ—¥è‚¡ç¥¨æ¸…å–®ä¸å­˜åœ¨ï¼Œéœ€è¦æ›´æ–°"
          echo "SKIP_UPDATE=false" >> $GITHUB_ENV
        fi
        
    - name: Fetch stock list
      if: env.SKIP_UPDATE != 'true'
      env:
        FINMIND_TOKEN: ${{ secrets.FINMIND_TOKEN }}
      run: |
        # æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
        if [ -z "$FINMIND_TOKEN" ]; then
          echo "âŒ æ‰¾ä¸åˆ° FINMIND_TOKEN ç’°å¢ƒè®Šæ•¸"
          echo "ä½¿ç”¨è…³æœ¬å…§å»ºçš„ Token"
        else
          echo "âœ… FINMIND_TOKEN ç’°å¢ƒè®Šæ•¸å·²è¨­å®š"
        fi
        
        # åŸ·è¡Œè‚¡ç¥¨æ¸…å–®æŠ“å–è…³æœ¬ï¼ˆå¼·åˆ¶æ›´æ–°ï¼‰
        python backend/fetch_stock_list.py --force
        
    - name: Check and copy stock list
      if: env.SKIP_UPDATE != 'true'
      run: |
        mkdir -p public
        TODAY=$(date +%Y-%m-%d)
        
        echo "ğŸ” æª¢æŸ¥ä»Šæ—¥è‚¡ç¥¨æ¸…å–®æª”æ¡ˆ..."
        ls -la stock_list_*.json || echo "æ²’æœ‰æ‰¾åˆ°è‚¡ç¥¨æ¸…å–®æª”æ¡ˆ"
        
        # å°‹æ‰¾ä»Šæ—¥çš„è‚¡ç¥¨æ¸…å–®æª”æ¡ˆ
        if [ -f "stock_list_$TODAY.json" ]; then
          cp "stock_list_$TODAY.json" public/stock_list.json
          cp "stock_list_$TODAY.json" "public/stock_list_$TODAY.json"
          echo "âœ… è‚¡ç¥¨æ¸…å–®å·²è¤‡è£½: stock_list_$TODAY.json"
          
          # é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
          STOCK_COUNT=$(jq '.count' public/stock_list.json)
          echo "ğŸ“Š è‚¡ç¥¨ç¸½æ•¸: $STOCK_COUNT"
        else
          echo "âŒ æ‰¾ä¸åˆ°ä»Šæ—¥è‚¡ç¥¨æ¸…å–®: stock_list_$TODAY.json"
          echo "ğŸ“‹ å¯ç”¨çš„æª”æ¡ˆ:"
          ls -la stock_list_*.json || echo "æ²’æœ‰è‚¡ç¥¨æ¸…å–®æª”æ¡ˆ"
          exit 1
        fi
        
    - name: Commit and push changes
      if: env.SKIP_UPDATE != 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ‰€æœ‰è‚¡ç¥¨æ¸…å–®ç›¸é—œæª”æ¡ˆ
        git add public/stock_list*.json
        git add stock_list_*.json
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --staged --quiet; then
          echo "ğŸ“ è‚¡ç¥¨æ¸…å–®ç„¡è®Šæ›´ï¼Œè·³éæäº¤"
        else
          TODAY=$(date +%Y-%m-%d)
          git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°è‚¡ç¥¨æ¸…å–® $TODAY"
          git push
          echo "âœ… è‚¡ç¥¨æ¸…å–®å·²æ›´æ–°ä¸¦æ¨é€åˆ°å€‰åº«"
        fi