name: Update Stock List

on:
  schedule:
    # æ¯æ—¥å°ç£æ™‚é–“ 6:00 åŸ·è¡Œï¼ˆUTC 22:00 å‰ä¸€å¤©ï¼‰- é¿é–‹æ‰€æœ‰é«˜å³°
    - cron: '0 22 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  update-stock-list:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install Python dependencies
      run: |
        pip install FinMind tqdm pandas
        
    - name: Check if already updated today
      run: |
        TODAY=$(date +%Y-%m-%d)
        if [ -f "public/stock_list_$TODAY.json" ]; then
          echo "ğŸ“ ä»Šæ—¥è‚¡ç¥¨æ¸…å–®å·²å­˜åœ¨ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°"
          # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦æ˜¯ä»Šå¤©å‰µå»ºçš„
          FILE_DATE=$(jq -r '.date' "public/stock_list_$TODAY.json" 2>/dev/null || echo "")
          if [ "$FILE_DATE" = "$TODAY" ]; then
            echo "âœ… ä»Šæ—¥è‚¡ç¥¨æ¸…å–®å·²æ˜¯æœ€æ–°ï¼Œè·³éæ›´æ–°"
            echo "SKIP_UPDATE=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ æª”æ¡ˆå­˜åœ¨ä½†æ—¥æœŸä¸ç¬¦ï¼Œéœ€è¦æ›´æ–°"
            echo "SKIP_UPDATE=false" >> $GITHUB_ENV
          fi
        else
          echo "ğŸ“‹ ä»Šæ—¥è‚¡ç¥¨æ¸…å–®ä¸å­˜åœ¨ï¼Œéœ€è¦æ›´æ–°"
          echo "SKIP_UPDATE=false" >> $GITHUB_ENV
        fi
        
    - name: Fetch stock list
      if: env.SKIP_UPDATE != 'true'
      env:
        FINMIND_TOKEN: ${{ secrets.FINMIND_TOKEN || secrets.VITE_FINMIND_TOKEN }}
      run: |
        # æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
        echo "ğŸ” æª¢æŸ¥ FINMIND_TOKEN ç’°å¢ƒè®Šæ•¸..."
        if [ -z "$FINMIND_TOKEN" ]; then
          echo "âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° FINMIND_TOKEN æˆ– VITE_FINMIND_TOKEN secret"
          echo ""
          echo "ğŸ“‹ ä¿®å¾©æ­¥é©Ÿï¼š"
          echo "1. å‰å¾€ GitHub å€‰åº«è¨­å®š"
          echo "2. Settings â†’ Secrets and variables â†’ Actions"
          echo "3. æ–°å¢ Repository secretï¼š"
          echo "   Name: FINMIND_TOKEN"
          echo "   Secret: ä½ çš„ FinMind Token"
          echo ""
          echo "ğŸ’¡ è©³ç´°èªªæ˜è«‹åƒè€ƒ: docs/guides/GITHUB_STOCK_LIST_FIX.md"
          echo ""
          echo "âš ï¸ Workflow å°‡æœƒå¤±æ•—ï¼Œè«‹è¨­å®š Secret å¾Œé‡æ–°åŸ·è¡Œ"
          exit 1
        else
          echo "âœ… ä½¿ç”¨ GitHub secret ä¸­çš„ FinMind Token"
          echo "ğŸ“ Token é•·åº¦: ${#FINMIND_TOKEN} å­—å…ƒ"
        fi
        
        # æª¢æŸ¥ Python å’Œä¾è³´
        echo ""
        echo "ğŸ” æª¢æŸ¥ Python ç’°å¢ƒ..."
        python --version
        echo ""
        echo "ğŸ” æª¢æŸ¥å·²å®‰è£çš„å¥—ä»¶..."
        pip list | grep -i finmind || echo "âš ï¸ FinMind æœªå®‰è£"
        pip list | grep -i pandas || echo "âš ï¸ pandas æœªå®‰è£"
        pip list | grep -i tqdm || echo "âš ï¸ tqdm æœªå®‰è£"
        
        # åŸ·è¡Œè‚¡ç¥¨æ¸…å–®æŠ“å–è…³æœ¬ï¼ˆå¼·åˆ¶æ›´æ–°ï¼‰
        echo ""
        echo "ğŸš€ é–‹å§‹åŸ·è¡Œè‚¡ç¥¨æ¸…å–®æ›´æ–°..."
        echo "ğŸ“‚ ç•¶å‰ç›®éŒ„: $(pwd)"
        echo "ğŸ“‚ backend ç›®éŒ„å…§å®¹:"
        ls -la backend/ || echo "backend ç›®éŒ„ä¸å­˜åœ¨"
        
        cd backend
        echo "ğŸ“‚ åˆ‡æ›åˆ° backend ç›®éŒ„: $(pwd)"
        
        # åŸ·è¡Œ Python è…³æœ¬ä¸¦æ•ç²è¼¸å‡º
        if python fetch_stock_list.py --force; then
          echo ""
          echo "âœ… è‚¡ç¥¨æ¸…å–®æŠ“å–æˆåŠŸ"
        else
          echo ""
          echo "âŒ è‚¡ç¥¨æ¸…å–®æŠ“å–å¤±æ•—"
          echo "ğŸ“‹ å¯èƒ½çš„åŸå› ï¼š"
          echo "1. FinMind Token ç„¡æ•ˆæˆ–éæœŸ"
          echo "2. FinMind API æœå‹™ç•°å¸¸"
          echo "3. ç¶²è·¯é€£ç·šå•é¡Œ"
          echo "4. Python ä¾è³´æœªæ­£ç¢ºå®‰è£"
          echo ""
          echo "ğŸ’¡ è«‹æª¢æŸ¥ä¸Šæ–¹çš„è©³ç´°éŒ¯èª¤è¨Šæ¯"
          exit 1
        fi
        
    - name: Check and copy stock list
      if: env.SKIP_UPDATE != 'true'
      run: |
        mkdir -p public
        TODAY=$(date +%Y-%m-%d)
        
        echo "ğŸ” æª¢æŸ¥ä»Šæ—¥è‚¡ç¥¨æ¸…å–®æª”æ¡ˆ..."
        echo "ç•¶å‰ç›®éŒ„: $(pwd)"
        echo "backend ç›®éŒ„å…§å®¹:"
        ls -la backend/ || echo "backend ç›®éŒ„ä¸å­˜åœ¨"
        echo "æ ¹ç›®éŒ„è‚¡ç¥¨æ¸…å–®æª”æ¡ˆ:"
        ls -la stock_list_*.json || echo "æ²’æœ‰æ‰¾åˆ°è‚¡ç¥¨æ¸…å–®æª”æ¡ˆ"
        
        # å°‹æ‰¾ä»Šæ—¥çš„è‚¡ç¥¨æ¸…å–®æª”æ¡ˆï¼ˆå„ªå…ˆå¾æ ¹ç›®éŒ„ï¼‰
        if [ -f "stock_list_$TODAY.json" ]; then
          cp "stock_list_$TODAY.json" public/stock_list.json
          cp "stock_list_$TODAY.json" "public/stock_list_$TODAY.json"
          echo "âœ… è‚¡ç¥¨æ¸…å–®å·²è¤‡è£½: stock_list_$TODAY.json"
          
          # é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
          STOCK_COUNT=$(jq '.count' public/stock_list.json)
          echo "ğŸ“Š è‚¡ç¥¨ç¸½æ•¸: $STOCK_COUNT"
        elif [ -f "backend/stock_list_$TODAY.json" ]; then
          cp "backend/stock_list_$TODAY.json" public/stock_list.json
          cp "backend/stock_list_$TODAY.json" "public/stock_list_$TODAY.json"
          echo "âœ… å¾ backend ç›®éŒ„è¤‡è£½è‚¡ç¥¨æ¸…å–®: stock_list_$TODAY.json"
          
          # é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
          STOCK_COUNT=$(jq '.count' public/stock_list.json)
          echo "ğŸ“Š è‚¡ç¥¨ç¸½æ•¸: $STOCK_COUNT"
        else
          echo "âŒ æ‰¾ä¸åˆ°ä»Šæ—¥è‚¡ç¥¨æ¸…å–®: stock_list_$TODAY.json"
          echo "ğŸ“‹ å¯ç”¨çš„æª”æ¡ˆ:"
          find . -name "stock_list_*.json" -type f || echo "æ²’æœ‰è‚¡ç¥¨æ¸…å–®æª”æ¡ˆ"
          exit 1
        fi
        
    - name: Commit and push changes
      if: env.SKIP_UPDATE != 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ‰€æœ‰è‚¡ç¥¨æ¸…å–®ç›¸é—œæª”æ¡ˆ
        git add public/stock_list*.json
        git add stock_list_*.json
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --staged --quiet; then
          echo "ğŸ“ è‚¡ç¥¨æ¸…å–®ç„¡è®Šæ›´ï¼Œè·³éæäº¤"
        else
          TODAY=$(date +%Y-%m-%d)
          git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°è‚¡ç¥¨æ¸…å–® $TODAY"
          git push
          echo "âœ… è‚¡ç¥¨æ¸…å–®å·²æ›´æ–°ä¸¦æ¨é€åˆ°å€‰åº«"
        fi