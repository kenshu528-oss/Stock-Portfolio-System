name: Update Stock List

on:
  schedule:
    # æ¯æ—¥å°ç£æ™‚é–“ 8:00 åŸ·è¡Œï¼ˆUTC 0:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  update-stock-list:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install Python dependencies
      run: |
        pip install FinMind tqdm pandas
        
    - name: Fetch stock list
      env:
        FINMIND_TOKEN: ${{ secrets.FINMIND_TOKEN }}
      run: |
        # æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
        if [ -z "$FINMIND_TOKEN" ]; then
          echo "âŒ æ‰¾ä¸åˆ° FINMIND_TOKEN ç’°å¢ƒè®Šæ•¸"
          exit 1
        fi
        
        echo "âœ… FINMIND_TOKEN ç’°å¢ƒè®Šæ•¸å·²è¨­å®š"
        
        # åŸ·è¡Œè‚¡ç¥¨æ¸…å–®æŠ“å–è…³æœ¬
        python backend/fetch_stock_list.py
        
    - name: Copy to public directory
      run: |
        mkdir -p public
        # è¤‡è£½ä»Šæ—¥çš„è‚¡ç¥¨æ¸…å–®åˆ° public ç›®éŒ„
        TODAY=$(date +%Y-%m-%d)
        if [ -f "stock_list_$TODAY.json" ]; then
          cp "stock_list_$TODAY.json" public/stock_list.json
          echo "âœ… è‚¡ç¥¨æ¸…å–®å·²è¤‡è£½åˆ° public/stock_list.json"
          
          # é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
          STOCK_COUNT=$(jq '.count' public/stock_list.json)
          echo "ğŸ“Š è‚¡ç¥¨ç¸½æ•¸: $STOCK_COUNT"
        else
          echo "âŒ æ‰¾ä¸åˆ°ä»Šæ—¥è‚¡ç¥¨æ¸…å–®: stock_list_$TODAY.json"
          exit 1
        fi
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add public/stock_list.json
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --staged --quiet; then
          echo "ğŸ“ è‚¡ç¥¨æ¸…å–®ç„¡è®Šæ›´ï¼Œè·³éæäº¤"
        else
          git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°è‚¡ç¥¨æ¸…å–® $(date +%Y-%m-%d)"
          git push
          echo "âœ… è‚¡ç¥¨æ¸…å–®å·²æ›´æ–°ä¸¦æ¨é€åˆ°å€‰åº«"
        fi