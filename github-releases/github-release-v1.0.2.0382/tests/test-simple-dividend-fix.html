<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡å–®é™¤æ¬Šæ¯ä¿®å¾©æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            display: block;
            width: 100%;
        }
        .test-button:hover {
            background-color: #2980b9;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            background-color: #2c3e50;
            color: #ecf0f1;
            font-size: 12px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px 0;
        }
        .success { background-color: #27ae60; color: white; }
        .error { background-color: #e74c3c; color: white; }
        .warning { background-color: #f39c12; color: white; }
        .info { background-color: #3498db; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é™¤æ¬Šæ¯ä¿®å¾©æ¸¬è©¦ v1.0.2.0380</h1>
        
        <p><strong>æ¸¬è©¦ç›®æ¨™ï¼š</strong>é©—è­‰é™¤æ¬Šæ¯è™•ç†å¤±æ•—ä¸æœƒä¸­æ–·è‚¡åƒ¹æ›´æ–°æµç¨‹</p>
        
        <button class="test-button" onclick="testDividendErrorHandling()">
            æ¸¬è©¦é™¤æ¬Šæ¯éŒ¯èª¤è™•ç†ï¼ˆ2208ã€4585ã€00981Aï¼‰
        </button>
        
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.textContent += `[${timestamp}] ${message}\n`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
            console.log(message);
        }

        async function testDividendErrorHandling() {
            log('ğŸ§ª é–‹å§‹æ¸¬è©¦é™¤æ¬Šæ¯éŒ¯èª¤è™•ç†...');
            
            const problemStocks = ['2208', '4585', '00981A']; // å·²çŸ¥æœƒç”¢ç”Ÿ 404 çš„è‚¡ç¥¨
            
            for (const symbol of problemStocks) {
                log(`\nğŸ“Š æ¸¬è©¦ ${symbol}...`);
                
                try {
                    // 1. æ¸¬è©¦é™¤æ¬Šæ¯ API
                    log(`  ğŸ” èª¿ç”¨é™¤æ¬Šæ¯ API: /api/dividend/${symbol}`);
                    const divResponse = await fetch(`http://localhost:3001/api/dividend/${symbol}`);
                    
                    if (divResponse.status === 404) {
                        log(`  âœ… ${symbol}: é™¤æ¬Šæ¯ API æ­£ç¢ºè¿”å› 404ï¼ˆç„¡è‚¡æ¯è³‡æ–™ï¼‰`);
                    } else if (divResponse.ok) {
                        const divData = await divResponse.json();
                        log(`  âœ… ${symbol}: é™¤æ¬Šæ¯ API æˆåŠŸï¼Œ${divData.dividends?.length || 0} ç­†è¨˜éŒ„`);
                    } else {
                        log(`  âš ï¸ ${symbol}: é™¤æ¬Šæ¯ API éé æœŸç‹€æ…‹ ${divResponse.status}`);
                    }
                    
                    // 2. æ¸¬è©¦è‚¡åƒ¹ API
                    log(`  ğŸ” èª¿ç”¨è‚¡åƒ¹ API: /api/stock/${symbol}`);
                    const priceResponse = await fetch(`http://localhost:3001/api/stock/${symbol}`);
                    
                    if (priceResponse.ok) {
                        const priceData = await priceResponse.json();
                        log(`  âœ… ${symbol}: è‚¡åƒ¹ API æˆåŠŸï¼Œåƒ¹æ ¼ ${priceData.price} (${priceData.source})`);
                    } else {
                        log(`  âŒ ${symbol}: è‚¡åƒ¹ API å¤±æ•— ${priceResponse.status}`);
                    }
                    
                    // 3. æ¨¡æ“¬å®Œæ•´çš„æ›´æ–°æµç¨‹
                    log(`  ğŸ”„ æ¨¡æ“¬å®Œæ•´æ›´æ–°æµç¨‹...`);
                    
                    // æ¨¡æ“¬ updateStockDividendData çš„é‚è¼¯
                    try {
                        // é€™è£¡æ¨¡æ“¬é™¤æ¬Šæ¯è™•ç†å¯èƒ½å¤±æ•—çš„æƒ…æ³
                        if (divResponse.status === 404) {
                            // æ¨¡æ“¬ DividendApiService.getHistoricalDividends è¿”å›ç©ºé™£åˆ—
                            log(`  â„¹ï¸ ${symbol}: é™¤æ¬Šæ¯è™•ç†è¿”å›ç©ºé™£åˆ—ï¼ˆæ­£å¸¸ï¼‰`);
                        }
                        
                        // é—œéµï¼šå³ä½¿é™¤æ¬Šæ¯è™•ç†æœ‰å•é¡Œï¼Œè‚¡åƒ¹æ›´æ–°æ‡‰è©²ç¹¼çºŒ
                        log(`  âœ… ${symbol}: æ›´æ–°æµç¨‹å®Œæˆï¼Œé™¤æ¬Šæ¯å•é¡Œä¸å½±éŸ¿è‚¡åƒ¹æ›´æ–°`);
                        
                    } catch (error) {
                        log(`  âš ï¸ ${symbol}: é™¤æ¬Šæ¯è™•ç†ç•°å¸¸ï¼Œä½†å·²è¢«æ•ç² - ${error.message}`);
                    }
                    
                } catch (error) {
                    log(`  âŒ ${symbol}: æ¸¬è©¦éç¨‹ç•°å¸¸ - ${error.message}`);
                }
            }
            
            log('\nğŸ¯ æ¸¬è©¦ç¸½çµï¼š');
            log('âœ… é—œéµä¿®å¾©é»ï¼š');
            log('  1. updateStockDividendData ä½¿ç”¨ try-catch åŒ…è£é™¤æ¬Šæ¯è™•ç†');
            log('  2. é™¤æ¬Šæ¯è™•ç†å¤±æ•—æ™‚ä½¿ç”¨ logger.warn è€Œéæ‹‹å‡ºéŒ¯èª¤');
            log('  3. updateAllStockPrices å°‡é™¤æ¬Šæ¯è™•ç†æ”¾åœ¨ç¨ç«‹çš„ try-catch ä¸­');
            log('  4. ç¢ºä¿è‚¡åƒ¹æ›´æ–°æˆåŠŸå¾Œï¼Œé™¤æ¬Šæ¯å¤±æ•—ä¸å½±éŸ¿çµæœ');
            
            log('\nğŸ“‹ ç”¨æˆ¶æ“ä½œé©—è­‰ï¼š');
            log('  è«‹åœ¨ä¸»æ‡‰ç”¨ä¸­é»æ“Šã€ŒğŸ”„ æ›´æ–°è‚¡åƒ¹ã€æŒ‰éˆ•');
            log('  è§€å¯Ÿ Console æ—¥èªŒï¼Œæ‡‰è©²çœ‹åˆ°ï¼š');
            log('  - é™¤æ¬Šæ¯ 404 éŒ¯èª¤çš„è­¦å‘Šè¨Šæ¯');
            log('  - ä½†è‚¡åƒ¹æ›´æ–°ä»ç„¶æˆåŠŸå®Œæˆ');
            log('  - UI æ­£å¸¸é¡¯ç¤ºæ›´æ–°å¾Œçš„è‚¡åƒ¹');
            
            log('\nâœ… æ¸¬è©¦å®Œæˆï¼');
        }

        // é é¢è¼‰å…¥æ™‚çš„èªªæ˜
        window.addEventListener('load', () => {
            console.log('ğŸ”§ é™¤æ¬Šæ¯ä¿®å¾©æ¸¬è©¦é é¢è¼‰å…¥å®Œæˆ');
            console.log('ğŸ“‹ ä¿®å¾©ç‰ˆæœ¬ï¼šv1.0.2.0380');
            console.log('ğŸ¯ ä¿®å¾©ç›®æ¨™ï¼šé™¤æ¬Šæ¯è™•ç†å¤±æ•—ä¸ä¸­æ–·è‚¡åƒ¹æ›´æ–°æµç¨‹');
        });
    </script>
</body>
</html>