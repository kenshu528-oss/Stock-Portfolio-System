<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚è‚¡åƒ¹èª¿è©¦æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e293b;
            color: #e2e8f0;
        }
        .test-section {
            background: #334155;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        .result {
            background: #0f172a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .warning { border-left: 4px solid #f59e0b; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
    </style>
</head>
<body>
    <h1>ğŸ” å³æ™‚è‚¡åƒ¹èª¿è©¦æ¸¬è©¦</h1>
    <p>è¨ºæ–·å¦‚ä½•ç²å–å³æ™‚è‚¡åƒ¹è€Œéæ”¶ç›¤åƒ¹</p>

    <div class="test-section">
        <h2>æ¸¬è©¦ 1ï¼šç›´æ¥æ¸¬è©¦ Yahoo Finance API</h2>
        <button onclick="testYahooDirectly()">ç›´æ¥æ¸¬è©¦ Yahoo Finance API (4585)</button>
        <div id="yahoo-direct-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 2ï¼šæ¸¬è©¦ä¸åŒçš„ Yahoo Finance ç«¯é»</h2>
        <button onclick="testDifferentYahooEndpoints()">æ¸¬è©¦ä¸åŒç«¯é»ç²å–å³æ™‚åƒ¹æ ¼</button>
        <div id="yahoo-endpoints-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 3ï¼šæ¸¬è©¦ Vercel API çš„ä¸åŒåƒæ•¸</h2>
        <button onclick="testVercelWithParams()">æ¸¬è©¦ Vercel API ä¸åŒåƒæ•¸</button>
        <div id="vercel-params-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 4ï¼šæ¯”è¼ƒæœ¬æ©Ÿç«¯ vs é›²ç«¯è‚¡åƒ¹</h2>
        <button onclick="compareLocalVsCloud()">æ¯”è¼ƒæœ¬æ©Ÿç«¯èˆ‡é›²ç«¯è‚¡åƒ¹</button>
        <div id="compare-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 5ï¼šæ¸¬è©¦è­‰äº¤æ‰€å³æ™‚ API</h2>
        <button onclick="testTWSERealtimeAPI()">æ¸¬è©¦è­‰äº¤æ‰€å³æ™‚è‚¡åƒ¹ API</button>
        <div id="twse-result" class="result"></div>
    </div>

    <script>
        // æ¸¬è©¦ 1ï¼šç›´æ¥æ¸¬è©¦ Yahoo Finance API
        async function testYahooDirectly() {
            const resultDiv = document.getElementById('yahoo-direct-result');
            resultDiv.textContent = 'æ­£åœ¨ç›´æ¥æ¸¬è©¦ Yahoo Finance API...';
            
            try {
                // æ¸¬è©¦ä¸åŒçš„å¾Œç¶´
                const symbols = ['4585.TW', '4585.TWO'];
                const results = [];
                
                for (const symbol of symbols) {
                    try {
                        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
                        const response = await fetch(url, {
                            headers: {
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const result = data?.chart?.result?.[0];
                            
                            if (result?.meta) {
                                results.push({
                                    symbol,
                                    regularMarketPrice: result.meta.regularMarketPrice,
                                    previousClose: result.meta.previousClose,
                                    marketState: result.meta.marketState,
                                    exchangeTimezoneName: result.meta.exchangeTimezoneName,
                                    regularMarketTime: result.meta.regularMarketTime,
                                    currentTradingPeriod: result.meta.currentTradingPeriod
                                });
                            }
                        }
                    } catch (error) {
                        results.push({
                            symbol,
                            error: error.message
                        });
                    }
                }
                
                resultDiv.textContent = `Yahoo Finance API ç›´æ¥æ¸¬è©¦çµæœï¼š
${results.map(r => `
${r.symbol}:
${r.error ? `éŒ¯èª¤: ${r.error}` : `
  å³æ™‚åƒ¹æ ¼: ${r.regularMarketPrice}
  æ”¶ç›¤åƒ¹: ${r.previousClose}
  å¸‚å ´ç‹€æ…‹: ${r.marketState}
  æ™‚å€: ${r.exchangeTimezoneName}
  å¸‚å ´æ™‚é–“: ${new Date(r.regularMarketTime * 1000).toLocaleString()}
  äº¤æ˜“æ™‚æ®µ: ${JSON.stringify(r.currentTradingPeriod, null, 2)}`}
`).join('\n')}

åˆ†æï¼š
- regularMarketPrice æ‡‰è©²æ˜¯å³æ™‚åƒ¹æ ¼
- marketState é¡¯ç¤ºå¸‚å ´ç‹€æ…‹ (REGULAR, CLOSED, PRE, POST)
- å¦‚æœ regularMarketPrice = previousCloseï¼Œå¯èƒ½å¸‚å ´å·²æ”¶ç›¤`;
                
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent = `Yahoo Finance API ç›´æ¥æ¸¬è©¦éŒ¯èª¤: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // æ¸¬è©¦ 2ï¼šæ¸¬è©¦ä¸åŒçš„ Yahoo Finance ç«¯é»
        async function testDifferentYahooEndpoints() {
            const resultDiv = document.getElementById('yahoo-endpoints-result');
            resultDiv.textContent = 'æ­£åœ¨æ¸¬è©¦ä¸åŒçš„ Yahoo Finance ç«¯é»...';
            
            const endpoints = [
                {
                    name: 'Chart API (v8)',
                    url: 'https://query1.finance.yahoo.com/v8/finance/chart/4585.TW'
                },
                {
                    name: 'Quote API (v7)',
                    url: 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=4585.TW'
                },
                {
                    name: 'Spark API',
                    url: 'https://query1.finance.yahoo.com/v7/finance/spark?symbols=4585.TW'
                }
            ];
            
            const results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.url, {
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        results.push({
                            name: endpoint.name,
                            success: true,
                            data: JSON.stringify(data, null, 2).substring(0, 500) + '...'
                        });
                    } else {
                        results.push({
                            name: endpoint.name,
                            success: false,
                            error: `HTTP ${response.status}`
                        });
                    }
                } catch (error) {
                    results.push({
                        name: endpoint.name,
                        success: false,
                        error: error.message
                    });
                }
            }
            
            resultDiv.textContent = `ä¸åŒ Yahoo Finance ç«¯é»æ¸¬è©¦çµæœï¼š
${results.map(r => `
${r.name}:
${r.success ? `æˆåŠŸ - æ•¸æ“šé è¦½:\n${r.data}` : `å¤±æ•— - ${r.error}`}
`).join('\n')}`;
            
            resultDiv.className = 'result success';
        }

        // æ¸¬è©¦ 3ï¼šæ¸¬è©¦ Vercel API çš„ä¸åŒåƒæ•¸
        async function testVercelWithParams() {
            const resultDiv = document.getElementById('vercel-params-result');
            resultDiv.textContent = 'æ­£åœ¨æ¸¬è©¦ Vercel API ä¸åŒåƒæ•¸...';
            
            const testCases = [
                {
                    name: 'åŸºæœ¬èª¿ç”¨',
                    url: 'https://vercel-stock-api.vercel.app/api/stock-price?symbol=4585'
                },
                {
                    name: 'å¼·åˆ¶åˆ·æ–°',
                    url: `https://vercel-stock-api.vercel.app/api/stock-price?symbol=4585&_t=${Date.now()}`
                },
                {
                    name: 'æŒ‡å®šå¾Œç¶´ .TW',
                    url: 'https://vercel-stock-api.vercel.app/api/stock-price?symbol=4585.TW'
                },
                {
                    name: 'æŒ‡å®šå¾Œç¶´ .TWO',
                    url: 'https://vercel-stock-api.vercel.app/api/stock-price?symbol=4585.TWO'
                }
            ];
            
            const results = [];
            
            for (const testCase of testCases) {
                try {
                    const response = await fetch(testCase.url);
                    const data = await response.json();
                    
                    results.push({
                        name: testCase.name,
                        success: response.ok,
                        price: data.price,
                        source: data.source,
                        timestamp: data.timestamp,
                        fullSymbol: data.fullSymbol,
                        error: data.error
                    });
                } catch (error) {
                    results.push({
                        name: testCase.name,
                        success: false,
                        error: error.message
                    });
                }
            }
            
            resultDiv.textContent = `Vercel API ä¸åŒåƒæ•¸æ¸¬è©¦çµæœï¼š
${results.map(r => `
${r.name}:
${r.success ? `
  åƒ¹æ ¼: ${r.price}
  ä¾†æº: ${r.source}
  å®Œæ•´ä»£è™Ÿ: ${r.fullSymbol}
  æ™‚é–“æˆ³: ${r.timestamp}` : `
  éŒ¯èª¤: ${r.error}`}
`).join('\n')}

åˆ†æï¼š
- æª¢æŸ¥ä¸åŒå¾Œç¶´æ˜¯å¦å½±éŸ¿åƒ¹æ ¼
- æª¢æŸ¥æ™‚é–“æˆ³åƒæ•¸æ˜¯å¦å¼·åˆ¶åˆ·æ–°
- æ¯”è¼ƒåƒ¹æ ¼å·®ç•°`;
            
            resultDiv.className = 'result success';
        }

        // æ¸¬è©¦ 4ï¼šæ¯”è¼ƒæœ¬æ©Ÿç«¯ vs é›²ç«¯è‚¡åƒ¹
        async function compareLocalVsCloud() {
            const resultDiv = document.getElementById('compare-result');
            resultDiv.textContent = 'æ­£åœ¨æ¯”è¼ƒæœ¬æ©Ÿç«¯èˆ‡é›²ç«¯è‚¡åƒ¹...';
            
            try {
                // æ¸¬è©¦æœ¬æ©Ÿç«¯ APIï¼ˆå¦‚æœå¯ç”¨ï¼‰
                let localResult = null;
                try {
                    const localResponse = await fetch('http://localhost:3001/api/stock/4585');
                    if (localResponse.ok) {
                        localResult = await localResponse.json();
                    }
                } catch (error) {
                    localResult = { error: 'æœ¬æ©Ÿç«¯ API ä¸å¯ç”¨' };
                }
                
                // æ¸¬è©¦é›²ç«¯ API
                const cloudResponse = await fetch('https://vercel-stock-api.vercel.app/api/stock-price?symbol=4585');
                const cloudResult = await cloudResponse.json();
                
                resultDiv.textContent = `æœ¬æ©Ÿç«¯ vs é›²ç«¯è‚¡åƒ¹æ¯”è¼ƒï¼š

æœ¬æ©Ÿç«¯çµæœ:
${localResult.error ? `éŒ¯èª¤: ${localResult.error}` : `
  åƒ¹æ ¼: ${localResult.price}
  ä¾†æº: ${localResult.source}
  æ™‚é–“æˆ³: ${localResult.timestamp}`}

é›²ç«¯çµæœ:
${cloudResult.error ? `éŒ¯èª¤: ${cloudResult.error}` : `
  åƒ¹æ ¼: ${cloudResult.price}
  ä¾†æº: ${cloudResult.source}
  æ™‚é–“æˆ³: ${cloudResult.timestamp}`}

åˆ†æ:
${!localResult.error && !cloudResult.error ? `
  åƒ¹æ ¼å·®ç•°: ${Math.abs(localResult.price - cloudResult.price).toFixed(2)}
  æœ¬æ©Ÿç«¯æ›´æ–°: ${localResult.price > cloudResult.price ? 'è¼ƒæ–°' : 'è¼ƒèˆŠ'}
  ${localResult.price === cloudResult.price ? 'âœ… åƒ¹æ ¼ä¸€è‡´' : 'âš ï¸ åƒ¹æ ¼ä¸ä¸€è‡´'}` : 'ç„¡æ³•æ¯”è¼ƒ'}`;
                
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent = `æ¯”è¼ƒæ¸¬è©¦éŒ¯èª¤: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // æ¸¬è©¦ 5ï¼šæ¸¬è©¦è­‰äº¤æ‰€å³æ™‚ API
        async function testTWSERealtimeAPI() {
            const resultDiv = document.getElementById('twse-result');
            resultDiv.textContent = 'æ­£åœ¨æ¸¬è©¦è­‰äº¤æ‰€å³æ™‚è‚¡åƒ¹ API...';
            
            try {
                // è­‰äº¤æ‰€å³æ™‚è‚¡åƒ¹ API
                const twseUrl = 'https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=tse_4585.tw';
                
                const response = await fetch(twseUrl, {
                    headers: {
                        'Accept': 'application/json',
                        'Referer': 'https://mis.twse.com.tw/'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.msgArray && data.msgArray.length > 0) {
                        const stockData = data.msgArray[0];
                        
                        resultDiv.textContent = `è­‰äº¤æ‰€å³æ™‚ API çµæœï¼š
è‚¡ç¥¨ä»£è™Ÿ: ${stockData.c}
è‚¡ç¥¨åç¨±: ${stockData.n}
ç¾åƒ¹: ${stockData.z}
é–‹ç›¤åƒ¹: ${stockData.o}
æœ€é«˜åƒ¹: ${stockData.h}
æœ€ä½åƒ¹: ${stockData.l}
æ˜¨æ”¶åƒ¹: ${stockData.y}
æ¼²è·Œ: ${stockData.z - stockData.y}
æ¼²è·Œå¹…: ${((stockData.z - stockData.y) / stockData.y * 100).toFixed(2)}%
æˆäº¤é‡: ${stockData.v}
æ™‚é–“: ${stockData.t}

åŸå§‹æ•¸æ“š:
${JSON.stringify(stockData, null, 2)}

åˆ†æ:
- é€™æ˜¯è­‰äº¤æ‰€çš„å³æ™‚æ•¸æ“š
- z æ¬„ä½æ˜¯ç¾åƒ¹ï¼ˆå³æ™‚åƒ¹æ ¼ï¼‰
- y æ¬„ä½æ˜¯æ˜¨æ”¶åƒ¹
- å¦‚æœ z = yï¼Œè¡¨ç¤ºè‚¡åƒ¹æ²’æœ‰è®Šå‹•æˆ–å¸‚å ´æœªé–‹ç›¤`;
                        
                        resultDiv.className = 'result success';
                    } else {
                        resultDiv.textContent = 'è­‰äº¤æ‰€ API è¿”å›ç©ºæ•¸æ“š';
                        resultDiv.className = 'result warning';
                    }
                } else {
                    resultDiv.textContent = `è­‰äº¤æ‰€ API éŒ¯èª¤: HTTP ${response.status}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.textContent = `è­‰äº¤æ‰€ API æ¸¬è©¦éŒ¯èª¤: ${error.message}
                
æ³¨æ„: è­‰äº¤æ‰€ API å¯èƒ½æœ‰ CORS é™åˆ¶ï¼Œåœ¨ç€è¦½å™¨ä¸­ç„¡æ³•ç›´æ¥èª¿ç”¨`;
                resultDiv.className = 'result error';
            }
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºç•¶å‰æ™‚é–“å’Œå¸‚å ´ç‹€æ…‹
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const currentTime = hour * 60 + minute;
            const marketOpen = 9 * 60; // 09:00
            const marketClose = 13 * 60 + 30; // 13:30
            const isMarketHours = currentTime >= marketOpen && currentTime <= marketClose;
            const isWeekday = now.getDay() >= 1 && now.getDay() <= 5;
            const isMarketOpen = isMarketHours && isWeekday;
            
            console.log('å³æ™‚è‚¡åƒ¹èª¿è©¦æ¸¬è©¦é é¢å·²è¼‰å…¥');
            console.log('ç•¶å‰æ™‚é–“:', now.toLocaleString());
            console.log('å¸‚å ´ç‹€æ…‹:', isMarketOpen ? 'é–‹ç›¤ä¸­' : 'ä¼‘å¸‚ä¸­');
            
            // åœ¨é é¢é ‚éƒ¨é¡¯ç¤ºå¸‚å ´ç‹€æ…‹
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = 'background: #1e40af; color: white; padding: 10px; margin-bottom: 20px; border-radius: 4px; text-align: center;';
            statusDiv.textContent = `ç•¶å‰æ™‚é–“: ${now.toLocaleString()} | å¸‚å ´ç‹€æ…‹: ${isMarketOpen ? 'ğŸŸ¢ é–‹ç›¤ä¸­' : 'ğŸ”´ ä¼‘å¸‚ä¸­'}`;
            document.body.insertBefore(statusDiv, document.body.firstChild);
        });
    </script>
</body>
</html>