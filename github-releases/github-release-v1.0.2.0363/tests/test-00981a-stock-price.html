<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦ 00981A è‚¡åƒ¹ç²å–</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <h1>æ¸¬è©¦ 00981A è‚¡åƒ¹ç²å–</h1>
    <p>æ¸¬è©¦ä¿®å¾©å¾Œçš„é›²ç«¯è‚¡åƒ¹æœå‹™æ˜¯å¦èƒ½æˆåŠŸç²å– 00981A çš„è‚¡åƒ¹</p>
    
    <button onclick="testStockPrice()">æ¸¬è©¦ 00981A è‚¡åƒ¹</button>
    <button onclick="testMultipleSources()">æ¸¬è©¦å¤šå€‹è³‡æ–™æº</button>
    
    <div id="results"></div>

    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        // ç²å– Yahoo Finance ç¬¦è™Ÿ
        function getYahooSymbol(symbol) {
            if (symbol.includes('.')) return symbol;

            const code = parseInt(symbol.substring(0, 4));
            const isBondETF = /^00\d{2,3}B$/i.test(symbol);
            const isETF = /^00\d{2,3}[A-Z]?$/i.test(symbol);

            // ç‰¹æ®Šæ¡ˆä¾‹è™•ç†
            const specialCases = {
                '8112': '.TW',
                '4585': '.TW',
            };
            
            if (specialCases[symbol]) {
                return `${symbol}${specialCases[symbol]}`;
            }

            // å‚µåˆ¸ ETFï¼šå„ªå…ˆæ«ƒè²·ä¸­å¿ƒ
            if (isBondETF) {
                return `${symbol}.TWO`;
            }
            
            // ä¸€èˆ¬ ETFï¼šå„ªå…ˆæ«ƒè²·ä¸­å¿ƒ
            if (isETF) {
                return `${symbol}.TWO`;
            }
            
            // ä¸Šæ«ƒè‚¡ç¥¨ï¼ˆ3000-8999ï¼‰ï¼šå„ªå…ˆæ«ƒè²·ä¸­å¿ƒ
            if (code >= 3000 && code <= 8999) {
                return `${symbol}.TWO`;
            }
            
            // ä¸Šå¸‚è‚¡ç¥¨ï¼ˆ1000-2999ï¼‰ï¼šå„ªå…ˆè­‰äº¤æ‰€
            return `${symbol}.TW`;
        }

        async function testYahooFinanceViaProxy(symbol, proxyName, proxyUrl) {
            const yahooSymbol = getYahooSymbol(symbol);
            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}`;
            
            try {
                addResult(`ğŸ” æ¸¬è©¦ ${proxyName}: ${yahooSymbol}`, 'info');
                
                const response = await fetch(proxyUrl + encodeURIComponent(yahooUrl));
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                let yahooData;
                if (proxyName === 'AllOrigins') {
                    const data = await response.json();
                    yahooData = JSON.parse(data.contents);
                } else {
                    yahooData = await response.json();
                }
                
                const result = yahooData?.chart?.result?.[0];
                if (result?.meta) {
                    const price = result.meta.regularMarketPrice || result.meta.previousClose || 0;
                    const previousClose = result.meta.previousClose || 0;
                    const change = price - previousClose;
                    const changePercent = previousClose > 0 ? (change / previousClose) * 100 : 0;
                    const name = result.meta.longName || result.meta.shortName || symbol;

                    if (price > 0) {
                        addResult(
                            `âœ… ${proxyName} æˆåŠŸ: ${yahooSymbol}<br>` +
                            `è‚¡ç¥¨åç¨±: ${name}<br>` +
                            `è‚¡åƒ¹: ${price}<br>` +
                            `æ¼²è·Œ: ${change.toFixed(2)} (${changePercent.toFixed(2)}%)`,
                            'success'
                        );
                        return { success: true, price, name, source: proxyName };
                    }
                }
                
                throw new Error('ç„¡æœ‰æ•ˆè‚¡åƒ¹è³‡æ–™');
                
            } catch (error) {
                addResult(`âŒ ${proxyName} å¤±æ•—: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function testStockPrice() {
            addResult('ğŸ§ª é–‹å§‹æ¸¬è©¦ 00981A è‚¡åƒ¹ç²å–...', 'info');
            
            const symbol = '00981A';
            const yahooSymbol = getYahooSymbol(symbol);
            
            addResult(`ğŸ“Š è‚¡ç¥¨ä»£ç¢¼: ${symbol} â†’ Yahoo ç¬¦è™Ÿ: ${yahooSymbol}`, 'info');
            
            // æ¸¬è©¦ AllOrigins ä»£ç†
            const result = await testYahooFinanceViaProxy(
                symbol, 
                'AllOrigins', 
                'https://api.allorigins.win/get?url='
            );
            
            if (result.success) {
                addResult('ğŸ‰ 00981A è‚¡åƒ¹ç²å–æˆåŠŸï¼å•é¡Œå·²ä¿®å¾©ã€‚', 'success');
            } else {
                addResult('âš ï¸ 00981A è‚¡åƒ¹ç²å–ä»ç„¶å¤±æ•—ï¼Œéœ€è¦é€²ä¸€æ­¥èª¿æŸ¥ã€‚', 'error');
            }
        }

        async function testMultipleSources() {
            addResult('ğŸ” æ¸¬è©¦å¤šå€‹è³‡æ–™æº...', 'info');
            
            const symbol = '00981A';
            const proxies = [
                { name: 'AllOrigins', url: 'https://api.allorigins.win/get?url=' },
                { name: 'CodeTabs', url: 'https://api.codetabs.com/v1/proxy?quest=' },
                { name: 'ThingProxy', url: 'https://thingproxy.freeboard.io/fetch/' }
            ];
            
            for (const proxy of proxies) {
                await testYahooFinanceViaProxy(symbol, proxy.name, proxy.url);
                // ç­‰å¾…ä¸€ä¸‹é¿å…è«‹æ±‚éå¿«
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
    </script>
</body>
</html>