# 雲端 API 驗證任務清單 (Cloud API Validation Tasks)

> **建立日期**: 2026-01-28  
> **版本**: v1.0.2.0348  
> **目標**: 驗證雲端股價、配股、配息獲取的穩定性，制定最佳策略

## 🎯 任務概述

### 核心問題
- **CORS 限制**: Yahoo Finance 和 FinMind 在雲端環境的跨域問題
- **即時 vs 盤後**: 證交所盤後資料無 CORS，但即時資料有限制
- **穩定性**: 需要找出最可靠的雲端股價獲取方案

### 驗證工具
- **測試網頁**: `test-cloud-api-validation.html`
- **測試環境**: 獨立於主程式，安全測試
- **測試範圍**: 股價、配股、配息、錯誤處理

---

## 📋 詳細任務清單

### 🔴 高優先級任務

#### Task 1: 證交所盤後資料驗證 ⭐⭐⭐
**狀態**: 🟡 待執行  
**預估時間**: 30 分鐘  
**負責人**: 開發者  

**驗證項目**:
- [ ] 上市股票 (2330 台積電) 盤後資料獲取
- [ ] 上櫃股票 (6188 廣明) 盤後資料獲取
- [ ] ETF (0050 元大台灣50) 盤後資料獲取
- [ ] 債券 ETF (00679B 元大美債20年) 盤後資料獲取
- [ ] 興櫃股票 (4585 達明) 盤後資料獲取

**API 端點**:
```
上市: https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date={YYYYMMDD}&stockNo={symbol}
上櫃: https://www.tpex.org.tw/web/stock/aftertrading/daily_close_quotes/stk_quote_result.php?l=zh-tw&d={YYY/MM/DD}&stkno={symbol}
```

**成功標準**:
- ✅ 無 CORS 錯誤
- ✅ 回應時間 < 3 秒
- ✅ 資料格式正確
- ✅ 涵蓋所有股票類型

**風險評估**: 🟢 低風險 - 證交所官方 API，穩定性高

---

#### Task 2: 即時股價 CORS 問題驗證 ⭐⭐⭐
**狀態**: 🟡 待執行  
**預估時間**: 20 分鐘  
**負責人**: 開發者  

**驗證項目**:
- [ ] Yahoo Finance API 直接調用 CORS 測試
- [ ] FinMind API 直接調用 CORS 測試
- [ ] 證交所即時 API CORS 測試
- [ ] 各 API 的錯誤訊息分析

**測試 URL**:
```
Yahoo: https://query1.finance.yahoo.com/v8/finance/chart/2330.TW
FinMind: https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockInfo&data_id=2330
證交所: https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=tse_2330.tw
```

**成功標準**:
- ✅ 明確識別哪些 API 有 CORS 限制
- ✅ 記錄具體的錯誤訊息
- ✅ 確認瀏覽器端的限制範圍

**風險評估**: 🟡 中風險 - 可能影響雲端架構設計

---

### 🟡 中優先級任務

#### Task 3: Vercel Edge Functions 穩定性測試 ⭐⭐
**狀態**: 🟡 待執行  
**預估時間**: 25 分鐘  
**負責人**: 開發者  

**驗證項目**:
- [ ] 單次請求成功率測試
- [ ] 連續 10 次請求性能測試
- [ ] 不同股票代碼的支援度測試
- [ ] 回應時間統計分析

**測試股票**:
- 2330 (台積電)
- 6188 (廣明)
- 0050 (元大台灣50)

**成功標準**:
- ✅ 成功率 > 95%
- ✅ 平均回應時間 < 2 秒
- ✅ 支援各種股票類型
- ✅ 錯誤處理機制完善

**風險評估**: 🟡 中風險 - 依賴第三方服務

---

#### Task 4: Yahoo Finance 代理服務比較 ⭐⭐
**狀態**: 🟡 待執行  
**預估時間**: 30 分鐘  
**負責人**: 開發者  

**驗證項目**:
- [ ] AllOrigins 代理服務測試
- [ ] CodeTabs 代理服務測試
- [ ] ThingProxy 代理服務測試
- [ ] 各代理服務穩定性比較

**比較指標**:
- 成功率
- 回應時間
- 資料完整性
- 服務穩定性

**成功標準**:
- ✅ 至少 2 個代理服務可用
- ✅ 找出最穩定的代理方案
- ✅ 建立代理優先順序

**風險評估**: 🔴 高風險 - 第三方代理服務不穩定

---

### 🟢 低優先級任務

#### Task 5: FinMind API 完整性驗證 ⭐
**狀態**: 🟡 待執行  
**預估時間**: 20 分鐘  
**負責人**: 開發者  

**驗證項目**:
- [ ] 股價查詢功能測試
- [ ] 股票資訊查詢測試
- [ ] 除權息資料查詢測試
- [ ] API 限制和配額測試

**測試資料集**:
- TaiwanStockPrice (股價)
- TaiwanStockInfo (股票資訊)
- TaiwanStockDividend (除權息)

**成功標準**:
- ✅ 各資料集正常回應
- ✅ 資料完整性良好
- ✅ 無明顯 API 限制

**風險評估**: 🟢 低風險 - 已知可用的 API

---

#### Task 6: 除權息資料完整性測試 ⭐
**狀態**: 🟡 待執行  
**預估時間**: 25 分鐘  
**負責人**: 開發者  

**驗證項目**:
- [ ] 一般股票除權息資料 (2330, 2886)
- [ ] ETF 配息資料 (0050)
- [ ] 債券 ETF 配息資料 (00679B)
- [ ] 歷史資料完整性檢查

**資料驗證**:
- 現金股利計算正確性
- 股票股利計算正確性
- 除權息日期準確性
- 資料時間範圍

**成功標準**:
- ✅ 資料計算邏輯正確
- ✅ 涵蓋足夠的歷史範圍
- ✅ 特殊股票類型支援

**風險評估**: 🟢 低風險 - 資料驗證為主

---

#### Task 7: 混合時段策略驗證 ⭐
**狀態**: 🟡 待執行  
**預估時間**: 15 分鐘  
**負責人**: 開發者  

**驗證項目**:
- [ ] 盤中時段 (9:00-13:30) 最佳策略
- [ ] 盤後時段 (13:30-9:00) 最佳策略
- [ ] 假日時段最佳策略
- [ ] 時段切換邏輯驗證

**策略定義**:
```
盤中: Vercel → Yahoo 代理 → 證交所即時
盤後: 證交所盤後 → Vercel → FinMind
假日: 證交所盤後 → FinMind 歷史
```

**成功標準**:
- ✅ 時段判斷邏輯正確
- ✅ 策略優先順序合理
- ✅ 無縫切換機制

**風險評估**: 🟢 低風險 - 邏輯驗證為主

---

#### Task 8: 錯誤處理與備援機制測試 ⭐
**狀態**: 🟡 待執行  
**預估時間**: 20 分鐘  
**負責人**: 開發者  

**驗證項目**:
- [ ] 請求超時錯誤處理
- [ ] HTTP 404 錯誤處理
- [ ] 網路連線錯誤處理
- [ ] 備援機制自動切換

**錯誤場景**:
- API 超時 (> 10 秒)
- 股票代碼不存在 (404)
- 網路連線中斷
- API 服務暫停

**成功標準**:
- ✅ 所有錯誤都能正確捕獲
- ✅ 備援機制自動啟動
- ✅ 用戶友好的錯誤訊息

**風險評估**: 🟢 低風險 - 錯誤處理測試

---

## 📊 執行計劃

### 🕐 時間安排
```
總預估時間: 3 小時
建議分配:
- 上午 (1.5 小時): Task 1, 2, 3
- 下午 (1.5 小時): Task 4, 5, 6, 7, 8
```

### 📋 執行順序
1. **Task 1** (證交所盤後) - 最重要，確認基礎可行性
2. **Task 2** (CORS 驗證) - 影響架構設計
3. **Task 3** (Vercel 穩定性) - 主要雲端方案
4. **Task 4** (代理服務) - 備援方案
5. **Task 5-8** (其他驗證) - 補充驗證

### 🎯 成功標準
- **必須通過**: Task 1, 2, 3
- **建議通過**: Task 4, 5
- **可選通過**: Task 6, 7, 8

---

## 📈 預期結果與決策

### 🎯 最佳情況
- 證交所盤後資料完全可用 ✅
- Vercel Edge Functions 穩定可靠 ✅
- 至少 1 個代理服務可用 ✅

**結論**: 採用混合時段策略
```
盤後: 證交所官方資料 (首選)
盤中: Vercel Edge Functions (首選)
備援: 最穳定的代理服務
```

### ⚠️ 中等情況
- 證交所盤後資料可用 ✅
- Vercel 不穩定 ❌
- 代理服務部分可用 ⚠️

**結論**: 以證交所為主，代理為輔
```
主要: 證交所盤後資料
備援: 最穩定的代理服務
說明: 盤中資料可能延遲
```

### 🚨 最壞情況
- 多數 API 都有 CORS 問題 ❌
- 代理服務不穩定 ❌

**結論**: 需要重新設計架構
```
方案 1: 完全依賴 Netlify Functions
方案 2: 建立自己的代理服務
方案 3: 只提供盤後資料
```

---

## 🔧 測試工具使用

### 📱 測試網頁操作
1. 開啟 `test-cloud-api-validation.html`
2. 按照任務順序執行測試
3. 記錄每個測試的結果
4. 生成完整測試報告

### 📊 結果記錄
- **成功**: 綠色 ✅ 
- **警告**: 黃色 ⚠️
- **失敗**: 紅色 ❌

### 📋 報告格式
```json
{
  "timestamp": "2026-01-28T10:00:00Z",
  "tasks": {
    "task1": { "status": "pass", "details": "..." },
    "task2": { "status": "fail", "details": "..." }
  },
  "recommendations": ["建議1", "建議2"],
  "nextSteps": ["步驟1", "步驟2"]
}
```

---

## 🎯 後續行動

### ✅ 測試完成後
1. **分析結果**: 整理所有測試數據
2. **制定策略**: 基於結果選擇最佳方案
3. **更新文檔**: 修改 API 標準規範
4. **實作改進**: 根據測試結果優化代碼

### 📝 文檔更新
- 更新 `api-standards.md` STEERING 規則
- 修改 `docs/SPECIFICATION.md` API 架構
- 記錄測試結果到 `changelog.ts`

### 🚀 實作計劃
- 根據測試結果調整雲端股價獲取邏輯
- 實作最佳的混合時段策略
- 建立完善的錯誤處理和備援機制

---

**記住**: 這次驗證的目標是找出最穩定可靠的雲端股價獲取方案，為用戶提供最佳的使用體驗！
