<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 1: è­‰äº¤æ‰€ç›¤å¾Œè³‡æ–™é©—è­‰ - v1.0.2.0348</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            background: #fafafa;
        }
        .test-buttons button { 
            margin: 5px; 
            padding: 8px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .results { 
            margin-top: 15px; 
            padding: 10px; 
            background: #f8f9fa; 
            border-radius: 4px; 
            max-height: 400px; 
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š Task 1: è­‰äº¤æ‰€ç›¤å¾Œè³‡æ–™é©—è­‰</h1>
        <p><strong>ç›®æ¨™</strong>: ç¢ºèªè­‰äº¤æ‰€ç›¤å¾Œ API ç„¡ CORS å•é¡Œï¼Œæ”¯æ´å„ç¨®è‚¡ç¥¨é¡å‹</p>
        <p><strong>æ—¥æœŸ</strong>: 2026-01-28</p>
        
        <div class="test-section">
            <h2>ğŸ¯ æ¸¬è©¦é …ç›®</h2>
            <div class="test-buttons">
                <button class="btn-primary" onclick="testTWSE('2330', 'ä¸Šå¸‚')">æ¸¬è©¦ 2330 (å°ç©é›»)</button>
                <button class="btn-primary" onclick="testTPEx('6188', 'ä¸Šæ«ƒ')">æ¸¬è©¦ 6188 (å»£æ˜)</button>
                <button class="btn-primary" onclick="testTWSE('0050', 'ETF')">æ¸¬è©¦ 0050 (å…ƒå¤§å°ç£50)</button>
                <button class="btn-primary" onclick="testTPEx('00679B', 'å‚µåˆ¸ETF')">æ¸¬è©¦ 00679B (å…ƒå¤§ç¾å‚µ20å¹´)</button>
                <button class="btn-primary" onclick="testTPEx('4585', 'èˆˆæ«ƒ')">æ¸¬è©¦ 4585 (é”æ˜)</button>
                <button class="btn-success" onclick="runAllTests()">ğŸš€ åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
                <button class="btn-danger" onclick="clearResults()">æ¸…é™¤çµæœ</button>
            </div>
            
            <div class="results" id="results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“‹ æ¸¬è©¦çµæœæ‘˜è¦</h2>
            <div id="summary">
                <p>ç­‰å¾…æ¸¬è©¦åŸ·è¡Œ...</p>
            </div>
        </div>
    </div>

    <script>
        const testResults = [];

        function addResult(message, type = 'info') {
            const container = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            container.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            container.scrollTop = container.scrollHeight;
        }

        function updateSummary() {
            const summary = document.getElementById('summary');
            const total = testResults.length;
            const passed = testResults.filter(r => r.success).length;
            const failed = total - passed;
            
            summary.innerHTML = `
                <p><strong>æ¸¬è©¦å®Œæˆ</strong>: ${total} é …</p>
                <p><strong>é€šé</strong>: <span style="color: #28a745">${passed}</span> é …</p>
                <p><strong>å¤±æ•—</strong>: <span style="color: #dc3545">${failed}</span> é …</p>
                <p><strong>æˆåŠŸç‡</strong>: ${total > 0 ? Math.round(passed/total*100) : 0}%</p>
            `;
        }

        async function testTWSE(symbol, type) {
            addResult(`ğŸ” æ¸¬è©¦è­‰äº¤æ‰€ä¸Šå¸‚è³‡æ–™: ${symbol} (${type})`, 'info');
            
            try {
                const today = new Date();
                const dateStr = today.getFullYear() + 
                    String(today.getMonth() + 1).padStart(2, '0') + 
                    String(today.getDate()).padStart(2, '0');
                
                const url = `https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=${dateStr}&stockNo=${symbol}`;
                addResult(`ğŸ“¡ è«‹æ±‚ URL: ${url}`, 'info');
                
                const startTime = Date.now();
                const response = await fetch(url);
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                addResult(`â±ï¸ å›æ‡‰æ™‚é–“: ${responseTime}ms`, responseTime < 3000 ? 'success' : 'warning');
                addResult(`ğŸ“Š HTTP ç‹€æ…‹: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`ğŸ“‹ è³‡æ–™ç‹€æ…‹: ${data.stat}`, data.stat === 'OK' ? 'success' : 'warning');
                    
                    if (data.stat === 'OK' && data.data && data.data.length > 0) {
                        const latest = data.data[data.data.length - 1];
                        const price = parseFloat(latest[6].replace(/,/g, ''));
                        addResult(`âœ… ${symbol} æ”¶ç›¤åƒ¹: $${price}`, 'success');
                        addResult(`ğŸ“… äº¤æ˜“æ—¥æœŸ: ${latest[0]}`, 'info');
                        addResult(`ğŸ“ˆ æˆäº¤é‡: ${latest[1]} è‚¡`, 'info');
                        
                        testResults.push({
                            symbol,
                            type,
                            success: true,
                            price,
                            date: latest[0],
                            responseTime,
                            source: 'TWSE'
                        });
                        
                        addResult(`ğŸ‰ ${symbol} æ¸¬è©¦æˆåŠŸï¼`, 'success');
                    } else {
                        addResult(`âš ï¸ ${symbol} ç„¡è³‡æ–™ï¼Œå¯èƒ½éœ€è¦å˜—è©¦ä¸Šæ«ƒ API`, 'warning');
                        testResults.push({
                            symbol,
                            type,
                            success: false,
                            error: 'ç„¡è³‡æ–™',
                            source: 'TWSE'
                        });
                    }
                } else {
                    addResult(`âŒ HTTP éŒ¯èª¤: ${response.status}`, 'error');
                    testResults.push({
                        symbol,
                        type,
                        success: false,
                        error: `HTTP ${response.status}`,
                        source: 'TWSE'
                    });
                }
                
            } catch (error) {
                if (error.message.includes('CORS')) {
                    addResult(`âŒ CORS éŒ¯èª¤: ${error.message}`, 'error');
                    addResult(`ğŸš¨ é‡è¦ç™¼ç¾: è­‰äº¤æ‰€ API æœ‰ CORS é™åˆ¶ï¼`, 'error');
                } else {
                    addResult(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                }
                
                testResults.push({
                    symbol,
                    type,
                    success: false,
                    error: error.message,
                    source: 'TWSE'
                });
            }
            
            updateSummary();
        }

        async function testTPEx(symbol, type) {
            addResult(`ğŸ” æ¸¬è©¦æ«ƒè²·ä¸­å¿ƒè³‡æ–™: ${symbol} (${type})`, 'info');
            
            try {
                const today = new Date();
                const year = today.getFullYear() - 1911; // æ°‘åœ‹å¹´
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const dateStr = `${year}/${month}/${day}`;
                
                const url = `https://www.tpex.org.tw/web/stock/aftertrading/daily_close_quotes/stk_quote_result.php?l=zh-tw&d=${dateStr}&stkno=${symbol}`;
                addResult(`ğŸ“¡ è«‹æ±‚ URL: ${url}`, 'info');
                
                const startTime = Date.now();
                const response = await fetch(url);
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                addResult(`â±ï¸ å›æ‡‰æ™‚é–“: ${responseTime}ms`, responseTime < 3000 ? 'success' : 'warning');
                addResult(`ğŸ“Š HTTP ç‹€æ…‹: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`ğŸ“‹ è³‡æ–™æ ¼å¼: ${data.aaData ? 'OK' : 'ERROR'}`, data.aaData ? 'success' : 'error');
                    
                    if (data.aaData && data.aaData.length > 0) {
                        const stockData = data.aaData[0];
                        const price = parseFloat(stockData[2]);
                        addResult(`âœ… ${symbol} æ”¶ç›¤åƒ¹: $${price}`, 'success');
                        addResult(`ğŸ“Š è‚¡ç¥¨åç¨±: ${stockData[1]}`, 'info');
                        addResult(`ğŸ“ˆ æˆäº¤é‡: ${stockData[7]} è‚¡`, 'info');
                        
                        testResults.push({
                            symbol,
                            type,
                            success: true,
                            price,
                            name: stockData[1],
                            responseTime,
                            source: 'TPEx'
                        });
                        
                        addResult(`ğŸ‰ ${symbol} æ¸¬è©¦æˆåŠŸï¼`, 'success');
                    } else {
                        addResult(`âš ï¸ ${symbol} ç„¡è³‡æ–™`, 'warning');
                        testResults.push({
                            symbol,
                            type,
                            success: false,
                            error: 'ç„¡è³‡æ–™',
                            source: 'TPEx'
                        });
                    }
                } else {
                    addResult(`âŒ HTTP éŒ¯èª¤: ${response.status}`, 'error');
                    testResults.push({
                        symbol,
                        type,
                        success: false,
                        error: `HTTP ${response.status}`,
                        source: 'TPEx'
                    });
                }
                
            } catch (error) {
                if (error.message.includes('CORS')) {
                    addResult(`âŒ CORS éŒ¯èª¤: ${error.message}`, 'error');
                    addResult(`ğŸš¨ é‡è¦ç™¼ç¾: æ«ƒè²·ä¸­å¿ƒ API æœ‰ CORS é™åˆ¶ï¼`, 'error');
                } else {
                    addResult(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                }
                
                testResults.push({
                    symbol,
                    type,
                    success: false,
                    error: error.message,
                    source: 'TPEx'
                });
            }
            
            updateSummary();
        }

        async function runAllTests() {
            addResult('ğŸš€ é–‹å§‹åŸ·è¡Œæ‰€æœ‰ Task 1 æ¸¬è©¦...', 'info');
            addResult('ğŸ“‹ æ¸¬è©¦é …ç›®: è­‰äº¤æ‰€ç›¤å¾Œè³‡æ–™é©—è­‰', 'info');
            
            // æ¸…é™¤ä¹‹å‰çš„çµæœ
            testResults.length = 0;
            
            // åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
            await testTWSE('2330', 'ä¸Šå¸‚');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testTPEx('6188', 'ä¸Šæ«ƒ');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testTWSE('0050', 'ETF');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testTPEx('00679B', 'å‚µåˆ¸ETF');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testTPEx('4585', 'èˆˆæ«ƒ');
            
            // ç”Ÿæˆæœ€çµ‚å ±å‘Š
            addResult('ğŸ“Š Task 1 æ¸¬è©¦å®Œæˆï¼', 'success');
            generateReport();
        }

        function generateReport() {
            addResult('ğŸ“‹ ç”Ÿæˆ Task 1 æ¸¬è©¦å ±å‘Š...', 'info');
            
            const report = {
                task: 'Task 1: è­‰äº¤æ‰€ç›¤å¾Œè³‡æ–™é©—è­‰',
                timestamp: new Date().toISOString(),
                results: testResults,
                summary: {
                    total: testResults.length,
                    passed: testResults.filter(r => r.success).length,
                    failed: testResults.filter(r => !r.success).length,
                    corsIssues: testResults.filter(r => r.error && r.error.includes('CORS')).length
                }
            };
            
            console.log('ğŸ“Š Task 1 æ¸¬è©¦å ±å‘Š:', report);
            
            // çµè«–
            if (report.summary.corsIssues > 0) {
                addResult('ğŸš¨ é‡è¦çµè«–: è­‰äº¤æ‰€ API å­˜åœ¨ CORS é™åˆ¶ï¼', 'error');
                addResult('ğŸ’¡ å»ºè­°: éœ€è¦ä½¿ç”¨ Netlify Functions æˆ–å…¶ä»–ä»£ç†æ–¹æ¡ˆ', 'warning');
            } else if (report.summary.passed === report.summary.total) {
                addResult('ğŸ‰ çµè«–: è­‰äº¤æ‰€ç›¤å¾Œ API å®Œå…¨å¯ç”¨ï¼Œç„¡ CORS å•é¡Œï¼', 'success');
                addResult('âœ… å»ºè­°: å¯ä»¥ç›´æ¥åœ¨é›²ç«¯ä½¿ç”¨è­‰äº¤æ‰€ç›¤å¾Œè³‡æ–™', 'success');
            } else {
                addResult('âš ï¸ çµè«–: éƒ¨åˆ† API å¯ç”¨ï¼Œéœ€è¦é€²ä¸€æ­¥åˆ†æ', 'warning');
            }
            
            addResult('ğŸ“Š è©³ç´°å ±å‘Šå·²è¼¸å‡ºåˆ° Console', 'info');
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults.length = 0;
            document.getElementById('summary').innerHTML = '<p>ç­‰å¾…æ¸¬è©¦åŸ·è¡Œ...</p>';
        }

        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            addResult('ğŸ“Š Task 1 æ¸¬è©¦ç³»çµ±å·²è¼‰å…¥ - v1.0.2.0348', 'success');
            addResult('ğŸ¯ ç›®æ¨™: é©—è­‰è­‰äº¤æ‰€ç›¤å¾Œè³‡æ–™æ˜¯å¦æœ‰ CORS é™åˆ¶', 'info');
            addResult('âš ï¸ æ³¨æ„: æ­¤ç‚ºç¨ç«‹æ¸¬è©¦ï¼Œä¸å½±éŸ¿ä¸»ç¨‹å¼', 'warning');
            addResult('ğŸš€ é»æ“ŠæŒ‰éˆ•é–‹å§‹æ¸¬è©¦ï¼Œæˆ–åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦', 'info');
        });
    </script>
</body>
</html>