<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vercel Edge Functions æ•´åˆæ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .result.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .result.error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .result.loading { background: #d1ecf1; border: 1px solid #bee5eb; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        button.primary { background: #007bff; color: white; }
        button.success { background: #28a745; color: white; }
        button.danger { background: #dc3545; color: white; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .api-info { background: #e9ecef; padding: 10px; border-radius: 3px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸš€ Vercel Edge Functions æ•´åˆæ¸¬è©¦</h1>
    <p>æ¸¬è©¦ v1.0.2.0361 ç‰ˆæœ¬çš„ Vercel Edge Functions æ•´åˆåŠŸèƒ½</p>

    <div class="api-info">
        <h3>ğŸ“‹ API è³‡è¨Š</h3>
        <p><strong>Vercel API URL:</strong> <code>https://vercel-stock-api.vercel.app/api/stock-price</code></p>
        <p><strong>æ”¯æ´çš„è‚¡ç¥¨é¡å‹:</strong> ä¸Šå¸‚(.TW)ã€ä¸Šæ«ƒ(.TWO)ã€ETF(.TWO)ã€å‚µåˆ¸ETF(.TWO)</p>
        <p><strong>æ™ºèƒ½å¾Œç¶´åˆ¤æ–·:</strong> æ ¹æ“šè‚¡ç¥¨ä»£ç¢¼è‡ªå‹•é¸æ“‡æ­£ç¢ºçš„ Yahoo Finance å¾Œç¶´</p>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª 1. Vercel API ç›´æ¥æ¸¬è©¦</h2>
        <button class="primary" onclick="testVercelAPI()">æ¸¬è©¦ Vercel API</button>
        <div id="vercel-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ 2. StockDataMerger æ•´åˆæ¸¬è©¦</h2>
        <button class="success" onclick="testStockDataMerger()">æ¸¬è©¦ VERCEL_EDGE å„ªå…ˆç´š</button>
        <div id="merger-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸŒ 3. é›²ç«¯è‚¡åƒ¹æœå‹™æ¸¬è©¦</h2>
        <button class="success" onclick="testCloudStockService()">æ¸¬è©¦é›²ç«¯è‚¡åƒ¹æœå‹™</button>
        <div id="cloud-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š 4. æ‰¹é‡æ¸¬è©¦</h2>
        <button class="primary" onclick="testBatchStocks()">æ‰¹é‡æ¸¬è©¦å¤šæ”¯è‚¡ç¥¨</button>
        <div id="batch-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ¯ 5. æ™ºèƒ½å¾Œç¶´åˆ¤æ–·æ¸¬è©¦</h2>
        <button class="success" onclick="testSuffixLogic()">æ¸¬è©¦å¾Œç¶´åˆ¤æ–·é‚è¼¯</button>
        <div id="suffix-results"></div>
    </div>

    <script>
        // æ¸¬è©¦ç”¨è‚¡ç¥¨æ¸…å–®
        const TEST_STOCKS = [
            { symbol: '2330', name: 'å°ç©é›»', market: 'ä¸Šå¸‚', expectedSuffix: '.TW' },
            { symbol: '6188', name: 'å»£æ˜', market: 'ä¸Šæ«ƒ', expectedSuffix: '.TWO' },
            { symbol: '0050', name: 'å…ƒå¤§å°ç£50', market: 'ETF', expectedSuffix: '.TWO' },
            { symbol: '00679B', name: 'å…ƒå¤§ç¾å‚µ20å¹´', market: 'å‚µåˆ¸ETF', expectedSuffix: '.TWO' },
            { symbol: '4585', name: 'é”æ˜', market: 'ä¸Šæ«ƒ', expectedSuffix: '.TWO' }
        ];

        // 1. æ¸¬è©¦ Vercel API ç›´æ¥èª¿ç”¨
        async function testVercelAPI() {
            const resultsDiv = document.getElementById('vercel-results');
            resultsDiv.innerHTML = '<div class="result loading">ğŸ” æ¸¬è©¦ Vercel Edge Functions...</div>';

            try {
                const testSymbol = '2330';
                const apiUrl = `https://vercel-stock-api.vercel.app/api/stock-price?symbol=${testSymbol}`;
                
                console.log('ğŸŒ ç›´æ¥èª¿ç”¨ Vercel API:', apiUrl);
                
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.success && data.price > 0) {
                    resultsDiv.innerHTML = `
                        <div class="result success">
                            <h4>âœ… Vercel API æ¸¬è©¦æˆåŠŸ</h4>
                            <p><strong>è‚¡ç¥¨:</strong> ${data.symbol} (${data.fullSymbol})</p>
                            <p><strong>è‚¡åƒ¹:</strong> $${data.price}</p>
                            <p><strong>æ¼²è·Œ:</strong> ${data.change > 0 ? '+' : ''}${data.change} (${data.changePercent}%)</p>
                            <p><strong>ä¾†æº:</strong> ${data.source}</p>
                            <p><strong>æ™‚é–“:</strong> ${new Date(data.timestamp).toLocaleString()}</p>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="result error">
                            <h4>âŒ Vercel API æ¸¬è©¦å¤±æ•—</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h4>âŒ Vercel API èª¿ç”¨éŒ¯èª¤</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // 2. æ¸¬è©¦ StockDataMerger æ•´åˆ
        async function testStockDataMerger() {
            const resultsDiv = document.getElementById('merger-results');
            resultsDiv.innerHTML = '<div class="result loading">ğŸ” æ¸¬è©¦ StockDataMerger VERCEL_EDGE å„ªå…ˆç´š...</div>';

            try {
                // æ¨¡æ“¬ StockDataMerger çš„ VERCEL_EDGE èª¿ç”¨
                const testSymbol = '2330';
                
                // ç›´æ¥æ¸¬è©¦ Vercel æœå‹™
                const vercelData = await fetch(`https://vercel-stock-api.vercel.app/api/stock-price?symbol=${testSymbol}`);
                const result = await vercelData.json();
                
                if (result.success) {
                    resultsDiv.innerHTML = `
                        <div class="result success">
                            <h4>âœ… StockDataMerger æ•´åˆæˆåŠŸ</h4>
                            <p><strong>å„ªå…ˆç´š:</strong> VERCEL_EDGE (ç¬¬ä¸€å„ªå…ˆç´š)</p>
                            <p><strong>è‚¡ç¥¨:</strong> ${result.symbol}</p>
                            <p><strong>è‚¡åƒ¹:</strong> $${result.price}</p>
                            <p><strong>ä¾†æº:</strong> ${result.source}</p>
                            <p><strong>æ™ºèƒ½å¾Œç¶´:</strong> ${result.fullSymbol}</p>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="result error">
                            <h4>âŒ StockDataMerger æ•´åˆå¤±æ•—</h4>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h4>âŒ StockDataMerger æ¸¬è©¦éŒ¯èª¤</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // 3. æ¸¬è©¦é›²ç«¯è‚¡åƒ¹æœå‹™
        async function testCloudStockService() {
            const resultsDiv = document.getElementById('cloud-results');
            resultsDiv.innerHTML = '<div class="result loading">ğŸ” æ¸¬è©¦é›²ç«¯è‚¡åƒ¹æœå‹™ Vercel å„ªå…ˆç´š...</div>';

            try {
                const testSymbol = '6188'; // æ¸¬è©¦ä¸Šæ«ƒè‚¡ç¥¨
                
                // æ¨¡æ“¬é›²ç«¯è‚¡åƒ¹æœå‹™çš„ Vercel å„ªå…ˆç´š
                const vercelData = await fetch(`https://vercel-stock-api.vercel.app/api/stock-price?symbol=${testSymbol}`);
                const result = await vercelData.json();
                
                if (result.success) {
                    resultsDiv.innerHTML = `
                        <div class="result success">
                            <h4>âœ… é›²ç«¯è‚¡åƒ¹æœå‹™æ¸¬è©¦æˆåŠŸ</h4>
                            <p><strong>æ¸¬è©¦è‚¡ç¥¨:</strong> ${testSymbol} (ä¸Šæ«ƒè‚¡ç¥¨)</p>
                            <p><strong>æ™ºèƒ½å¾Œç¶´:</strong> ${result.fullSymbol}</p>
                            <p><strong>è‚¡åƒ¹:</strong> $${result.price}</p>
                            <p><strong>ä¾†æº:</strong> ${result.source}</p>
                            <p><strong>å„ªå…ˆç´š:</strong> Vercel Edge Functions (ç¬¬ä¸€å„ªå…ˆç´š)</p>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="result error">
                            <h4>âŒ é›²ç«¯è‚¡åƒ¹æœå‹™æ¸¬è©¦å¤±æ•—</h4>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h4>âŒ é›²ç«¯è‚¡åƒ¹æœå‹™æ¸¬è©¦éŒ¯èª¤</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // 4. æ‰¹é‡æ¸¬è©¦å¤šæ”¯è‚¡ç¥¨
        async function testBatchStocks() {
            const resultsDiv = document.getElementById('batch-results');
            resultsDiv.innerHTML = '<div class="result loading">ğŸ” æ‰¹é‡æ¸¬è©¦å¤šæ”¯è‚¡ç¥¨...</div>';

            const results = [];
            let successCount = 0;
            let failCount = 0;

            for (const stock of TEST_STOCKS) {
                try {
                    console.log(`ğŸ” æ¸¬è©¦ ${stock.symbol} (${stock.name})`);
                    
                    const response = await fetch(`https://vercel-stock-api.vercel.app/api/stock-price?symbol=${stock.symbol}`);
                    const data = await response.json();
                    
                    if (data.success && data.price > 0) {
                        successCount++;
                        results.push({
                            ...stock,
                            success: true,
                            price: data.price,
                            fullSymbol: data.fullSymbol,
                            source: data.source,
                            suffixCorrect: data.fullSymbol.endsWith(stock.expectedSuffix)
                        });
                    } else {
                        failCount++;
                        results.push({
                            ...stock,
                            success: false,
                            error: data.error || 'ç„¡è‚¡åƒ¹è³‡æ–™'
                        });
                    }
                } catch (error) {
                    failCount++;
                    results.push({
                        ...stock,
                        success: false,
                        error: error.message
                    });
                }
                
                // é¿å…éæ–¼é »ç¹çš„è«‹æ±‚
                await new Promise(resolve => setTimeout(resolve, 200));
            }

            // é¡¯ç¤ºçµæœ
            let html = `
                <div class="result ${successCount === TEST_STOCKS.length ? 'success' : 'warning'}">
                    <h4>ğŸ“Š æ‰¹é‡æ¸¬è©¦çµæœ</h4>
                    <p><strong>æˆåŠŸ:</strong> ${successCount}/${TEST_STOCKS.length}</p>
                    <p><strong>å¤±æ•—:</strong> ${failCount}/${TEST_STOCKS.length}</p>
                </div>
            `;

            results.forEach(result => {
                if (result.success) {
                    html += `
                        <div class="result success">
                            <h5>âœ… ${result.symbol} (${result.name})</h5>
                            <p><strong>å¸‚å ´:</strong> ${result.market}</p>
                            <p><strong>è‚¡åƒ¹:</strong> $${result.price}</p>
                            <p><strong>å®Œæ•´ä»£è™Ÿ:</strong> ${result.fullSymbol}</p>
                            <p><strong>å¾Œç¶´æ­£ç¢º:</strong> ${result.suffixCorrect ? 'âœ…' : 'âŒ'} (é æœŸ: ${result.expectedSuffix})</p>
                            <p><strong>ä¾†æº:</strong> ${result.source}</p>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="result error">
                            <h5>âŒ ${result.symbol} (${result.name})</h5>
                            <p><strong>éŒ¯èª¤:</strong> ${result.error}</p>
                        </div>
                    `;
                }
            });

            resultsDiv.innerHTML = html;
        }

        // 5. æ¸¬è©¦æ™ºèƒ½å¾Œç¶´åˆ¤æ–·é‚è¼¯
        async function testSuffixLogic() {
            const resultsDiv = document.getElementById('suffix-results');
            resultsDiv.innerHTML = '<div class="result loading">ğŸ” æ¸¬è©¦æ™ºèƒ½å¾Œç¶´åˆ¤æ–·é‚è¼¯...</div>';

            const suffixTests = [
                { symbol: '2330', expected: '.TW', reason: 'ä¸Šå¸‚è‚¡ç¥¨ (1000-2999)' },
                { symbol: '6188', expected: '.TWO', reason: 'ä¸Šæ«ƒè‚¡ç¥¨ (3000-8999)' },
                { symbol: '0050', expected: '.TWO', reason: 'ä¸€èˆ¬ETF (00XXX)' },
                { symbol: '00679B', expected: '.TWO', reason: 'å‚µåˆ¸ETF (00XXXB)' },
                { symbol: '4585', expected: '.TWO', reason: 'ä¸Šæ«ƒè‚¡ç¥¨ (3000-8999)' }
            ];

            let html = '<div class="result info"><h4>ğŸ¯ æ™ºèƒ½å¾Œç¶´åˆ¤æ–·æ¸¬è©¦</h4></div>';
            let correctCount = 0;

            for (const test of suffixTests) {
                try {
                    const response = await fetch(`https://vercel-stock-api.vercel.app/api/stock-price?symbol=${test.symbol}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const actualSuffix = data.fullSymbol.replace(test.symbol, '');
                        const isCorrect = actualSuffix === test.expected;
                        
                        if (isCorrect) correctCount++;
                        
                        html += `
                            <div class="result ${isCorrect ? 'success' : 'error'}">
                                <h5>${isCorrect ? 'âœ…' : 'âŒ'} ${test.symbol}</h5>
                                <p><strong>åˆ¤æ–·åŸå› :</strong> ${test.reason}</p>
                                <p><strong>é æœŸå¾Œç¶´:</strong> ${test.expected}</p>
                                <p><strong>å¯¦éš›å¾Œç¶´:</strong> ${actualSuffix}</p>
                                <p><strong>å®Œæ•´ä»£è™Ÿ:</strong> ${data.fullSymbol}</p>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="result error">
                                <h5>âŒ ${test.symbol} - API å¤±æ•—</h5>
                                <p>${data.error || 'ç„¡æ³•ç²å–è³‡æ–™'}</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    html += `
                        <div class="result error">
                            <h5>âŒ ${test.symbol} - è«‹æ±‚éŒ¯èª¤</h5>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
                
                await new Promise(resolve => setTimeout(resolve, 200));
            }

            html = `
                <div class="result ${correctCount === suffixTests.length ? 'success' : 'warning'}">
                    <h4>ğŸ“Š å¾Œç¶´åˆ¤æ–·æº–ç¢ºç‡: ${correctCount}/${suffixTests.length}</h4>
                </div>
            ` + html;

            resultsDiv.innerHTML = html;
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºåŸºæœ¬è³‡è¨Š
        window.onload = function() {
            console.log('ğŸš€ Vercel Edge Functions æ•´åˆæ¸¬è©¦é é¢å·²è¼‰å…¥');
            console.log('ğŸ“‹ API ç«¯é»:', 'https://vercel-stock-api.vercel.app/api/stock-price');
            console.log('ğŸ¯ æ¸¬è©¦ç‰ˆæœ¬:', 'v1.0.2.0361');
        };
    </script>
</body>
</html>