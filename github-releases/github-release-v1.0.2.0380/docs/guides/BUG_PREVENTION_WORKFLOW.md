# BUG 預防工作流程 (Bug Prevention Workflow)

## 🎯 目標：從根本上預防重複 BUG

這份文檔說明如何將 BUG 轉化為預防機制，避免相同問題再次發生。

---

## 📊 問題分類

### 類型 A：規則遺忘型
**特徵**：有 STEERING 規則，但開發時忘記遵循

**範例**：
- v1.0.2.0142：忘記在 partialize 中添加 rightsAdjustmentMode
- v1.0.2.0132：忘記在 Header 批量更新中傳入 forceRecalculate

**預防措施**：
1. ✅ 開發前執行 `npm run dev:assistant` 自動提醒
2. ✅ 提交前執行 `npm run check:all` 強制檢查
3. ✅ 使用檢查清單輔助記憶

### 類型 B：規則缺失型
**特徵**：沒有對應的 STEERING 規則

**範例**：
- 首次發現的新問題類型
- 跨模組的複雜問題

**預防措施**：
1. 🔄 立即創建新的 STEERING 規則
2. 🔄 更新自動化檢查腳本
3. 🔄 記錄到問題追蹤表

### 類型 C：設計缺陷型
**特徵**：系統設計本身有問題

**範例**：
- 多處實作相同邏輯導致不一致
- 狀態管理過於複雜

**預防措施**：
1. 🔧 重構設計（遵循 safe-development.md）
2. 🔧 統一實作邏輯
3. 🔧 簡化複雜度

---

## 🔄 BUG 修復到預防的完整流程

### 步驟 1：發現問題
```
用戶報告 / 測試發現 / 自己發現
↓
記錄問題詳情
- 問題描述
- 重現步驟
- 錯誤訊息
- 影響範圍
```

### 步驟 2：分析根因
```
為什麼會發生這個問題？
↓
分類問題類型（A/B/C）
↓
找出根本原因
- 規則遺忘？
- 規則缺失？
- 設計缺陷？
```

### 步驟 3：修復問題
```
遵循相關 STEERING 規則
↓
使用疊加式開發
↓
完整的錯誤處理
↓
添加日誌記錄
```

### 步驟 4：建立預防機制
```
更新 STEERING 規則（如需要）
↓
更新自動化檢查腳本（如需要）
↓
更新檢查清單（如需要）
↓
記錄到問題追蹤表
```

### 步驟 5：驗證預防效果
```
執行 npm run check:all
↓
測試相關功能
↓
確認預防機制有效
```

### 步驟 6：分享經驗
```
更新 changelog
↓
更新文檔
↓
團隊分享（如有）
```

---

## 📋 問題追蹤表模板

### 問題記錄格式

```markdown
## 問題 #XXXX：[簡短描述]

**發現日期**：2026-01-15
**版本**：v1.0.2.0142
**類型**：規則遺忘型 / 規則缺失型 / 設計缺陷型
**嚴重程度**：高 / 中 / 低

### 問題描述
[詳細描述問題]

### 重現步驟
1. [步驟 1]
2. [步驟 2]
3. [步驟 3]

### 根本原因
[分析根本原因]

### 修復方案
[描述修復方案]

### 預防措施
- [ ] 更新 STEERING 規則：[規則名稱]
- [ ] 更新檢查腳本：[腳本名稱]
- [ ] 更新檢查清單：[清單項目]
- [ ] 其他措施：[描述]

### 驗證結果
- [ ] 問題已修復
- [ ] 預防機制已建立
- [ ] 自動化檢查通過
- [ ] 相關功能測試通過

### 相關連結
- Commit: [commit hash]
- STEERING 規則: [規則檔案]
- 檢查腳本: [腳本檔案]
```

---

## 🎯 實際案例分析

### 案例 1：切換損益模式失效（v1.0.2.0142）

**問題描述**：
切換除權息模式後，頁面重載後設定丟失

**根本原因**：
- 類型：規則遺忘型
- 原因：partialize 沒有包含 rightsAdjustmentMode

**修復方案**：
```typescript
// 在 partialize 中添加
partialize: (state) => ({
  // ...
  rightsAdjustmentMode: state.rightsAdjustmentMode, // ⚠️ 必須包含
})
```

**預防措施**：
1. ✅ 創建 `check-state-management.cjs` 自動檢查
2. ✅ 更新 `state-management.md` STEERING 規則
3. ✅ 添加到開發檢查清單

**效果**：
- 自動化檢查能立即發現類似問題
- 提交前強制通過檢查
- 預防相同問題再次發生

---

### 案例 2：Header 批量更新和個股更新不一致（v1.0.2.0132）

**問題描述**：
Header 批量更新和個股內更新除權息的結果不一致

**根本原因**：
- 類型：規則遺忘型
- 原因：Header 批量更新沒有傳入 forceRecalculate 參數

**修復方案**：
```typescript
// 確保所有入口都傳入 forceRecalculate
await updateStockDividendData(stock, state, true); // ⚠️ 必須傳入 true
```

**預防措施**：
1. ✅ 創建 `check-rights-calculation.cjs` 自動檢查
2. ✅ 更新 `unified-rights-calculation.md` STEERING 規則
3. ✅ 添加到開發檢查清單

**效果**：
- 自動化檢查能掃描所有調用點
- 發現未傳入參數的情況
- 預防邏輯不一致問題

---

## 📊 預防效果追蹤

### 追蹤指標

| 指標 | 基準值 | 目標值 | 當前值 | 趨勢 |
|-----|--------|--------|--------|------|
| 重複 BUG 率 | 30% | < 5% | - | 🔄 追蹤中 |
| 首次修復成功率 | 70% | > 95% | - | 🔄 追蹤中 |
| 平均修復時間 | 2 小時 | < 30 分鐘 | - | 🔄 追蹤中 |
| 自動化檢查覆蓋率 | 40% | > 80% | 60% | 📈 改善中 |

### 每週檢討

**檢討內容**：
1. 本週發現的問題類型分佈
2. 哪些預防措施有效
3. 哪些預防措施需要改進
4. 新發現的問題模式

**檢討模板**：
```markdown
## 週檢討 - 2026-01-15

### 本週問題統計
- 總問題數：X 個
- 規則遺忘型：X 個
- 規則缺失型：X 個
- 設計缺陷型：X 個

### 有效的預防措施
- [措施 1]：成功預防 X 個問題
- [措施 2]：成功預防 X 個問題

### 需要改進的地方
- [問題 1]：[改進建議]
- [問題 2]：[改進建議]

### 下週行動計劃
- [ ] [行動 1]
- [ ] [行動 2]
```

---

## 🛠️ 工具和資源

### 自動化工具
- `npm run dev:assistant` - 開發前提醒
- `npm run check:all` - 提交前檢查
- `npm run check:state` - 狀態管理檢查
- `npm run check:rights` - 除權息計算檢查

### 文檔資源
- `docs/guides/DEVELOPMENT_WORKFLOW.md` - 開發流程
- `docs/guides/QUICK_REFERENCE.md` - 快速參考
- `docs/checklists/DEVELOPMENT_CHECKLIST.md` - 檢查清單
- `.kiro/steering/*.md` - STEERING 規則

### 檢查清單
- UI 組件開發檢查清單
- 狀態管理修改檢查清單
- 除權息功能修改檢查清單
- API 功能修改檢查清單
- 版本號更新檢查清單
- 提交前最終檢查清單
- BUG 修復檢查清單

---

## 💡 最佳實踐

### 1. 立即記錄
發現問題時立即記錄，不要等到修復後才記錄。

### 2. 深入分析
不要只修復表面問題，要找出根本原因。

### 3. 建立預防
每次修復都要建立預防機制，避免重複發生。

### 4. 持續改進
定期檢討預防措施的效果，持續優化。

### 5. 分享經驗
將經驗記錄到文檔中，幫助團隊成長。

---

## 🎯 成功案例

### 成功案例 1：SVG Path 格式錯誤
**問題**：SVG path 格式錯誤導致圖示無法顯示

**預防措施**：
- 創建 `check-svg-paths.js` 自動檢查
- 創建統一的 Icons.tsx 組件
- 更新 ui-design-standards.md

**效果**：
- 自動化檢查覆蓋率 100%
- 問題發生率從 20% 降到 0%
- 開發效率提升 30%

### 成功案例 2：版本號不一致
**問題**：package.json、version.ts、changelog.ts 版本號不一致

**預防措施**：
- 創建 `check-version-consistency.js` 自動檢查
- 更新 version-consistency.md
- 添加到提交前檢查

**效果**：
- 版本號一致性 100%
- 問題發生率從 40% 降到 0%
- 減少版本管理混亂

---

## 🔄 持續改進循環

```
發現問題
    ↓
分析根因
    ↓
修復問題
    ↓
建立預防
    ↓
驗證效果
    ↓
分享經驗
    ↓
（回到發現問題）
```

**關鍵**：每個循環都要建立預防機制，不只是修復問題。

---

## 📚 延伸閱讀

- **開發流程**：`docs/guides/DEVELOPMENT_WORKFLOW.md`
- **快速參考**：`docs/guides/QUICK_REFERENCE.md`
- **檢查清單**：`docs/checklists/DEVELOPMENT_CHECKLIST.md`
- **改進措施**：`docs/IMPROVEMENT_MEASURES.md`
- **代碼質量標準**：`.kiro/steering/code-quality-standards.md`

---

**記住：預防勝於修復！每次修復都是建立預防機制的機會！**

**制定日期**：2026-01-15  
**版本**：1.0.0  
**目標**：將重複 BUG 率從 30% 降到 < 5%
