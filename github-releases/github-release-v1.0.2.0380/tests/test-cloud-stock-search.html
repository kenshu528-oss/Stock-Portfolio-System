<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯ç’°å¢ƒè‚¡ç¥¨æœå°‹æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .container {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #333;
            color: #fff;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            background-color: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .error {
            border-left-color: #dc3545;
            background-color: #2d1b1b;
        }
        .success {
            border-left-color: #28a745;
            background-color: #1b2d1b;
        }
        .loading {
            color: #ffc107;
        }
        pre {
            background-color: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸŒ é›²ç«¯ç’°å¢ƒè‚¡ç¥¨æœå°‹æ¸¬è©¦</h1>
    
    <div class="container">
        <h2>ğŸ“Š è‚¡åƒ¹ API æ¸¬è©¦</h2>
        <input type="text" id="symbolInput" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ (ä¾‹å¦‚: 2330)" value="2330">
        <button onclick="testStockPrice()">æ¸¬è©¦è‚¡åƒ¹ç²å–</button>
        <button onclick="testBatchPrices()">æ‰¹æ¬¡æ¸¬è©¦</button>
        <button onclick="clearResults()">æ¸…é™¤çµæœ</button>
        <div id="priceResults"></div>
    </div>

    <div class="container">
        <h2>ğŸ” è‚¡ç¥¨æ¸…å–®æ¸¬è©¦</h2>
        <button onclick="testStockList()">æ¸¬è©¦è‚¡ç¥¨æ¸…å–®è¼‰å…¥</button>
        <input type="text" id="searchInput" placeholder="æœå°‹è‚¡ç¥¨ (ä¾‹å¦‚: å°ç©é›»)" value="å°ç©é›»">
        <button onclick="testStockSearch()">æ¸¬è©¦è‚¡ç¥¨æœå°‹</button>
        <div id="listResults"></div>
    </div>

    <div class="container">
        <h2>ğŸ“ˆ å®Œæ•´æœå°‹æ¸¬è©¦</h2>
        <input type="text" id="fullSearchInput" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±" value="2330">
        <button onclick="testFullSearch()">å®Œæ•´æœå°‹æ¸¬è©¦</button>
        <div id="fullResults"></div>
    </div>

    <script>
        // æ¨¡æ“¬é›²ç«¯è‚¡åƒ¹æœå‹™
        class CloudStockPriceService {
            constructor() {
                this.cache = new Map();
                this.CACHE_DURATION = 5 * 60 * 1000; // 5åˆ†é˜
            }

            async getStockPrice(symbol) {
                // æª¢æŸ¥å¿«å–
                const cached = this.getCachedPrice(symbol);
                if (cached) {
                    console.log(`ä½¿ç”¨å¿«å–è‚¡åƒ¹: ${symbol}`, cached.price);
                    return cached;
                }

                // å˜—è©¦ AllOrigins + Yahoo Finance
                try {
                    const result = await this.fetchFromYahooAllOrigins(symbol);
                    if (result && result.price > 0) {
                        this.setCachedPrice(symbol, result);
                        return result;
                    }
                } catch (error) {
                    console.log('Yahoo Finance å¤±æ•—:', error.message);
                }

                // å˜—è©¦ FinMind ç›´æ¥èª¿ç”¨
                try {
                    const result = await this.fetchFromFinMindDirect(symbol);
                    if (result && result.price > 0) {
                        this.setCachedPrice(symbol, result);
                        return result;
                    }
                } catch (error) {
                    console.log('FinMind å¤±æ•—:', error.message);
                }

                return null;
            }

            async fetchFromYahooAllOrigins(symbol) {
                const yahooSymbol = this.getYahooSymbol(symbol);
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(yahooUrl)}`;

                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const proxyData = await response.json();
                const yahooData = JSON.parse(proxyData.contents);
                
                const result = yahooData?.chart?.result?.[0];
                if (!result?.meta) throw new Error('ç„¡æ•ˆçš„ Yahoo Finance è³‡æ–™');

                const currentPrice = result.meta.regularMarketPrice || 0;
                const previousClose = result.meta.previousClose || 0;
                const change = currentPrice - previousClose;
                const changePercent = previousClose > 0 ? (change / previousClose) * 100 : 0;

                return {
                    price: currentPrice,
                    change,
                    changePercent,
                    source: 'Yahoo Finance (AllOrigins)',
                    timestamp: new Date().toISOString()
                };
            }

            async fetchFromFinMindDirect(symbol) {
                const today = new Date();
                const startDate = new Date(today.getTime() - 14 * 24 * 60 * 60 * 1000);
                
                const finmindUrl = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${symbol}&start_date=${startDate.toISOString().split('T')[0]}&end_date=${today.toISOString().split('T')[0]}&token=`;

                const response = await fetch(finmindUrl);
                if (!response.ok) {
                    if (response.status === 402) {
                        throw new Error('FinMind API éœ€è¦ä»˜è²»');
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                if (!data.data || data.data.length === 0) {
                    throw new Error('FinMind ç„¡è³‡æ–™');
                }

                const prices = data.data.sort((a, b) => 
                    new Date(a.date).getTime() - new Date(b.date).getTime()
                );
                
                const latestPrice = prices[prices.length - 1];
                const previousPrice = prices.length > 1 ? prices[prices.length - 2] : latestPrice;
                
                const currentPrice = latestPrice.close || 0;
                const prevClose = previousPrice.close || currentPrice;
                const change = currentPrice - prevClose;
                const changePercent = prevClose > 0 ? (change / prevClose) * 100 : 0;

                return {
                    price: currentPrice,
                    change,
                    changePercent,
                    source: 'FinMind Direct',
                    timestamp: new Date().toISOString()
                };
            }

            getYahooSymbol(symbol) {
                if (symbol.includes('.')) return symbol;

                const code = parseInt(symbol.substring(0, 4));
                const isBondETF = /^00\d{2,3}B$/i.test(symbol);
                const isETF = /^00\d{2,3}[A-Z]?$/i.test(symbol);

                // ç‰¹æ®Šæ¡ˆä¾‹è™•ç†
                const specialCases = {
                    '8112': '.TW', // è‡³ä¸Šï¼šé›–åœ¨ 8000 ç¯„åœä½†éœ€ä½¿ç”¨ .TW
                    '4585': '.TW', // é”æ˜ï¼šèˆˆæ«ƒè‚¡ç¥¨ï¼Œæœ€å¸¸ç”¨ .TW
                };
                
                if (specialCases[symbol]) {
                    return `${symbol}${specialCases[symbol]}`;
                }

                // å‚µåˆ¸ ETFï¼šå„ªå…ˆæ«ƒè²·ä¸­å¿ƒ
                if (isBondETF) {
                    return `${symbol}.TWO`;
                }
                
                // ä¸€èˆ¬ ETFï¼šå„ªå…ˆæ«ƒè²·ä¸­å¿ƒ
                if (isETF) {
                    return `${symbol}.TWO`;
                }
                
                // ä¸Šæ«ƒè‚¡ç¥¨ï¼ˆ3000-8999ï¼‰ï¼šå„ªå…ˆæ«ƒè²·ä¸­å¿ƒ
                if (code >= 3000 && code <= 8999) {
                    return `${symbol}.TWO`;
                }
                
                // ä¸Šå¸‚è‚¡ç¥¨ï¼ˆ1000-2999ï¼‰ï¼šå„ªå…ˆè­‰äº¤æ‰€
                return `${symbol}.TW`;
            }

            getCachedPrice(symbol) {
                const cached = this.cache.get(symbol);
                if (cached && Date.now() < cached.expiry) {
                    return cached.data;
                }
                if (cached) {
                    this.cache.delete(symbol);
                }
                return null;
            }

            setCachedPrice(symbol, price) {
                this.cache.set(symbol, {
                    data: price,
                    expiry: Date.now() + this.CACHE_DURATION
                });
            }
        }

        // åˆå§‹åŒ–æœå‹™
        const priceService = new CloudStockPriceService();

        // æ¸¬è©¦å‡½æ•¸
        async function testStockPrice() {
            const symbol = document.getElementById('symbolInput').value.trim();
            if (!symbol) return;

            const resultsDiv = document.getElementById('priceResults');
            resultsDiv.innerHTML += `<div class="result loading">ğŸ” æ­£åœ¨ç²å– ${symbol} çš„è‚¡åƒ¹...</div>`;

            try {
                const startTime = Date.now();
                const result = await priceService.getStockPrice(symbol);
                const duration = Date.now() - startTime;

                if (result) {
                    resultsDiv.innerHTML += `
                        <div class="result success">
                            <h4>âœ… ${symbol} è‚¡åƒ¹ç²å–æˆåŠŸ</h4>
                            <p><strong>åƒ¹æ ¼:</strong> $${result.price}</p>
                            <p><strong>æ¼²è·Œ:</strong> ${result.change > 0 ? '+' : ''}${result.change.toFixed(2)} (${result.changePercent.toFixed(2)}%)</p>
                            <p><strong>è³‡æ–™ä¾†æº:</strong> ${result.source}</p>
                            <p><strong>éŸ¿æ‡‰æ™‚é–“:</strong> ${duration}ms</p>
                            <p><strong>æ™‚é–“æˆ³:</strong> ${result.timestamp}</p>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML += `
                        <div class="result error">
                            <h4>âŒ ${symbol} è‚¡åƒ¹ç²å–å¤±æ•—</h4>
                            <p>æ‰€æœ‰ API éƒ½ç„¡æ³•ç²å–è‚¡åƒ¹è³‡æ–™</p>
                            <p><strong>éŸ¿æ‡‰æ™‚é–“:</strong> ${duration}ms</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML += `
                    <div class="result error">
                        <h4>âŒ ${symbol} ç™¼ç”ŸéŒ¯èª¤</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testBatchPrices() {
            const symbols = ['2330', '2317', '2454', '6188', '00679B'];
            const resultsDiv = document.getElementById('priceResults');
            
            resultsDiv.innerHTML += `<div class="result loading">ğŸ” æ‰¹æ¬¡æ¸¬è©¦ ${symbols.join(', ')} çš„è‚¡åƒ¹...</div>`;

            const startTime = Date.now();
            const results = [];

            for (const symbol of symbols) {
                try {
                    const result = await priceService.getStockPrice(symbol);
                    results.push({ symbol, result, success: !!result });
                } catch (error) {
                    results.push({ symbol, error: error.message, success: false });
                }
            }

            const duration = Date.now() - startTime;
            const successCount = results.filter(r => r.success).length;

            resultsDiv.innerHTML += `
                <div class="result ${successCount > 0 ? 'success' : 'error'}">
                    <h4>ğŸ“Š æ‰¹æ¬¡æ¸¬è©¦çµæœ (${successCount}/${symbols.length})</h4>
                    <p><strong>ç¸½éŸ¿æ‡‰æ™‚é–“:</strong> ${duration}ms</p>
                    <pre>${JSON.stringify(results, null, 2)}</pre>
                </div>
            `;
        }

        async function testStockList() {
            const resultsDiv = document.getElementById('listResults');
            resultsDiv.innerHTML += `<div class="result loading">ğŸ” æ­£åœ¨è¼‰å…¥è‚¡ç¥¨æ¸…å–®...</div>`;

            try {
                const response = await fetch('./stock_list.json');
                if (response.ok) {
                    const data = await response.json();
                    resultsDiv.innerHTML += `
                        <div class="result success">
                            <h4>âœ… è‚¡ç¥¨æ¸…å–®è¼‰å…¥æˆåŠŸ</h4>
                            <p><strong>æ—¥æœŸ:</strong> ${data.date}</p>
                            <p><strong>è‚¡ç¥¨æ•¸é‡:</strong> ${data.count}</p>
                            <p><strong>æª”æ¡ˆå¤§å°:</strong> ${(JSON.stringify(data).length / 1024).toFixed(1)} KB</p>
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                resultsDiv.innerHTML += `
                    <div class="result error">
                        <h4>âŒ è‚¡ç¥¨æ¸…å–®è¼‰å…¥å¤±æ•—</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testStockSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            const resultsDiv = document.getElementById('listResults');
            resultsDiv.innerHTML += `<div class="result loading">ğŸ” æ­£åœ¨æœå°‹ "${query}"...</div>`;

            try {
                const response = await fetch('./stock_list.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const stocks = Object.entries(data.stocks);
                
                const filtered = stocks.filter(([symbol, info]) => {
                    const queryLower = query.toLowerCase();
                    const symbolLower = symbol.toLowerCase();
                    const nameLower = info.name.toLowerCase();
                    
                    return symbolLower.includes(queryLower) || nameLower.includes(queryLower);
                }).slice(0, 10);

                resultsDiv.innerHTML += `
                    <div class="result success">
                        <h4>âœ… æœå°‹çµæœ (${filtered.length} ç­†)</h4>
                        <pre>${JSON.stringify(filtered, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML += `
                    <div class="result error">
                        <h4>âŒ æœå°‹å¤±æ•—</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testFullSearch() {
            const query = document.getElementById('fullSearchInput').value.trim();
            if (!query) return;

            const resultsDiv = document.getElementById('fullResults');
            resultsDiv.innerHTML += `<div class="result loading">ğŸ” å®Œæ•´æœå°‹æ¸¬è©¦: "${query}"...</div>`;

            try {
                // 1. è¼‰å…¥è‚¡ç¥¨æ¸…å–®
                const response = await fetch('./stock_list.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const stocks = Object.entries(data.stocks);
                
                // 2. æœå°‹åŒ¹é…çš„è‚¡ç¥¨
                const filtered = stocks.filter(([symbol, info]) => {
                    const queryLower = query.toLowerCase();
                    const symbolLower = symbol.toLowerCase();
                    const nameLower = info.name.toLowerCase();
                    
                    return symbolLower.includes(queryLower) || nameLower.includes(queryLower);
                }).slice(0, 5); // é™åˆ¶5ç­†ä»¥å…å¤ªå¤šAPIè«‹æ±‚

                // 3. ç²å–è‚¡åƒ¹
                const results = [];
                for (const [symbol, info] of filtered) {
                    const priceData = await priceService.getStockPrice(symbol);
                    results.push({
                        symbol,
                        name: info.name,
                        market: info.market,
                        price: priceData?.price || 0,
                        change: priceData?.change || 0,
                        changePercent: priceData?.changePercent || 0,
                        source: priceData?.source || 'N/A'
                    });
                }

                resultsDiv.innerHTML += `
                    <div class="result success">
                        <h4>âœ… å®Œæ•´æœå°‹çµæœ (${results.length} ç­†)</h4>
                        <pre>${JSON.stringify(results, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML += `
                    <div class="result error">
                        <h4>âŒ å®Œæ•´æœå°‹å¤±æ•—</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function clearResults() {
            document.getElementById('priceResults').innerHTML = '';
            document.getElementById('listResults').innerHTML = '';
            document.getElementById('fullResults').innerHTML = '';
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºç’°å¢ƒè³‡è¨Š
        window.addEventListener('load', () => {
            console.log('ğŸŒ é›²ç«¯ç’°å¢ƒè‚¡ç¥¨æœå°‹æ¸¬è©¦é é¢å·²è¼‰å…¥');
            console.log('ğŸ“ ç•¶å‰ä½ç½®:', window.location.href);
            console.log('ğŸ”§ æ¸¬è©¦åŠŸèƒ½: è‚¡ç¥¨æ¸…å–®è¼‰å…¥ã€è‚¡åƒ¹ç²å–ã€å®Œæ•´æœå°‹');
        });
    </script>
</body>
</html>