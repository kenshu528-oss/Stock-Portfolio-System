<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Stock Update</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .log { margin: 2px 0; padding: 3px 8px; border-radius: 3px; font-size: 12px; }
        .debug { background: #2a2a2a; color: #888; }
        .info { background: #1e3a8a; color: #bfdbfe; }
        .success { background: #166534; color: #bbf7d0; }
        .error { background: #991b1b; color: #fecaca; }
        .warn { background: #92400e; color: #fed7aa; }
        button { padding: 8px 16px; margin: 5px; background: #374151; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #4b5563; }
        #logs { max-height: 600px; overflow-y: auto; border: 1px solid #374151; padding: 10px; margin-top: 10px; }
    </style>
</head>
<body>
    <h2>Stock Update Debug Tool</h2>
    <div>
        <button onclick="testStep1()">1. Check Environment</button>
        <button onclick="testStep2()">2. Check Backend API</button>
        <button onclick="testStep3()">3. Test Update API</button>
        <button onclick="testStep4()">4. Full Process Test</button>
        <button onclick="clearLogs()">Clear</button>
    </div>
    <div id="logs"></div>

    <script>
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<span style="color:#666">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            document.getElementById('logs').appendChild(div);
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // æ­¥é©Ÿ 1ï¼šæª¢æŸ¥ç’°å¢ƒ
        async function testStep1() {
            log('=== æ­¥é©Ÿ 1ï¼šæª¢æŸ¥ç’°å¢ƒ ===', 'info');
            
            // æª¢æŸ¥ç’°å¢ƒè³‡è¨Š
            const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const isGitHubPages = window.location.hostname.includes('github.io');
            
            log(`ğŸŒ ç•¶å‰ä¸»æ©Ÿ: ${window.location.hostname}`, 'debug');
            log(`ğŸ”§ é–‹ç™¼ç’°å¢ƒ: ${isDevelopment}`, isDevelopment ? 'success' : 'warn');
            log(`â˜ï¸ GitHub Pages: ${isGitHubPages}`, 'debug');
            
            // æª¢æŸ¥ä»Šæ—¥æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            log(`ğŸ“… ä»Šæ—¥æ—¥æœŸ: ${today}`, 'info');
        }

        // æ­¥é©Ÿ 2ï¼šæª¢æŸ¥å¾Œç«¯ API
        async function testStep2() {
            log('=== æ­¥é©Ÿ 2ï¼šæª¢æŸ¥å¾Œç«¯ API ===', 'info');
            
            try {
                // æª¢æŸ¥å¾Œç«¯æ˜¯å¦å¯ç”¨
                log('ğŸ” æª¢æŸ¥å¾Œç«¯é€£æ¥...', 'debug');
                const testResponse = await fetch('http://localhost:3001/api/stock-list', { 
                    method: 'HEAD',
                    signal: AbortSignal.timeout(5000)
                });
                
                if (testResponse.ok) {
                    log('âœ… å¾Œç«¯ API å¯ç”¨', 'success');
                    
                    // æª¢æŸ¥éŸ¿æ‡‰é ­
                    const stockListDate = testResponse.headers.get('X-Stock-List-Date');
                    const isToday = testResponse.headers.get('X-Stock-List-Is-Today');
                    const today = new Date().toISOString().split('T')[0];
                    
                    log(`ğŸ“Š éŸ¿æ‡‰é ­è³‡è¨Š:`, 'info');
                    log(`  - X-Stock-List-Date: ${stockListDate}`, 'debug');
                    log(`  - X-Stock-List-Is-Today: ${isToday}`, 'debug');
                    log(`  - ä»Šæ—¥æ—¥æœŸ: ${today}`, 'debug');
                    log(`  - éœ€è¦æ›´æ–°: ${isToday !== 'true'}`, isToday === 'true' ? 'success' : 'warn');
                    
                    return { isToday: isToday === 'true', date: stockListDate };
                } else {
                    log(`âŒ å¾Œç«¯ API éŒ¯èª¤: ${testResponse.status}`, 'error');
                    return { isToday: false };
                }
            } catch (error) {
                log(`âŒ å¾Œç«¯ API é€£æ¥å¤±æ•—: ${error.message}`, 'error');
                if (error.name === 'TimeoutError') {
                    log('â° é€£æ¥è¶…æ™‚ï¼ˆ5ç§’ï¼‰', 'warn');
                }
                return { isToday: false };
            }
        }

        // æ­¥é©Ÿ 3ï¼šæ¸¬è©¦æ›´æ–° API
        async function testStep3() {
            log('=== æ­¥é©Ÿ 3ï¼šæ¸¬è©¦æ›´æ–° API ===', 'info');
            
            try {
                log('ğŸš€ èª¿ç”¨æ›´æ–° API...', 'debug');
                const updateResponse = await fetch('http://localhost:3001/api/update-stock-list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        trigger: 'debug-test',
                        timestamp: new Date().toISOString()
                    }),
                    signal: AbortSignal.timeout(30000) // 30ç§’è¶…æ™‚
                });

                if (updateResponse.ok) {
                    const result = await updateResponse.json();
                    log(`âœ… æ›´æ–°æˆåŠŸ: ${result.message}`, 'success');
                    log(`ğŸ“ æª”æ¡ˆ: ${result.filename || 'N/A'}`, 'debug');
                    log(`ğŸ“… æ—¥æœŸ: ${result.date || 'N/A'}`, 'debug');
                    
                    // ç­‰å¾… 2 ç§’å¾Œé‡æ–°æª¢æŸ¥
                    log('â³ ç­‰å¾… 2 ç§’å¾Œé‡æ–°æª¢æŸ¥...', 'debug');
                    setTimeout(async () => {
                        const checkResult = await testStep2();
                        if (checkResult.isToday) {
                            log('ğŸ‰ æ›´æ–°å¾Œé©—è­‰æˆåŠŸï¼', 'success');
                        } else {
                            log('âš ï¸ æ›´æ–°å¾Œä»éœ€è¦æ›´æ–°', 'warn');
                        }
                    }, 2000);
                    
                    return true;
                } else {
                    const errorText = await updateResponse.text();
                    log(`âŒ æ›´æ–°å¤±æ•—: ${updateResponse.status} ${updateResponse.statusText}`, 'error');
                    log(`éŒ¯èª¤è©³æƒ…: ${errorText}`, 'error');
                    return false;
                }
            } catch (error) {
                if (error.name === 'TimeoutError') {
                    log(`â° æ›´æ–°è¶…æ™‚ï¼ˆ30ç§’ï¼‰`, 'error');
                    log('ğŸ’¡ Python è…³æœ¬å¯èƒ½åŸ·è¡Œæ™‚é–“è¼ƒé•·', 'warn');
                } else {
                    log(`âŒ æ›´æ–°å¤±æ•—: ${error.message}`, 'error');
                }
                return false;
            }
        }

        // æ­¥é©Ÿ 4ï¼šå®Œæ•´æµç¨‹æ¸¬è©¦
        async function testStep4() {
            log('=== æ­¥é©Ÿ 4ï¼šå®Œæ•´æµç¨‹æ¸¬è©¦ ===', 'info');
            
            // æ¨¡æ“¬å‰ç«¯çš„å®Œæ•´é‚è¼¯
            try {
                log('ğŸ” é–‹å§‹æª¢æŸ¥è‚¡ç¥¨æ¸…å–®æ–°é®®åº¦...', 'debug');
                
                // 1. æª¢æŸ¥ç’°å¢ƒ
                const isDevelopment = window.location.hostname === 'localhost';
                log(`ğŸŒ ç’°å¢ƒæª¢æŸ¥: ${isDevelopment ? 'é–‹ç™¼ç’°å¢ƒ' : 'ç”Ÿç”¢ç’°å¢ƒ'}`, 'info');
                
                if (!isDevelopment) {
                    log('âš ï¸ éé–‹ç™¼ç’°å¢ƒï¼Œè·³éæ¸¬è©¦', 'warn');
                    return;
                }
                
                // 2. æª¢æŸ¥å¾Œç«¯ç‹€æ…‹
                log('ğŸ” æª¢æŸ¥å¾Œç«¯è‚¡ç¥¨æ¸…å–®ç‹€æ…‹...', 'debug');
                const backendStatus = await testStep2();
                
                // 3. åˆ¤æ–·æ˜¯å¦éœ€è¦æ›´æ–°
                const needsUpdate = !backendStatus.isToday;
                log(`ğŸ“Š æª¢æŸ¥çµæœ: ${needsUpdate ? 'éœ€è¦æ›´æ–°' : 'ç„¡éœ€æ›´æ–°'}`, needsUpdate ? 'warn' : 'success');
                
                if (needsUpdate) {
                    log('ğŸš€ æª¢æ¸¬åˆ°éœ€è¦æ›´æ–°ï¼Œé–‹å§‹èƒŒæ™¯è‡ªå‹•æ›´æ–°...', 'info');
                    
                    // 4. åŸ·è¡Œæ›´æ–°
                    const updateSuccess = await testStep3();
                    
                    if (updateSuccess) {
                        log('ğŸ‰ è‚¡ç¥¨æ¸…å–®å·²è‡ªå‹•æ›´æ–°å®Œæˆ', 'success');
                    } else {
                        log('âŒ èƒŒæ™¯è‡ªå‹•æ›´æ–°å¤±æ•—ï¼Œå°‡åœ¨ä¸‹æ¬¡æª¢æŸ¥æ™‚é‡è©¦', 'error');
                    }
                } else {
                    log('âœ… è‚¡ç¥¨æ¸…å–®æ˜¯æœ€æ–°çš„ï¼Œç„¡éœ€æ›´æ–°', 'success');
                }
                
            } catch (error) {
                log(`âŒ å®Œæ•´æµç¨‹æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                console.error('å®Œæ•´æµç¨‹æ¸¬è©¦éŒ¯èª¤:', error);
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œç’°å¢ƒæª¢æŸ¥
        window.onload = function() {
            log('ğŸš€ Debug Tool å·²è¼‰å…¥', 'info');
            testStep1();
        };
    </script>
</body>
</html>