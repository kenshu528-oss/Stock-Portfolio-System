<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦ 00981A ETF å¾Œç¶´ä¿®å¾©</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <h1>æ¸¬è©¦ 00981A ETF å¾Œç¶´ä¿®å¾©</h1>
    <p>æ¸¬è©¦ 00981Aï¼ˆä¸»å‹•çµ±ä¸€å°è‚¡å¢é•· ETFï¼‰æ˜¯å¦æ­£ç¢ºä½¿ç”¨ .TWO å¾Œç¶´</p>
    
    <button onclick="testETFSuffix()">æ¸¬è©¦ ETF å¾Œç¶´åˆ¤æ–·</button>
    <button onclick="testYahooAPI()">æ¸¬è©¦ Yahoo Finance API</button>
    
    <div id="results"></div>

    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        // è¤‡è£½ä¿®å¾©å¾Œçš„ getYahooSymbol é‚è¼¯
        function getYahooSymbol(symbol) {
            if (symbol.includes('.')) return symbol;

            const code = parseInt(symbol.substring(0, 4));
            const isBondETF = /^00\d{2,3}B$/i.test(symbol);
            const isETF = /^00\d{2,3}[A-Z]?$/i.test(symbol);

            // ç‰¹æ®Šæ¡ˆä¾‹è™•ç†
            const specialCases = {
                '8112': '.TW', // è‡³ä¸Šï¼šé›–åœ¨ 8000 ç¯„åœä½†éœ€ä½¿ç”¨ .TW
                '4585': '.TW', // é”æ˜ï¼šèˆˆæ«ƒè‚¡ç¥¨ï¼Œæœ€å¸¸ç”¨ .TW
            };
            
            if (specialCases[symbol]) {
                return `${symbol}${specialCases[symbol]}`;
            }

            // å‚µåˆ¸ ETFï¼šå„ªå…ˆæ«ƒè²·ä¸­å¿ƒ
            if (isBondETF) {
                return `${symbol}.TWO`;
            }
            
            // ä¸€èˆ¬ ETFï¼šå„ªå…ˆæ«ƒè²·ä¸­å¿ƒ
            if (isETF) {
                return `${symbol}.TWO`;
            }
            
            // ä¸Šæ«ƒè‚¡ç¥¨ï¼ˆ3000-8999ï¼‰ï¼šå„ªå…ˆæ«ƒè²·ä¸­å¿ƒ
            if (code >= 3000 && code <= 8999) {
                return `${symbol}.TWO`;
            }
            
            // ä¸Šå¸‚è‚¡ç¥¨ï¼ˆ1000-2999ï¼‰ï¼šå„ªå…ˆè­‰äº¤æ‰€
            return `${symbol}.TW`;
        }

        function testETFSuffix() {
            addResult('ğŸ§ª é–‹å§‹æ¸¬è©¦ ETF å¾Œç¶´åˆ¤æ–·é‚è¼¯...', 'info');
            
            const testCases = [
                { symbol: '00981A', expected: '00981A.TWO', type: 'ä¸€èˆ¬ ETF' },
                { symbol: '0050', expected: '0050.TWO', type: 'ä¸€èˆ¬ ETF' },
                { symbol: '00679B', expected: '00679B.TWO', type: 'å‚µåˆ¸ ETF' },
                { symbol: '2330', expected: '2330.TW', type: 'ä¸Šå¸‚è‚¡ç¥¨' },
                { symbol: '6188', expected: '6188.TWO', type: 'ä¸Šæ«ƒè‚¡ç¥¨' },
            ];

            testCases.forEach(testCase => {
                const result = getYahooSymbol(testCase.symbol);
                const isCorrect = result === testCase.expected;
                
                addResult(
                    `${testCase.symbol} (${testCase.type}): ${result} ${isCorrect ? 'âœ…' : 'âŒ'} (é æœŸ: ${testCase.expected})`,
                    isCorrect ? 'success' : 'error'
                );
            });
        }

        async function testYahooAPI() {
            addResult('ğŸŒ é–‹å§‹æ¸¬è©¦ Yahoo Finance API...', 'info');
            
            const symbol = '00981A';
            const yahooSymbol = getYahooSymbol(symbol);
            
            addResult(`æ¸¬è©¦ ${symbol} â†’ ${yahooSymbol}`, 'info');
            
            try {
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl);
                const data = await response.json();
                const yahooData = JSON.parse(data.contents);
                
                const result = yahooData?.chart?.result?.[0];
                if (result?.meta) {
                    const price = result.meta.regularMarketPrice || result.meta.previousClose || 0;
                    const name = result.meta.longName || result.meta.shortName || symbol;
                    
                    addResult(
                        `âœ… Yahoo Finance æˆåŠŸ: ${yahooSymbol}<br>` +
                        `è‚¡ç¥¨åç¨±: ${name}<br>` +
                        `è‚¡åƒ¹: ${price}`,
                        'success'
                    );
                } else {
                    addResult(`âŒ Yahoo Finance ç„¡æœ‰æ•ˆè³‡æ–™: ${yahooSymbol}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ Yahoo Finance API éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>