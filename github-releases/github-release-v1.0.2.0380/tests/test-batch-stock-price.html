<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡è‚¡åƒ¹æ›´æ–°æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-section h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .loading {
            color: #f39c12;
            font-weight: bold;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 5px;
        }
        .symbol-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #3498db;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š æ‰¹é‡è‚¡åƒ¹æ›´æ–°æ¸¬è©¦</h1>
        
        <!-- ç’°å¢ƒæª¢æ¸¬ -->
        <div class="test-section">
            <h3>ğŸ” ç’°å¢ƒæª¢æ¸¬</h3>
            <button onclick="detectEnvironment()">æª¢æ¸¬ç•¶å‰ç’°å¢ƒ</button>
            <div id="env-results" class="results"></div>
        </div>

        <!-- é è¨­æ¸¬è©¦è‚¡ç¥¨ -->
        <div class="test-section">
            <h3>ğŸš€ å¿«é€Ÿæ¸¬è©¦</h3>
            <button onclick="testSmallBatch()">å°æ‰¹é‡æ¸¬è©¦ (5æ”¯è‚¡ç¥¨)</button>
            <button onclick="testMediumBatch()">ä¸­æ‰¹é‡æ¸¬è©¦ (15æ”¯è‚¡ç¥¨)</button>
            <button onclick="testLargeBatch()">å¤§æ‰¹é‡æ¸¬è©¦ (30æ”¯è‚¡ç¥¨)</button>
            <div id="quick-results" class="results"></div>
        </div>

        <!-- è‡ªè¨‚è‚¡ç¥¨æ¸¬è©¦ -->
        <div class="test-section">
            <h3>âš™ï¸ è‡ªè¨‚æ¸¬è©¦</h3>
            <textarea id="custom-symbols" class="symbol-input" rows="4" 
                placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿï¼Œç”¨é€—è™Ÿæˆ–æ›è¡Œåˆ†éš”ï¼Œä¾‹å¦‚ï¼š2330,0050,2454,2881"></textarea>
            <button onclick="testCustomBatch()">æ¸¬è©¦è‡ªè¨‚è‚¡ç¥¨</button>
            <div id="custom-results" class="results"></div>
        </div>

        <!-- æ•ˆèƒ½æ¯”è¼ƒ -->
        <div class="test-section">
            <h3>âš¡ æ•ˆèƒ½æ¯”è¼ƒ</h3>
            <button onclick="comparePerformance()">åºåˆ— vs æ‰¹é‡æ•ˆèƒ½æ¯”è¼ƒ</button>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
            <div id="performance-results" class="results"></div>
        </div>

        <!-- çµ±è¨ˆè³‡è¨Š -->
        <div class="stats" id="stats-container" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="total-requests">0</div>
                <div class="stat-label">ç¸½è«‹æ±‚æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="success-rate">0%</div>
                <div class="stat-label">æˆåŠŸç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-time">0ms</div>
                <div class="stat-label">å¹³å‡è€—æ™‚</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="efficiency-gain">0%</div>
                <div class="stat-label">æ•ˆèƒ½æå‡</div>
            </div>
        </div>
    </div>

    <script>
        // æ¸¬è©¦ç”¨è‚¡ç¥¨ä»£è™Ÿ
        const TEST_SYMBOLS = {
            small: ['2330', '0050', '2454', '2881', '2886'],
            medium: ['2330', '0050', '2454', '2881', '2886', '2317', '2412', '3008', '2308', '2303', '0056', '00878', '00646', '00679B', '6505'],
            large: ['2330', '0050', '2454', '2881', '2886', '2317', '2412', '3008', '2308', '2303', '0056', '00878', '00646', '00679B', '6505', '2891', '2892', '5880', '2474', '3711', '2382', '1301', '1303', '2002', '1216', '2207', '2227', '2357', '2395', '2408']
        };

        let testStats = {
            totalRequests: 0,
            successCount: 0,
            totalTime: 0,
            batchTime: 0,
            serialTime: 0
        };

        // æª¢æ¸¬ç’°å¢ƒ
        function detectEnvironment() {
            const envResults = document.getElementById('env-results');
            envResults.innerHTML = '<span class="loading">ğŸ” æª¢æ¸¬ç’°å¢ƒä¸­...</span>';

            const hostname = window.location.hostname;
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
            const isGitHubPages = hostname.includes('github.io');
            const isNetlify = hostname.includes('netlify.app');

            let environment = 'unknown';
            let expectedService = 'unknown';

            if (isLocalhost) {
                environment = 'local';
                expectedService = 'å¾Œç«¯æ‰¹é‡ API';
            } else if (isGitHubPages) {
                environment = 'github-pages';
                expectedService = 'Vercel æ‰¹é‡æœå‹™';
            } else if (isNetlify) {
                environment = 'netlify';
                expectedService = 'Vercel æ‰¹é‡æœå‹™';
            }

            const envInfo = `
ğŸŒ ç’°å¢ƒè³‡è¨Š:
  - ä¸»æ©Ÿåç¨±: ${hostname}
  - ç’°å¢ƒé¡å‹: ${environment}
  - é æœŸæœå‹™: ${expectedService}
  - æ˜¯å¦æœ¬æ©Ÿ: ${isLocalhost ? 'æ˜¯' : 'å¦'}
  - æ˜¯å¦ GitHub Pages: ${isGitHubPages ? 'æ˜¯' : 'å¦'}
  - æ˜¯å¦ Netlify: ${isNetlify ? 'æ˜¯' : 'å¦'}

ğŸ“¡ API ç«¯é»æ¸¬è©¦:`;

            envResults.innerHTML = envInfo;

            // æ¸¬è©¦ API ç«¯é»
            if (isLocalhost) {
                testBackendAPI();
            } else {
                testVercelAPI();
            }
        }

        // æ¸¬è©¦å¾Œç«¯ API
        async function testBackendAPI() {
            const envResults = document.getElementById('env-results');
            
            try {
                const response = await fetch('/api/stocks/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols: ['2330'] })
                });

                if (response.ok) {
                    envResults.innerHTML += '\n<span class="success">âœ… å¾Œç«¯æ‰¹é‡ API å¯ç”¨</span>';
                } else {
                    envResults.innerHTML += `\n<span class="error">âŒ å¾Œç«¯æ‰¹é‡ API éŒ¯èª¤: ${response.status}</span>`;
                }
            } catch (error) {
                envResults.innerHTML += `\n<span class="error">âŒ å¾Œç«¯æ‰¹é‡ API ç„¡æ³•é€£æ¥: ${error.message}</span>`;
            }
        }

        // æ¸¬è©¦ Vercel API
        async function testVercelAPI() {
            const envResults = document.getElementById('env-results');
            
            try {
                const response = await fetch('https://vercel-stock-api.vercel.app/api/stock-price?symbol=2330');
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        envResults.innerHTML += '\n<span class="success">âœ… Vercel API å¯ç”¨</span>';
                    } else {
                        envResults.innerHTML += '\n<span class="error">âŒ Vercel API å›æ‡‰ç•°å¸¸</span>';
                    }
                } else {
                    envResults.innerHTML += `\n<span class="error">âŒ Vercel API éŒ¯èª¤: ${response.status}</span>`;
                }
            } catch (error) {
                envResults.innerHTML += `\n<span class="error">âŒ Vercel API ç„¡æ³•é€£æ¥: ${error.message}</span>`;
            }
        }

        // å°æ‰¹é‡æ¸¬è©¦
        async function testSmallBatch() {
            await runBatchTest(TEST_SYMBOLS.small, 'quick-results', 'å°æ‰¹é‡æ¸¬è©¦');
        }

        // ä¸­æ‰¹é‡æ¸¬è©¦
        async function testMediumBatch() {
            await runBatchTest(TEST_SYMBOLS.medium, 'quick-results', 'ä¸­æ‰¹é‡æ¸¬è©¦');
        }

        // å¤§æ‰¹é‡æ¸¬è©¦
        async function testLargeBatch() {
            await runBatchTest(TEST_SYMBOLS.large, 'quick-results', 'å¤§æ‰¹é‡æ¸¬è©¦');
        }

        // è‡ªè¨‚æ‰¹é‡æ¸¬è©¦
        async function testCustomBatch() {
            const input = document.getElementById('custom-symbols').value;
            if (!input.trim()) {
                alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ');
                return;
            }

            const symbols = input.split(/[,\n]/).map(s => s.trim()).filter(s => s);
            await runBatchTest(symbols, 'custom-results', 'è‡ªè¨‚æ¸¬è©¦');
        }

        // åŸ·è¡Œæ‰¹é‡æ¸¬è©¦
        async function runBatchTest(symbols, resultElementId, testName) {
            const resultsElement = document.getElementById(resultElementId);
            resultsElement.innerHTML = `<span class="loading">ğŸš€ ${testName} é€²è¡Œä¸­... (${symbols.length} æ”¯è‚¡ç¥¨)</span>`;

            const startTime = Date.now();

            try {
                let results;
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

                if (isLocalhost) {
                    // æœ¬æ©Ÿç«¯ï¼šä½¿ç”¨å¾Œç«¯æ‰¹é‡ API
                    const response = await fetch('/api/stocks/batch', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbols })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    results = await response.json();
                } else {
                    // é›²ç«¯ç’°å¢ƒï¼šæ¨¡æ“¬ Vercel æ‰¹é‡èª¿ç”¨
                    results = await simulateVercelBatch(symbols);
                }

                const endTime = Date.now();
                const duration = endTime - startTime;

                // çµ±è¨ˆçµæœ
                const successCount = results.filter(r => r.price > 0).length;
                const failCount = symbols.length - successCount;
                const successRate = Math.round((successCount / symbols.length) * 100);

                // æ›´æ–°çµ±è¨ˆ
                testStats.totalRequests += symbols.length;
                testStats.successCount += successCount;
                testStats.totalTime += duration;

                // é¡¯ç¤ºçµæœ
                let resultText = `
<span class="success">âœ… ${testName} å®Œæˆ</span>

ğŸ“Š æ¸¬è©¦çµæœ:
  - è‚¡ç¥¨æ•¸é‡: ${symbols.length}
  - æˆåŠŸæ•¸é‡: ${successCount}
  - å¤±æ•—æ•¸é‡: ${failCount}
  - æˆåŠŸç‡: ${successRate}%
  - ç¸½è€—æ™‚: ${duration}ms
  - å¹³å‡è€—æ™‚: ${Math.round(duration / symbols.length)}ms/è‚¡

ğŸ“ˆ æˆåŠŸè‚¡ç¥¨:`;

                results.filter(r => r.price > 0).forEach(stock => {
                    resultText += `\n  ${stock.symbol}: $${stock.price} (${stock.source || 'Unknown'})`;
                });

                if (failCount > 0) {
                    resultText += '\n\nâŒ å¤±æ•—è‚¡ç¥¨:';
                    results.filter(r => r.price <= 0).forEach(stock => {
                        resultText += `\n  ${stock.symbol}: ${stock.error || 'No data'}`;
                    });
                }

                resultsElement.innerHTML = resultText;
                updateStats();

            } catch (error) {
                resultsElement.innerHTML = `<span class="error">âŒ ${testName} å¤±æ•—: ${error.message}</span>`;
            }
        }

        // æ¨¡æ“¬ Vercel æ‰¹é‡èª¿ç”¨
        async function simulateVercelBatch(symbols) {
            const results = [];
            const BATCH_SIZE = 8;

            for (let i = 0; i < symbols.length; i += BATCH_SIZE) {
                const batch = symbols.slice(i, i + BATCH_SIZE);
                const promises = batch.map(async (symbol) => {
                    try {
                        const response = await fetch(`https://vercel-stock-api.vercel.app/api/stock-price?symbol=${symbol}`);
                        if (response.ok) {
                            const data = await response.json();
                            return {
                                symbol,
                                price: data.price || 0,
                                change: data.change || 0,
                                changePercent: data.changePercent || 0,
                                source: data.source || 'Vercel'
                            };
                        } else {
                            return { symbol, price: 0, error: `HTTP ${response.status}` };
                        }
                    } catch (error) {
                        return { symbol, price: 0, error: error.message };
                    }
                });

                const batchResults = await Promise.allSettled(promises);
                batchResults.forEach((result, index) => {
                    if (result.status === 'fulfilled') {
                        results.push(result.value);
                    } else {
                        results.push({ symbol: batch[index], price: 0, error: 'Promise rejected' });
                    }
                });

                // æ‰¹æ¬¡é–“å»¶é²
                if (i + BATCH_SIZE < symbols.length) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }

            return results;
        }

        // æ•ˆèƒ½æ¯”è¼ƒæ¸¬è©¦
        async function comparePerformance() {
            const resultsElement = document.getElementById('performance-results');
            const progressFill = document.getElementById('progress-fill');
            
            resultsElement.innerHTML = '<span class="loading">âš¡ æ•ˆèƒ½æ¯”è¼ƒæ¸¬è©¦é€²è¡Œä¸­...</span>';
            
            const testSymbols = TEST_SYMBOLS.medium; // ä½¿ç”¨ä¸­ç­‰æ‰¹é‡
            let progress = 0;

            // æ›´æ–°é€²åº¦
            function updateProgress(current, total, phase) {
                progress = (current / total) * 50 + (phase === 'batch' ? 50 : 0);
                progressFill.style.width = `${progress}%`;
            }

            try {
                // æ¸¬è©¦åºåˆ—è™•ç†
                resultsElement.innerHTML = '<span class="loading">âš¡ æ¸¬è©¦åºåˆ—è™•ç†...</span>';
                const serialStart = Date.now();
                let serialSuccess = 0;

                for (let i = 0; i < testSymbols.length; i++) {
                    try {
                        const response = await fetch(`https://vercel-stock-api.vercel.app/api/stock-price?symbol=${testSymbols[i]}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.price > 0) serialSuccess++;
                        }
                        await new Promise(resolve => setTimeout(resolve, 500)); // æ¨¡æ“¬åŸæœ‰å»¶é²
                    } catch (error) {
                        // å¿½ç•¥éŒ¯èª¤ï¼Œç¹¼çºŒæ¸¬è©¦
                    }
                    updateProgress(i + 1, testSymbols.length, 'serial');
                }

                const serialTime = Date.now() - serialStart;
                testStats.serialTime = serialTime;

                // æ¸¬è©¦æ‰¹é‡è™•ç†
                resultsElement.innerHTML = '<span class="loading">âš¡ æ¸¬è©¦æ‰¹é‡è™•ç†...</span>';
                const batchStart = Date.now();
                const batchResults = await simulateVercelBatch(testSymbols);
                const batchTime = Date.now() - batchStart;
                const batchSuccess = batchResults.filter(r => r.price > 0).length;
                testStats.batchTime = batchTime;

                updateProgress(testSymbols.length, testSymbols.length, 'batch');

                // è¨ˆç®—æ•ˆèƒ½æå‡
                const timeSaved = serialTime - batchTime;
                const efficiencyGain = Math.round((timeSaved / serialTime) * 100);

                const comparisonResult = `
<span class="success">âš¡ æ•ˆèƒ½æ¯”è¼ƒå®Œæˆ</span>

ğŸ“Š æ¸¬è©¦çµæœ (${testSymbols.length} æ”¯è‚¡ç¥¨):

ğŸŒ åºåˆ—è™•ç†:
  - ç¸½è€—æ™‚: ${serialTime}ms
  - æˆåŠŸæ•¸: ${serialSuccess}
  - å¹³å‡è€—æ™‚: ${Math.round(serialTime / testSymbols.length)}ms/è‚¡

ğŸš€ æ‰¹é‡è™•ç†:
  - ç¸½è€—æ™‚: ${batchTime}ms
  - æˆåŠŸæ•¸: ${batchSuccess}
  - å¹³å‡è€—æ™‚: ${Math.round(batchTime / testSymbols.length)}ms/è‚¡

ğŸ“ˆ æ•ˆèƒ½æå‡:
  - æ™‚é–“ç¯€çœ: ${timeSaved}ms
  - æ•ˆèƒ½æå‡: ${efficiencyGain}%
  - é€Ÿåº¦å€æ•¸: ${(serialTime / batchTime).toFixed(1)}x

${efficiencyGain > 50 ? 'ğŸ‰ æ‰¹é‡è™•ç†æ•ˆèƒ½é¡¯è‘—æå‡ï¼' : 'âš ï¸ æ•ˆèƒ½æå‡æœ‰é™ï¼Œå¯èƒ½éœ€è¦å„ªåŒ–'}`;

                resultsElement.innerHTML = comparisonResult;
                updateStats();

            } catch (error) {
                resultsElement.innerHTML = `<span class="error">âŒ æ•ˆèƒ½æ¯”è¼ƒå¤±æ•—: ${error.message}</span>`;
            }
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats() {
            const statsContainer = document.getElementById('stats-container');
            statsContainer.style.display = 'grid';

            document.getElementById('total-requests').textContent = testStats.totalRequests;
            
            const successRate = testStats.totalRequests > 0 ? 
                Math.round((testStats.successCount / testStats.totalRequests) * 100) : 0;
            document.getElementById('success-rate').textContent = `${successRate}%`;
            
            const avgTime = testStats.totalRequests > 0 ? 
                Math.round(testStats.totalTime / testStats.totalRequests) : 0;
            document.getElementById('avg-time').textContent = `${avgTime}ms`;
            
            const efficiencyGain = testStats.serialTime > 0 && testStats.batchTime > 0 ? 
                Math.round(((testStats.serialTime - testStats.batchTime) / testStats.serialTime) * 100) : 0;
            document.getElementById('efficiency-gain').textContent = `${efficiencyGain}%`;
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æ¸¬ç’°å¢ƒ
        window.addEventListener('load', () => {
            detectEnvironment();
        });
    </script>
</body>
</html>