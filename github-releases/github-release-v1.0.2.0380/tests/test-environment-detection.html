<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç’°å¢ƒæª¢æ¸¬æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>ç’°å¢ƒæª¢æ¸¬æ¸¬è©¦</h1>
    <p>æª¢æ¸¬ç•¶å‰ç’°å¢ƒä¸¦ç¢ºèªè‚¡åƒ¹æœå‹™é¸æ“‡é‚è¼¯</p>
    
    <button onclick="detectEnvironment()">æª¢æ¸¬ç’°å¢ƒ</button>
    <button onclick="testStockPriceService()">æ¸¬è©¦è‚¡åƒ¹æœå‹™é¸æ“‡</button>
    
    <div id="results"></div>

    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        // è¤‡è£½ç’°å¢ƒæª¢æ¸¬é‚è¼¯
        function shouldUseBackendProxy() {
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' ||
                               window.location.hostname === '0.0.0.0';
            return isLocalhost;
        }

        function getEnvironmentInfo() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            const port = window.location.port;
            const isLocalhost = hostname === 'localhost' || 
                               hostname === '127.0.0.1' || 
                               hostname === '0.0.0.0';
            const isGitHubPages = hostname.includes('github.io');
            const isNetlify = hostname.includes('netlify.app');
            
            return {
                hostname,
                protocol,
                port,
                fullUrl: window.location.href,
                isLocalhost,
                isGitHubPages,
                isNetlify,
                environment: isLocalhost ? 'local' : 
                            isGitHubPages ? 'github-pages' : 
                            isNetlify ? 'netlify' : 'unknown',
                useBackendProxy: shouldUseBackendProxy(),
                stockPriceService: shouldUseBackendProxy() ? 'StockPriceService (å¾Œç«¯ä»£ç†)' : 'cloudStockPriceService (é›²ç«¯å¤šé‡ä»£ç†)'
            };
        }

        function detectEnvironment() {
            addResult('ğŸ” é–‹å§‹ç’°å¢ƒæª¢æ¸¬...', 'info');
            
            const envInfo = getEnvironmentInfo();
            
            let tableHTML = `
                <table>
                    <tr><th>é …ç›®</th><th>å€¼</th><th>èªªæ˜</th></tr>
                    <tr><td>ä¸»æ©Ÿåç¨±</td><td><strong>${envInfo.hostname}</strong></td><td>ç”¨æ–¼ç’°å¢ƒåˆ¤æ–·çš„é—œéµ</td></tr>
                    <tr><td>å”è­°</td><td>${envInfo.protocol}</td><td>HTTP/HTTPS</td></tr>
                    <tr><td>ç«¯å£</td><td>${envInfo.port || 'é è¨­'}</td><td>é–‹ç™¼ç’°å¢ƒé€šå¸¸æ˜¯ 5173</td></tr>
                    <tr><td>å®Œæ•´ URL</td><td>${envInfo.fullUrl}</td><td>ç•¶å‰é é¢åœ°å€</td></tr>
                    <tr><td>æ˜¯å¦æœ¬æ©Ÿç«¯</td><td><strong>${envInfo.isLocalhost ? 'æ˜¯' : 'å¦'}</strong></td><td>localhost, 127.0.0.1, 0.0.0.0</td></tr>
                    <tr><td>æ˜¯å¦ GitHub Pages</td><td>${envInfo.isGitHubPages ? 'æ˜¯' : 'å¦'}</td><td>*.github.io</td></tr>
                    <tr><td>æ˜¯å¦ Netlify</td><td>${envInfo.isNetlify ? 'æ˜¯' : 'å¦'}</td><td>*.netlify.app</td></tr>
                    <tr><td>ç’°å¢ƒé¡å‹</td><td><strong>${envInfo.environment}</strong></td><td>ç’°å¢ƒåˆ†é¡</td></tr>
                    <tr><td>ä½¿ç”¨å¾Œç«¯ä»£ç†</td><td><strong>${envInfo.useBackendProxy ? 'æ˜¯' : 'å¦'}</strong></td><td>è‚¡åƒ¹æœå‹™é¸æ“‡ä¾æ“š</td></tr>
                    <tr><td>è‚¡åƒ¹æœå‹™</td><td><strong>${envInfo.stockPriceService}</strong></td><td>å¯¦éš›ä½¿ç”¨çš„æœå‹™</td></tr>
                </table>
            `;
            
            const resultType = envInfo.isLocalhost ? 'success' : 'warning';
            const environmentDesc = envInfo.isLocalhost ? 
                'âœ… æœ¬æ©Ÿç«¯ç’°å¢ƒï¼šä½¿ç”¨å¾Œç«¯ä»£ç†æœå‹™ï¼Œç©©å®šå¯é ' : 
                'âš ï¸ é›²ç«¯ç’°å¢ƒï¼šä½¿ç”¨å¤šé‡ä»£ç†æœå‹™ï¼Œéœ€è¦ç¶²è·¯é€£ç·š';
            
            addResult(`ğŸ“Š ç’°å¢ƒæª¢æ¸¬çµæœï¼š${environmentDesc}${tableHTML}`, resultType);
        }

        function testStockPriceService() {
            addResult('ğŸ§ª æ¸¬è©¦è‚¡åƒ¹æœå‹™é¸æ“‡é‚è¼¯...', 'info');
            
            const envInfo = getEnvironmentInfo();
            
            let testResults = [];
            
            // æ¸¬è©¦é‚è¼¯
            if (envInfo.useBackendProxy) {
                testResults.push({
                    scenario: 'å³ä¸Šè§’æ›´æ–°',
                    logic: 'shouldUseBackendProxy() â†’ true',
                    service: 'StockPriceService',
                    endpoint: 'http://localhost:3001/api/stock/{symbol}',
                    status: 'âœ… æ‡‰è©²æˆåŠŸ'
                });
                
                testResults.push({
                    scenario: 'å€‹è‚¡æ›´æ–°',
                    logic: 'shouldUseBackendProxy() â†’ true',
                    service: 'StockPriceService',
                    endpoint: 'http://localhost:3001/api/stock/{symbol}',
                    status: 'âœ… æ‡‰è©²æˆåŠŸï¼ˆv1.0.2.0353 ä¿®å¾©å¾Œï¼‰'
                });
            } else {
                testResults.push({
                    scenario: 'å³ä¸Šè§’æ›´æ–°',
                    logic: 'shouldUseBackendProxy() â†’ false',
                    service: 'cloudStockPriceService',
                    endpoint: 'å¤šé‡ä»£ç†æœå‹™ (AllOrigins, CodeTabs, ThingProxy)',
                    status: 'âš ï¸ ä¾è³´ä»£ç†æœå‹™ç©©å®šæ€§'
                });
                
                testResults.push({
                    scenario: 'å€‹è‚¡æ›´æ–°',
                    logic: 'shouldUseBackendProxy() â†’ false',
                    service: 'cloudStockPriceService',
                    endpoint: 'å¤šé‡ä»£ç†æœå‹™ (AllOrigins, CodeTabs, ThingProxy)',
                    status: 'âš ï¸ ä¾è³´ä»£ç†æœå‹™ç©©å®šæ€§'
                });
            }
            
            let testTableHTML = `
                <table>
                    <tr><th>æ›´æ–°æ–¹å¼</th><th>é‚è¼¯åˆ¤æ–·</th><th>ä½¿ç”¨æœå‹™</th><th>API ç«¯é»</th><th>é æœŸç‹€æ…‹</th></tr>
            `;
            
            testResults.forEach(test => {
                testTableHTML += `
                    <tr>
                        <td>${test.scenario}</td>
                        <td>${test.logic}</td>
                        <td><strong>${test.service}</strong></td>
                        <td>${test.endpoint}</td>
                        <td>${test.status}</td>
                    </tr>
                `;
            });
            
            testTableHTML += '</table>';
            
            const consistency = testResults[0].service === testResults[1].service ? 
                'âœ… å…©å€‹æ›´æ–°å…¥å£ä½¿ç”¨ç›¸åŒæœå‹™ï¼Œé‚è¼¯ä¸€è‡´' : 
                'âŒ å…©å€‹æ›´æ–°å…¥å£ä½¿ç”¨ä¸åŒæœå‹™ï¼Œé‚è¼¯ä¸ä¸€è‡´';
            
            addResult(`ğŸ”§ è‚¡åƒ¹æœå‹™é¸æ“‡æ¸¬è©¦ï¼š${consistency}${testTableHTML}`, 'info');
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æ¸¬
        window.onload = function() {
            detectEnvironment();
        };
    </script>
</body>
</html>