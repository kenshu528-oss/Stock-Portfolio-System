<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TWSE API ç¨ç«‹æ¸¬è©¦ - v1.0.2.0329</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
        }
        .test-result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 5px; 
            font-family: monospace;
        }
        .success { 
            background-color: #155724; 
            border: 1px solid #c3e6cb; 
            color: #d4edda;
        }
        .error { 
            background-color: #721c24; 
            border: 1px solid #f5c6cb; 
            color: #f8d7da;
        }
        .info { 
            background-color: #0c5460; 
            border: 1px solid #bee5eb; 
            color: #d1ecf1;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #results { 
            margin-top: 20px; 
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TWSE API ç¨ç«‹æ¸¬è©¦ - v1.0.2.0329</h1>
        <p>å®Œæ•´å¯¦ä½œæˆåŠŸå€‰åº« v1.2.2.0035 çš„å¤šé‡ TWSE API æ©Ÿåˆ¶</p>
        
        <div>
            <button onclick="testTWSEAPI('2330')">æ¸¬è©¦ 2330 (å°ç©é›»)</button>
            <button onclick="testTWSEAPI('00940')">æ¸¬è©¦ 00940 (å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯)</button>
            <button onclick="testTWSEAPI('4585')">æ¸¬è©¦ 4585 (é”æ˜)</button>
            <button onclick="testTWSEAPI('6188')">æ¸¬è©¦ 6188 (å»£æ˜)</button>
            <button onclick="testAllAPIs('2330')">æ¸¬è©¦æ‰€æœ‰ API (2330)</button>
            <button onclick="clearResults()">æ¸…é™¤çµæœ</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        // å®Œæ•´å¯¦ä½œ TWSE API æ©Ÿåˆ¶ - åŸºæ–¼æˆåŠŸå€‰åº« v1.2.2.0035
        class TWSEStockAPI {
            constructor() {
                this.apiSources = [
                    {
                        name: 'TWSE (å°ç£è­‰äº¤æ‰€)',
                        method: this.fetchFromTWSE.bind(this),
                        priority: 1  // æœ€é«˜å„ªå…ˆç´š
                    },
                    {
                        name: 'Yahoo Finance (AllOrigins)',
                        method: this.fetchFromYahooAllOrigins.bind(this),
                        priority: 2
                    },
                    {
                        name: 'Static Price (Fallback)',
                        method: this.fetchStaticPrice.bind(this),
                        priority: 3
                    }
                ];
            }

            // ä¸»è¦æŸ¥è©¢æ–¹æ³•
            async getStockPrice(stockCode) {
                const sortedSources = this.apiSources.sort((a, b) => a.priority - b.priority);
                
                for (const source of sortedSources) {
                    try {
                        addResult(`ğŸ” å˜—è©¦å¾ ${source.name} ç²å– ${stockCode} è‚¡åƒ¹...`, 'info');
                        const result = await source.method(stockCode);
                        
                        if (result && result.price > 0) {
                            addResult(`âœ… ${source.name} æˆåŠŸç²å– ${stockCode}: $${result.price}`, 'success');
                            return {
                                price: result.price,
                                source: source.name,
                                timestamp: new Date(),
                                ...result
                            };
                        }
                    } catch (error) {
                        addResult(`âŒ ${source.name} å¤±æ•—: ${error.message}`, 'error');
                        continue;
                    }
                }
                
                throw new Error(`æ‰€æœ‰ API ä¾†æºéƒ½ç„¡æ³•ç²å– ${stockCode} çš„è‚¡åƒ¹`);
            }

            // è‚¡ç¥¨é¡å‹åˆ¤æ–·
            getStockType(stockCode) {
                if (stockCode.match(/^00\d+/)) return 'etf'; // ETF
                if (stockCode.match(/^[1-2]\d{3}$/)) return 'listed'; // ä¸Šå¸‚è‚¡ç¥¨
                if (stockCode.match(/^[3-8]\d{3}$/)) return 'otc'; // ä¸Šæ«ƒè‚¡ç¥¨
                return 'unknown';
            }

            // TWSE API ä¸»æ–¹æ³•
            async fetchFromTWSE(stockCode) {
                const stockType = this.getStockType(stockCode);
                addResult(`ğŸ“Š è­‰äº¤æ‰€APIæŸ¥è©¢: ${stockCode}`, 'info');
                addResult(`ğŸ“‹ è‚¡ç¥¨é¡å‹: ${stockType}`, 'info');
                
                switch (stockType) {
                    case 'listed':
                        return await this.fetchFromTWSEListed(stockCode);
                    case 'otc':
                        return await this.fetchFromTPEx(stockCode);
                    case 'etf':
                        // ETF å…ˆå˜—è©¦ä¸Šå¸‚ï¼Œå†å˜—è©¦ä¸Šæ«ƒ
                        try {
                            return await this.fetchFromTWSEListed(stockCode);
                        } catch (error) {
                            return await this.fetchFromTPEx(stockCode);
                        }
                    default:
                        return await this.fetchFromAllTWSE(stockCode);
                }
            }

            // ä¸Šå¸‚è‚¡ç¥¨ API
            async fetchFromTWSEListed(stockCode) {
                const today = new Date();
                const dateStr = today.getFullYear() + 
                               String(today.getMonth() + 1).padStart(2, '0') + 
                               String(today.getDate()).padStart(2, '0');
                
                const twseUrl = `https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=${dateStr}&stockNo=${stockCode}`;
                
                const response = await this.fetchWithTimeout(twseUrl, { timeout: 5000 });
                
                if (!response.ok) {
                    throw new Error(`TWSE API éŒ¯èª¤: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.stat !== 'OK' || !data.data || data.data.length === 0) {
                    throw new Error('TWSE ç„¡è³‡æ–™æˆ–è‚¡ç¥¨ä»£ç¢¼éŒ¯èª¤');
                }
                
                const latestData = data.data[data.data.length - 1];
                const closePrice = parseFloat(latestData[6].replace(/,/g, ''));
                
                if (isNaN(closePrice) || closePrice <= 0) {
                    throw new Error('ç„¡æ•ˆçš„åƒ¹æ ¼è³‡æ–™');
                }
                
                return {
                    price: closePrice,
                    market: 'TWSE'
                };
            }

            // ä¸Šæ«ƒè‚¡ç¥¨ API
            async fetchFromTPEx(stockCode) {
                const today = new Date();
                const dateStr = today.getFullYear() + '/' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '/' + 
                               String(today.getDate()).padStart(2, '0');
                
                const tpexUrl = `https://www.tpex.org.tw/web/stock/aftertrading/daily_close_quotes/stk_quote_result.php?l=zh-tw&d=${dateStr}&stkno=${stockCode}`;
                
                const response = await this.fetchWithTimeout(tpexUrl, { timeout: 10000 });
                
                if (!response.ok) {
                    throw new Error(`TPEx API éŒ¯èª¤: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.aaData || data.aaData.length === 0) {
                    throw new Error('TPEx ç„¡è³‡æ–™æˆ–è‚¡ç¥¨ä»£ç¢¼éŒ¯èª¤');
                }
                
                const stockData = data.aaData[0];
                const closePrice = parseFloat(stockData[2]);
                
                if (isNaN(closePrice) || closePrice <= 0) {
                    throw new Error('ç„¡æ•ˆçš„åƒ¹æ ¼è³‡æ–™');
                }
                
                return {
                    price: closePrice,
                    market: 'TPEx'
                };
            }

            // å˜—è©¦æ‰€æœ‰è­‰äº¤æ‰€ API
            async fetchFromAllTWSE(stockCode) {
                const apis = [
                    { name: 'ä¸Šå¸‚', method: this.fetchFromTWSEListed.bind(this) },
                    { name: 'ä¸Šæ«ƒ', method: this.fetchFromTPEx.bind(this) }
                ];
                
                for (const api of apis) {
                    try {
                        addResult(`ğŸ”„ å˜—è©¦${api.name}API: ${stockCode}`, 'info');
                        const result = await api.method(stockCode);
                        if (result && result.price > 0) {
                            addResult(`âœ… ${api.name}APIæˆåŠŸ: ${stockCode} - åƒ¹æ ¼: ${result.price}`, 'success');
                            return result;
                        }
                    } catch (error) {
                        addResult(`âŒ ${api.name}APIå¤±æ•—: ${stockCode}`, 'error');
                        continue;
                    }
                }
                
                throw new Error('æ‰€æœ‰è­‰äº¤æ‰€APIéƒ½ç„¡æ³•æ‰¾åˆ°æ­¤è‚¡ç¥¨');
            }

            // Yahoo Finance å‚™æ´
            async fetchFromYahooAllOrigins(stockCode) {
                const symbol = `${stockCode}.TW`;
                const corsProxy = 'https://api.allorigins.win/raw?url=';
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
                
                const response = await this.fetchWithTimeout(corsProxy + encodeURIComponent(yahooUrl), { timeout: 5000 });
                
                if (!response.ok) {
                    throw new Error(`Yahoo API éŒ¯èª¤: ${response.status}`);
                }
                
                const data = await response.json();
                const result = data.chart?.result?.[0];
                
                if (!result) {
                    throw new Error('Yahoo ç„¡æ•ˆå›æ‡‰');
                }
                
                const meta = result.meta;
                const price = meta.regularMarketPrice || meta.previousClose;
                
                if (!price || price <= 0) {
                    throw new Error('Yahoo ç„¡æœ‰æ•ˆåƒ¹æ ¼');
                }
                
                return {
                    price: price,
                    market: 'Yahoo'
                };
            }

            // éœæ…‹åƒ¹æ ¼å‚™æ´
            async fetchStaticPrice(stockCode) {
                const staticPrices = {
                    '2330': 1760,  // å°ç©é›»
                    '2317': 120,   // é´»æµ·
                    '2454': 1200,  // è¯ç™¼ç§‘
                    '2886': 40,    // å…†è±é‡‘
                    '0050': 170,   // å…ƒå¤§å°ç£50
                    '00940': 9.79, // å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯
                    '6188': 110,   // å»£æ˜
                    '4585': 340,   // é”æ˜
                };

                const price = staticPrices[stockCode];
                if (price) {
                    return {
                        price: price,
                        market: 'Static'
                    };
                }

                throw new Error('ç„¡éœæ…‹åƒ¹æ ¼è³‡æ–™');
            }

            // å¸¶é€¾æ™‚çš„ fetch
            async fetchWithTimeout(url, options = {}) {
                const { timeout = 5000, ...fetchOptions } = options;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                try {
                    const response = await fetch(url, {
                        ...fetchOptions,
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('è«‹æ±‚è¶…æ™‚');
                    }
                    throw error;
                }
            }
        }

        // å»ºç«‹å…¨åŸŸå¯¦ä¾‹
        const stockAPI = new TWSEStockAPI();

        // æ¸¬è©¦å‡½æ•¸
        window.testTWSEAPI = async function(symbol) {
            const startTime = Date.now();
            
            addResult(`ğŸ” é–‹å§‹æ¸¬è©¦ ${symbol}...`, 'info');
            
            try {
                const result = await stockAPI.getStockPrice(symbol);
                const duration = Date.now() - startTime;
                
                if (result) {
                    addResult(`âœ… ${symbol} è‚¡åƒ¹ç²å–æˆåŠŸ`, 'success');
                    addResult(`ğŸ’° åƒ¹æ ¼: $${result.price}`, 'success');
                    addResult(`ğŸ“Š ä¾†æº: ${result.source}`, 'success');
                    addResult(`â±ï¸ è€—æ™‚: ${duration}ms`, 'success');
                    addResult(`ğŸ• æ™‚é–“æˆ³: ${result.timestamp.toLocaleString()}`, 'success');
                } else {
                    addResult(`âŒ ${symbol} ç²å–å¤±æ•—: ç„¡è³‡æ–™`, 'error');
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                addResult(`âŒ ${symbol} ç²å–å¤±æ•—: ${error.message} | è€—æ™‚: ${duration}ms`, 'error');
            }
        };
        
        window.testAllAPIs = async function(symbol) {
            addResult(`ğŸ” æ¸¬è©¦æ‰€æœ‰ API ä¾†æº (${symbol})...`, 'info');
            
            // æ¸¬è©¦ TWSE API
            try {
                const response = await fetch(`https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=20260126&stockNo=${symbol}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.stat === 'OK' && data.data && data.data.length > 0) {
                        const price = parseFloat(data.data[data.data.length - 1][6].replace(/,/g, ''));
                        addResult(`âœ… TWSE API ç›´æ¥æ¸¬è©¦æˆåŠŸ: $${price}`, 'success');
                    } else {
                        addResult(`âš ï¸ TWSE API å›æ‡‰æ ¼å¼ç•°å¸¸`, 'error');
                    }
                } else {
                    addResult(`âŒ TWSE API HTTP éŒ¯èª¤: ${response.status}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ TWSE API å¤±æ•—: ${error.message}`, 'error');
            }
            
            // æ¸¬è©¦ Yahoo Finance (AllOrigins)
            try {
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}.TW`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(yahooUrl)}`;
                const response = await fetch(proxyUrl);
                if (response.ok) {
                    const data = await response.json();
                    if (data?.chart?.result?.[0]?.meta?.regularMarketPrice) {
                        addResult(`âœ… Yahoo Finance (AllOrigins) æ¸¬è©¦æˆåŠŸ: $${data.chart.result[0].meta.regularMarketPrice}`, 'success');
                    } else {
                        addResult(`âš ï¸ Yahoo Finance å›æ‡‰æ ¼å¼ç•°å¸¸`, 'error');
                    }
                } else {
                    addResult(`âŒ Yahoo Finance (AllOrigins) HTTP éŒ¯èª¤: ${response.status}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ Yahoo Finance (AllOrigins) å¤±æ•—: ${error.message}`, 'error');
            }
        };
        
        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        };
        
        function addResult(message, type) {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsDiv.appendChild(div);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºç‰ˆæœ¬è³‡è¨Š
        addResult('ğŸš€ TWSE API ç¨ç«‹æ¸¬è©¦é é¢å·²è¼‰å…¥ - v1.0.2.0329', 'info');
        addResult('ğŸ“‹ å®Œæ•´å¯¦ä½œæˆåŠŸå€‰åº« v1.2.2.0035 çš„å¤šé‡ TWSE API æ©Ÿåˆ¶', 'info');
        addResult('ğŸ¯ æ¸¬è©¦ç›®æ¨™ï¼šé©—è­‰ TWSE API ç„¡ CORS å•é¡Œï¼Œæ™ºèƒ½è‚¡ç¥¨é¡å‹åˆ¤æ–·', 'info');
    </script>
</body>
</html>